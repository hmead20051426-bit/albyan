<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ø§Ù„Ø¨Ø±Ù†Ø§Ù…Ø¬ Ø§Ù„ØªÙ†Ø´ÙŠØ·ÙŠ</title>
    <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;500;700;900&display=swap" rel="stylesheet">
    <style>
        /* ========== RESET & BASE ========== */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Tajawal', sans-serif;
            min-height: 100vh;
            direction: rtl;
            color: #fff;
            overflow-x: hidden;
            transition: background 0.5s ease;
        }
        
        /* ========== THEME: CLASSIC ========== */
        .theme-classic {
            background: linear-gradient(135deg, #0A1628, #16213e);
        }
        .theme-classic .card {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 20px;
        }
        .theme-classic .btn-primary {
            background: linear-gradient(135deg, #D4AF37, #B8941F);
            color: #0A1628;
        }
        .theme-classic .header {
            background: rgba(255, 255, 255, 0.05);
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }
        .theme-classic .poetry-line { color: #D4AF37; }

        /* ========== THEME: MODERN ========== */
        .theme-modern {
            background: linear-gradient(160deg, #0f0c29, #302b63, #24243e);
        }
        .theme-modern .card {
            background: rgba(255, 255, 255, 0.04);
            backdrop-filter: blur(16px);
            border: 1px solid rgba(90, 158, 158, 0.25);
            border-radius: 16px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.2);
        }
        .theme-modern .btn-primary {
            background: linear-gradient(135deg, #5A9E9E, #3d7a7a);
            color: #fff;
            border-radius: 8px;
        }
        .theme-modern .header {
            background: rgba(0, 0, 0, 0.3);
            backdrop-filter: blur(16px);
            border-bottom: 1px solid rgba(90, 158, 158, 0.2);
        }
        .theme-modern .poetry-line { color: #5A9E9E; }
        .theme-modern .card-highlight {
            background: rgba(90, 158, 158, 0.1);
            border-color: rgba(90, 158, 158, 0.3);
        }
        .theme-modern .progress-fill {
            background: linear-gradient(90deg, #5A9E9E, #7ec8c8);
        }

        /* ========== THEME: MAJESTIC ========== */
        .theme-majestic {
            background: linear-gradient(135deg, #1a0a2e, #16213e, #0d1b2a);
        }
        .theme-majestic .card {
            background: rgba(155, 126, 94, 0.08);
            border: 2px solid rgba(155, 126, 94, 0.3);
            border-radius: 24px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3), inset 0 1px 0 rgba(155, 126, 94, 0.15);
        }
        .theme-majestic .btn-primary {
            background: linear-gradient(135deg, #9b7e5e, #7a6348);
            color: #fff;
            border: 1px solid rgba(155, 126, 94, 0.4);
            border-radius: 12px;
        }
        .theme-majestic .header {
            background: rgba(26, 10, 46, 0.8);
            border-bottom: 2px solid rgba(155, 126, 94, 0.3);
        }
        .theme-majestic .poetry-line { color: #c4a67a; }
        .theme-majestic .card-highlight {
            background: rgba(155, 126, 94, 0.12);
            border-color: rgba(155, 126, 94, 0.4);
        }
        .theme-majestic .progress-fill {
            background: linear-gradient(90deg, #9b7e5e, #c4a67a);
        }

        /* ========== THEME: GOLDEN ========== */
        .theme-golden {
            background: linear-gradient(135deg, #1a1207, #2c1f0e, #3d2b10);
        }
        .theme-golden .card {
            background: linear-gradient(145deg, rgba(212, 175, 55, 0.06), rgba(184, 148, 31, 0.02));
            border: 1px solid rgba(212, 175, 55, 0.35);
            border-radius: 20px;
            box-shadow: 0 0 25px rgba(212, 175, 55, 0.05);
        }
        .theme-golden .btn-primary {
            background: linear-gradient(135deg, #d4af37, #f5d060, #d4af37);
            color: #1a1207;
            font-weight: 700;
            border-radius: 10px;
            box-shadow: 0 4px 15px rgba(212, 175, 55, 0.3);
        }
        .theme-golden .header {
            background: rgba(44, 31, 14, 0.9);
            border-bottom: 1px solid rgba(212, 175, 55, 0.25);
            box-shadow: 0 2px 15px rgba(212, 175, 55, 0.1);
        }
        .theme-golden .poetry-line { color: #f5d060; }
        .theme-golden .card-highlight {
            background: rgba(212, 175, 55, 0.1);
            border-color: rgba(212, 175, 55, 0.5);
        }
        .theme-golden .progress-fill {
            background: linear-gradient(90deg, #d4af37, #f5d060);
        }

        /* ========== THEME: SILVER ========== */
        .theme-silver {
            background: linear-gradient(135deg, #1a1d24, #2d3139, #1f2329);
        }
        .theme-silver .card {
            background: rgba(160, 176, 192, 0.06);
            border: 1px solid rgba(160, 176, 192, 0.2);
            border-radius: 14px;
            box-shadow: 0 2px 12px rgba(0, 0, 0, 0.2);
        }
        .theme-silver .btn-primary {
            background: linear-gradient(135deg, #a0b0c0, #8899aa);
            color: #1a1d24;
            border-radius: 10px;
        }
        .theme-silver .header {
            background: rgba(45, 49, 57, 0.9);
            border-bottom: 1px solid rgba(160, 176, 192, 0.15);
        }
        .theme-silver .poetry-line { color: #c0d0e0; }
        .theme-silver .card-highlight {
            background: rgba(160, 176, 192, 0.08);
            border-color: rgba(160, 176, 192, 0.3);
        }
        .theme-silver .progress-fill {
            background: linear-gradient(90deg, #a0b0c0, #d0dde8);
        }
        
        /* ========== TYPOGRAPHY ========== */
        h1, h2, h3, h4 {
            font-weight: 700;
        }
        
        p {
            line-height: 1.6;
        }
        
        /* ========== FORM ELEMENTS ========== */
        input, button, select, textarea {
            font-family: inherit;
            font-size: 1rem;
        }
        
        input, select, textarea {
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            color: #fff;
            border-radius: 10px;
            padding: 12px 16px;
            outline: none;
            transition: all 0.3s;
        }
        
        input:focus, select:focus, textarea:focus {
            border-color: #D4AF37;
            box-shadow: 0 0 0 2px rgba(212, 175, 55, 0.2);
        }
        
        input::placeholder, textarea::placeholder {
            color: rgba(255, 255, 255, 0.5);
        }
        
        /* ========== BUTTONS ========== */
        button {
            cursor: pointer;
            border: none;
            border-radius: 10px;
            padding: 12px 20px;
            font-weight: 600;
            transition: all 0.3s;
        }
        
        button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        .btn-primary {
            background: linear-gradient(135deg, #D4AF37, #B8941F);
            color: #0A1628;
        }
        
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(212, 175, 55, 0.3);
        }
        
        .btn-secondary {
            background: rgba(255, 255, 255, 0.1);
            color: #fff;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        
        .btn-secondary:hover {
            background: rgba(255, 255, 255, 0.15);
        }
        
        .btn-success {
            background: #00C853;
            color: #fff;
        }
        
        .btn-danger {
            background: #FF5252;
            color: #fff;
        }
        
        .btn-small {
            padding: 8px 12px;
            font-size: 0.9rem;
        }
        
        .btn-excel {
            background: #217346;
            color: #fff;
        }
        
        .btn-excel:hover {
            background: #1b5e3a;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(33, 115, 70, 0.3);
        }
        
        /* ========== SLIDER ========== */
        input[type="range"] {
            -webkit-appearance: none;
            width: 100%;
            height: 8px;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 4px;
            outline: none;
        }
        
        input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 22px;
            height: 22px;
            border-radius: 50%;
            background: #D4AF37;
            cursor: pointer;
            border: 2px solid #fff;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.3);
        }
        
        /* ========== SCROLLBAR ========== */
        ::-webkit-scrollbar {
            width: 8px;
        }
        
        ::-webkit-scrollbar-track {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 4px;
        }
        
        ::-webkit-scrollbar-thumb {
            background: rgba(255, 255, 255, 0.2);
            border-radius: 4px;
        }
        
        ::-webkit-scrollbar-thumb:hover {
            background: rgba(255, 255, 255, 0.3);
        }
        
        /* ========== CARD & CONTAINERS ========== */
        .card {
            border-radius: 20px;
            padding: 20px;
            backdrop-filter: blur(10px);
            transition: background 0.3s, border 0.3s;
        }
        
        .card-highlight {
            background: rgba(212, 175, 55, 0.1);
            border-color: rgba(212, 175, 55, 0.3);
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 20px;
        }
        
        /* ========== GRID SYSTEM ========== */
        .grid {
            display: grid;
            gap: 20px;
        }
        
        .grid-2 {
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
        }
        
        .grid-3 {
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
        }
        
        /* ========== UTILITIES ========== */
        .text-center { text-align: center; }
        .text-right { text-align: right; }
        .text-gold { color: #D4AF37; }
        .text-success { color: #00C853; }
        .text-danger { color: #FF5252; }
        .text-muted { color: rgba(255, 255, 255, 0.6); }
        
        .mb-1 { margin-bottom: 10px; }
        .mb-2 { margin-bottom: 20px; }
        .mb-3 { margin-bottom: 30px; }
        
        .mt-1 { margin-top: 10px; }
        .mt-2 { margin-top: 20px; }
        .mt-3 { margin-top: 30px; }
        
        .flex { display: flex; }
        .flex-column { flex-direction: column; }
        .align-center { align-items: center; }
        .justify-center { justify-content: center; }
        .justify-between { justify-content: space-between; }
        .gap-1 { gap: 10px; }
        .gap-2 { gap: 20px; }
        .gap-3 { gap: 30px; }
        
        .w-100 { width: 100%; }
        .h-100 { height: 100%; }
        
        .hidden { display: none; }
        
        /* ========== ANIMATIONS ========== */
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        
        @keyframes slideUp {
            from { transform: translateY(20px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }
        
        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }
        
        .animate-fade { animation: fadeIn 0.5s ease; }
        .animate-slide { animation: slideUp 0.5s ease; }
        .animate-pulse { animation: pulse 2s infinite; }
        
        /* ========== HEADER ========== */
        .header {
            background: rgba(255, 255, 255, 0.05);
            padding: 15px 20px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            position: sticky;
            top: 0;
            z-index: 100;
            backdrop-filter: blur(10px);
        }
        
        /* ========== MODAL ========== */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.85);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 11000;
            padding: 20px;
            animation: fadeIn 0.3s ease;
        }
        
        .modal-content {
            background: #1A2D4A;
            border-radius: 24px;
            width: 100%;
            max-width: 500px;
            max-height: 85vh;
            overflow: auto;
            -webkit-overflow-scrolling: touch;
            overscroll-behavior: contain;
            padding: 30px;
            animation: slideUp 0.3s ease;
            border: 1px solid rgba(255, 255, 255, 0.1);
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.3);
        }
        
        .modal-wide {
            max-width: 700px;
        }
        
        /* ========== BADGES & RANKS ========== */
        .badge {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.85rem;
            font-weight: 600;
        }
        
        .rank-badge {
            width: 70px;
            height: 70px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 2rem;
            margin: 0 auto;
        }
        
        /* ========== PROGRESS BAR ========== */
        .progress-bar {
            height: 10px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 5px;
            overflow: hidden;
        }
        
        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #D4AF37, #FFD700);
            border-radius: 5px;
            transition: width 0.5s ease;
        }
        
        /* ========== LOADING ========== */
        .loading {
            display: flex;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
        }
        
        .spinner {
            width: 50px;
            height: 50px;
            border: 4px solid rgba(255, 255, 255, 0.1);
            border-top-color: #D4AF37;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        /* ========== MOBILE MENU ========== */
        .mobile-menu-btn {
            display: none;
            background: none;
            border: none;
            color: #fff;
            font-size: 1.5rem;
            cursor: pointer;
            padding: 5px;
            z-index: 101;
        }

        .mobile-menu-overlay {
            position: fixed;
            top: 60px;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(10, 22, 40, 0.95);
            z-index: 99;
            padding: 20px;
            animation: fadeIn 0.3s ease;
            display: flex;
            flex-direction: column;
            gap: 15px;
            backdrop-filter: blur(10px);
            overflow-y: auto;
        }

        .desktop-menu {
            display: flex;
            gap: 10px;
        }

        /* ========== POETRY LINE ========== */
        .poetry-line {
            text-align: center;
            font-size: 1.1rem;
            color: #D4AF37;
            margin: 10px 0;
            opacity: 0.8;
            font-style: italic;
        }

        /* ========== RESPONSIVE ========== */
        @media (max-width: 768px) {
            .container {
                padding: 0 15px;
            }
            
            .grid-2, .grid-3 {
                grid-template-columns: 1fr;
            }
            
            .modal-content {
                padding: 20px;
                max-height: 90vh;
            }
            
            .header {
                padding: 12px 15px;
            }

            .desktop-menu {
                display: none;
            }

            .mobile-menu-btn {
                display: block;
            }
        }
    </style>
</head>
<body>
    <div id="root"></div>
    
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- Ù…ÙƒØªØ¨Ø© SheetJS Ù„ØªØµØ¯ÙŠØ± ÙˆØ§Ø³ØªÙŠØ±Ø§Ø¯ Excel -->
    <script src="https://cdn.sheetjs.com/xlsx-0.20.2/package/dist/xlsx.full.min.js"></script>
    
    <script type="text/babel">
        // ==================== REACT IMPORTS ====================
        const { useState, useEffect } = React;
        
        // ==================== CONSTANTS ====================
        const STORAGE_KEY = 'bayan-platform-final';
        const SUPERVISOR_DEFAULT_PASSWORD = 'Aa12341234##';
        const FAMILY_PERCENTAGE = 0.05;

        // ==================== PHONE BOOK DATA ====================
        const phoneBook = {
            "Ø£Ø³Ø§Ù…Ø© Ø§Ù„Ø³Ù‡ÙŠÙ„": "966537375072",
            "Ø§Ù„ÙˆÙ„ÙŠØ¯ Ø§Ù„Ø³Ù‡ÙŠÙ„": "966537375072",
            "Ø§Ù„Ø¨Ø±Ø§Ø¡ Ø§Ù„Ø³Ø¨Ø¹Ø§Ù†": "966531932193",
            "ØªØ±ÙƒÙŠ Ø§Ù„Ù…ÙØ±Ø¬": "966530519390",
            "Ø±ÙŠØ§Ø¶ Ø§Ù„Ø³Ù‡ÙŠÙ„": "9660554490912",
            "Ø²ÙŠØ§Ø¯ Ø§Ù„Ø³ÙˆÙŠÙ„Ù…": "966554617765",
            "Ø²ÙŠØ§Ø¯ Ø§Ù„Ø¹Ù…Ø±": "966502407973",
            "Ø³Ø¹ÙˆØ¯ Ø§Ù„ÙÙ‡ÙŠØ¯": "966540013340",
            "Ø¹Ø¨Ø¯Ø§Ù„Ù„Ù‡ Ø§Ù„ÙØ§ÙŠØ²": "966551087070",
            "Ø¹Ø¨Ø¯Ø§Ù„Ù„Ù‡ Ø¹Ø³ÙŠØ±ÙŠ": "966558738520",
            "Ø¹Ø¨Ø¯Ø§Ù„Ù…Ø¬ÙŠØ¯ Ø§Ù„Ø¹Ù†ÙŠÙ‚": "966539620254",
            "Ø¹Ø¨Ø¯Ø§Ù„Ù…Ø¬ÙŠØ¯ Ø§Ù„ÙŠØ­ÙŠØ§": "966554847725",
            "Ø¹Ø¨Ø¯Ø§Ù„Ù…Ù„Ùƒ Ø§Ù„Ø­ÙŠØ¯Ø±": "966554496182",
            "Ø¹Ø²Ø§Ù… Ø§Ù„Ø¬Ø±ÙŠÙˆÙŠ": "966551013616",
            "Ø¹Ù…Ø± Ø§Ù„ØªÙˆÙŠÙ…": "966530310686",
            "ÙØ§Ø±Ø³ Ø§Ù„Ù…Ù†ÙŠØ¹": "966535181244",
            "Ù…Ø­Ù…Ø¯ Ø§Ù„Ø¯ØºÙŠÙ…": "966561355251",
            "Ù…Ø­Ù…Ø¯ Ø§Ù„Ù…Ù†ØµÙˆØ±": "966559023480",
            "Ø¹Ø¨Ø¯Ø§Ù„Ù„Ù‡ Ø§Ù„Ø¯Ø±ÙŠØ¨": "966506969411",
            "Ø±ÙŠØ§Ù† Ø§Ù„ØºØ«Ø¨Ø±": "966568018843",
            "Ø¹Ø¨Ø¯Ø§Ù„Ø¹Ø²ÙŠØ² Ø§Ù„ØºØ²ÙŠ": "966556322528"
        };

        // Ø±Ø¨Ø· Ø±Ø¤Ø³Ø§Ø¡ Ø§Ù„Ø£Ø³Ø± Ø¨Ø§Ù„Ù…Ø­Ø·Ø§Øª (Ù„Ù„ØªÙ‡ÙŠØ¦Ø© Ø§Ù„Ø£ÙˆÙ„ÙŠØ©)
        const familiesHeads = {
            "Ù…Ø­Ø·Ø© Ø£": "Ø£Ø³Ø§Ù…Ø© Ø§Ù„Ø³Ù‡ÙŠÙ„",
            "Ù…Ø­Ø·Ø© Ø¨": "Ø¹Ø²Ø§Ù… Ø§Ù„Ø¬Ø±ÙŠÙˆÙŠ",
            "Ù…Ø­Ø·Ø© Ø¬": "Ø³Ø¹ÙˆØ¯ Ø§Ù„ÙÙ‡ÙŠØ¯"
        };
        
        // ==================== THEMES ====================
        const themes = {
            classic: {
                name: 'ÙƒÙ„Ø§Ø³ÙŠÙƒÙŠ',
                icon: 'ðŸ›ï¸',
                class: 'theme-classic',
                primaryColor: '#D4AF37',
                secondaryColor: '#B8941F',
                accentColor: '#FFD700',
                poetry: 'Ø¥Ø°Ø§ ØºØ§Ù…ÙŽØ±ØªÙŽ ÙÙŠ Ø´ÙŽØ±ÙŽÙÙ Ù…ÙŽØ±ÙˆÙ…Ù ... ÙÙ„Ø§ ØªÙŽÙ‚Ù†ÙŽØ¹Ù’ Ø¨ÙÙ…Ø§ Ø¯ÙˆÙ†ÙŽ Ø§Ù„Ù†ÙØ¬ÙˆÙ…Ù',
                presentationBg: 'linear-gradient(135deg, #050510, #0a0a2a, #0f0f1f)',
                slideBg: 'transparent',
                slideAccent: 'rgba(212, 175, 55, 0.08)',
                slideBorder: 'rgba(212, 175, 55, 0.15)',
                podiumGradient: (color) => `linear-gradient(to top, ${color}44, ${color}BB)`,
                titleStyle: { fontWeight: '900', letterSpacing: '2px' },
                cardRadius: '20px',
                ornament: 'âœ¦',
                headerBg: 'rgba(0,0,0,0.4)'
            },
            modern: {
                name: 'Ø­Ø¯ÙŠØ«',
                icon: 'ðŸ’Ž',
                class: 'theme-modern',
                primaryColor: '#5A9E9E',
                secondaryColor: '#3d7a7a',
                accentColor: '#7ec8c8',
                poetry: 'ÙˆÙ…Ø§ Ù†ÙŽÙŠÙ’Ù„Ù Ø§Ù„Ù…ÙŽØ·Ø§Ù„ÙØ¨Ù Ø¨Ø§Ù„ØªÙŽÙ…ÙŽÙ†Ù‘ÙŠ ... ÙˆÙ„ÙƒÙ† ØªÙØ¤Ø®ÙŽØ°Ù Ø§Ù„Ø¯ÙÙ†ÙŠØ§ ØºÙÙ„Ø§Ø¨Ø§',
                presentationBg: 'linear-gradient(160deg, #0f0c29, #1a1640, #151030)',
                slideBg: 'rgba(90, 158, 158, 0.03)',
                slideAccent: 'rgba(90, 158, 158, 0.06)',
                slideBorder: 'rgba(90, 158, 158, 0.15)',
                podiumGradient: (color) => `linear-gradient(to top, ${color}33, ${color}99)`,
                titleStyle: { fontWeight: '700', letterSpacing: '4px', textTransform: 'uppercase' },
                cardRadius: '16px',
                ornament: 'â—†',
                headerBg: 'rgba(0,0,0,0.5)'
            },
            majestic: {
                name: 'Ù…Ù‡ÙŠØ¨',
                icon: 'ðŸ‘‘',
                class: 'theme-majestic',
                primaryColor: '#9b7e5e',
                secondaryColor: '#7a6348',
                accentColor: '#c4a67a',
                poetry: 'Ø¹ÙŽÙ„Ù‰ Ù‚ÙŽØ¯Ø±Ù Ø£ÙŽÙ‡Ù„Ù Ø§Ù„Ø¹ÙŽØ²Ù…Ù ØªÙŽØ£ØªÙŠ Ø§Ù„Ø¹ÙŽØ²Ø§Ø¦ÙÙ…Ù ... ÙˆÙŽØªÙŽØ£ØªÙŠ Ø¹ÙŽÙ„Ù‰ Ù‚ÙŽØ¯Ø±Ù Ø§Ù„ÙƒÙØ±Ø§Ù…Ù Ø§Ù„Ù…ÙŽÙƒØ§Ø±ÙÙ…Ù',
                presentationBg: 'linear-gradient(135deg, #0d0520, #1a0a2e, #0d1b2a)',
                slideBg: 'rgba(155, 126, 94, 0.04)',
                slideAccent: 'rgba(155, 126, 94, 0.08)',
                slideBorder: 'rgba(155, 126, 94, 0.25)',
                podiumGradient: (color) => `linear-gradient(to top, ${color}22, ${color}AA)`,
                titleStyle: { fontWeight: '900', letterSpacing: '3px' },
                cardRadius: '24px',
                ornament: 'â–',
                headerBg: 'rgba(13,5,32,0.7)'
            },
            golden: {
                name: 'Ø°Ù‡Ø¨ÙŠ',
                icon: 'ðŸŒŸ',
                class: 'theme-golden',
                primaryColor: '#d4af37',
                secondaryColor: '#B8941F',
                accentColor: '#f5d060',
                poetry: 'ÙˆÙŽÙ…ÙŽÙƒØ§Ù†Ù Ù†ÙŽØ¬Ù…Ù ÙÙŠ Ø§Ù„Ø³ÙŽÙ…Ø§Ø¡Ù Ù…ÙÙ†ÙŠÙÙ ... Ù„Ø§ ÙŠÙŽØ³ØªÙŽÙˆÙŠ ÙˆÙŽØ§Ù„Ø¯ÙŽØ±Ø¨Ù Ø¯ÙˆÙ†ÙŽ Ø­ÙØ±ÙˆÙÙ',
                presentationBg: 'linear-gradient(135deg, #0f0a04, #1a1207, #251a0a)',
                slideBg: 'rgba(212, 175, 55, 0.03)',
                slideAccent: 'rgba(212, 175, 55, 0.06)',
                slideBorder: 'rgba(212, 175, 55, 0.2)',
                podiumGradient: (color) => `linear-gradient(to top, ${color}55, ${color}CC)`,
                titleStyle: { fontWeight: '900', letterSpacing: '2px', textShadow: '0 0 20px rgba(212,175,55,0.3)' },
                cardRadius: '20px',
                ornament: 'â˜…',
                headerBg: 'rgba(26,18,7,0.8)'
            },
            silver: {
                name: 'ÙØ¶ÙŠ',
                icon: 'ðŸ”·',
                class: 'theme-silver',
                primaryColor: '#a0b0c0',
                secondaryColor: '#8899aa',
                accentColor: '#d0dde8',
                poetry: 'Ø¥Ø°Ø§ Ø£ÙŽÙ†ØªÙŽ Ø£ÙŽÙƒØ±ÙŽÙ…ØªÙŽ Ø§Ù„ÙƒÙŽØ±ÙŠÙ…ÙŽ Ù…ÙŽÙ„ÙŽÙƒØªÙŽÙ‡Ù ... ÙˆÙŽØ¥ÙÙ† Ø£ÙŽÙ†ØªÙŽ Ø£ÙŽÙƒØ±ÙŽÙ…ØªÙŽ Ø§Ù„Ù„ÙŽØ¦ÙŠÙ…ÙŽ ØªÙŽÙ…ÙŽØ±ÙŽÙ‘Ø¯Ø§',
                presentationBg: 'linear-gradient(135deg, #111318, #1a1d24, #14171d)',
                slideBg: 'rgba(160, 176, 192, 0.03)',
                slideAccent: 'rgba(160, 176, 192, 0.05)',
                slideBorder: 'rgba(160, 176, 192, 0.15)',
                podiumGradient: (color) => `linear-gradient(to top, ${color}33, ${color}AA)`,
                titleStyle: { fontWeight: '600', letterSpacing: '3px' },
                cardRadius: '14px',
                ornament: 'â—‡',
                headerBg: 'rgba(26,29,36,0.8)'
            }
        };
        
        // ==================== INITIAL DATA GENERATOR ====================
        const generateInitialData = () => ({
            phoneBook: {...phoneBook},
            stations: [
                {
                    id: 'a',
                    name: 'Ù…Ø­Ø·Ø© Ø£',
                    head: familiesHeads["Ù…Ø­Ø·Ø© Ø£"], // Ø±Ø¨Ø· Ø±Ø¦ÙŠØ³ Ø§Ù„Ø£Ø³Ø±Ø©
                    color: '#FF6B6B',
                    totalLiters: 0,
                    familyAchievements: [],
                    students: [
                        { id: 1, name: 'Ø£Ø³Ø§Ù…Ø© Ø§Ù„Ø³Ù‡ÙŠÙ„', liters: 0, password: 'Osama@2024', achievements: [], badges: [] },
                        { id: 2, name: 'Ø¹Ø¨Ø¯Ø§Ù„Ù„Ù‡ Ø¹Ø³ÙŠØ±ÙŠ', liters: 0, password: 'Abdullah.A@2024', achievements: [], badges: [] },
                        { id: 3, name: 'ØªØ±ÙƒÙŠ Ø§Ù„Ù…ÙØ±Ø¬', liters: 0, password: 'Turki@2024', achievements: [], badges: [] },
                        { id: 4, name: 'Ø²ÙŠØ§Ø¯ Ø§Ù„Ø¹Ù…Ø±', liters: 0, password: 'Ziyad.O@2024', achievements: [], badges: [] },
                        { id: 5, name: 'Ø±ÙŠØ§Ø¶ Ø§Ù„Ø³Ù‡ÙŠÙ„', liters: 0, password: 'Riyadh@2024', achievements: [], badges: [] },
                        { id: 6, name: 'Ø¹Ø¨Ø¯Ø§Ù„Ù…Ù„Ùƒ Ø§Ù„Ø­ÙŠØ¯Ø±', liters: 0, password: 'AbdulMalik@2024', achievements: [], badges: [] },
                        { id: 7, name: 'Ø²ÙŠØ§Ø¯ Ø§Ù„Ø³ÙˆÙŠÙ„Ù…', liters: 0, password: 'Ziyad.S@2024', achievements: [], badges: [] }
                    ]
                },
                {
                    id: 'b',
                    name: 'Ù…Ø­Ø·Ø© Ø¨',
                    head: familiesHeads["Ù…Ø­Ø·Ø© Ø¨"],
                    color: '#4ECDC4',
                    totalLiters: 0,
                    familyAchievements: [],
                    students: [
                        { id: 8, name: 'Ø¹Ø²Ø§Ù… Ø§Ù„Ø¬Ø±ÙŠÙˆÙŠ', liters: 0, password: 'Azzam@2024', achievements: [], badges: [] },
                        { id: 9, name: 'Ø§Ù„Ø¨Ø±Ø§Ø¡ Ø§Ù„Ø³Ø¨Ø¹Ø§Ù†', liters: 0, password: 'AlBaraa@2024', achievements: [], badges: [] },
                        { id: 10, name: 'Ø§Ù„ÙˆÙ„ÙŠØ¯ Ø§Ù„Ø³Ù‡ÙŠÙ„', liters: 0, password: 'AlWaleed@2024', achievements: [], badges: [] },
                        { id: 11, name: 'Ø¹Ø¨Ø¯Ø§Ù„Ø¹Ø²ÙŠØ² Ø§Ù„ØºØ²ÙŠ', liters: 0, password: 'AbdulAziz@2024', achievements: [], badges: [] },
                        { id: 12, name: 'Ø±ÙŠØ§Ù† Ø§Ù„ØºØ«Ø¨Ø±', liters: 0, password: 'Rayan@2024', achievements: [], badges: [] },
                        { id: 13, name: 'Ø¹Ø¨Ø¯Ø§Ù„Ù…Ø¬ÙŠØ¯ Ø§Ù„Ø¹Ù†ÙŠÙ‚', liters: 0, password: 'AbdulMajeed.O@2024', achievements: [], badges: [] },
                        { id: 14, name: 'Ø¹Ù…Ø± Ø§Ù„ØªÙˆÙŠÙ…', liters: 0, password: 'Omar@2024', achievements: [], badges: [] }
                    ]
                },
                {
                    id: 'c',
                    name: 'Ù…Ø­Ø·Ø© Ø¬',
                    head: familiesHeads["Ù…Ø­Ø·Ø© Ø¬"],
                    color: '#A66CFF',
                    totalLiters: 0,
                    familyAchievements: [],
                    students: [
                        { id: 15, name: 'Ø³Ø¹ÙˆØ¯ Ø§Ù„ÙÙ‡ÙŠØ¯', liters: 0, password: 'Saud@2024', achievements: [], badges: [] },
                        { id: 16, name: 'Ù…Ø­Ù…Ø¯ Ø§Ù„Ù…Ù†ØµÙˆØ±', liters: 0, password: 'Mohammed.M@2024', achievements: [], badges: [] },
                        { id: 17, name: 'Ù…Ø­Ù…Ø¯ Ø§Ù„Ø¯ØºÙŠÙ…', liters: 0, password: 'Mohammed.D@2024', achievements: [], badges: [] },
                        { id: 18, name: 'Ø¹Ø¨Ø¯Ø§Ù„Ù„Ù‡ Ø§Ù„ÙØ§ÙŠØ²', liters: 0, password: 'Abdullah.F@2024', achievements: [], badges: [] },
                        { id: 19, name: 'Ø¹Ø¨Ø¯Ø§Ù„Ù…Ø¬ÙŠØ¯ Ø§Ù„ÙŠØ­ÙŠØ§', liters: 0, password: 'AbdulMajeed.Y@2024', achievements: [], badges: [] },
                        { id: 20, name: 'ÙØ§Ø±Ø³ Ø§Ù„Ù…Ù†ÙŠØ¹', liters: 0, password: 'Faris@2024', achievements: [], badges: [] },
                        { id: 21, name: 'Ø¹Ø¨Ø¯Ø§Ù„Ù„Ù‡ Ø§Ù„Ø¯Ø±ÙŠØ¨', liters: 0, password: 'Abdullah.D@2024', achievements: [], badges: [] }
                    ]
                }
            ],
            settings: {
                title: 'Ø§Ù„Ø¨Ø±Ù†Ø§Ù…Ø¬ Ø§Ù„ØªÙ†Ø´ÙŠØ·ÙŠ',
                pointsHidden: false,
                supervisorPassword: SUPERVISOR_DEFAULT_PASSWORD,
                currency: 'Ù†Ù‚Ø·Ø©',
                currencyIcon: 'â­',
                primaryColor: '#D4AF37',
                nextStudentId: 22,
                theme: 'classic' // Ø§Ù„ØªØµÙ…ÙŠÙ… Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠ
            },
            archive: [],
            assignmentsArchive: [],
            news: [
                { id: 1, content: 'Ù…Ø±Ø­Ø¨Ø§Ù‹ Ø¨ÙƒÙ… ÙÙŠ Ø§Ù„Ù…Ù†ØµØ© Ø§Ù„ØªØ­ÙÙŠØ²ÙŠØ©! ðŸŽ‰', date: '2024-01-01' },
                { id: 2, content: 'Ø§Ù†Ø·Ù„Ù‚ Ø§Ù„ØªØ­Ø¯ÙŠ Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹ÙŠ Ø§Ù„Ø¬Ø¯ÙŠØ¯ ðŸš€', date: '2024-01-08' }
            ],
            store: {
                items: [
                    { id: 1, name: 'Ø§Ø³ØªØ±Ø§Ø­Ø© 10 Ø¯Ù‚Ø§Ø¦Ù‚', price: 200, icon: 'â˜•', available: true },
                    { id: 2, name: 'Ø¥Ø¹ÙØ§Ø¡ Ù…Ù† Ù†Ø´Ø§Ø·', price: 500, icon: 'ðŸŽ«', available: true },
                    { id: 3, name: 'ÙˆØ¬Ø¨Ø© Ù…Ø¬Ø§Ù†ÙŠØ©', price: 300, icon: 'ðŸ”', available: true },
                    { id: 4, name: 'Ù‡Ø¯ÙŠØ© Ù…ÙØ§Ø¬Ø¦Ø©', price: 1000, icon: 'ðŸŽ', available: true }
                ],
                purchases: []
            },
            badges: [
                { id: 'first', name: 'Ø§Ù„Ø¨Ø¯Ø§ÙŠØ©', icon: 'ðŸŒŸ', desc: 'Ø£ÙˆÙ„ Ø¥Ù†Ø¬Ø§Ø²' },
                { id: 'hundred', name: 'Ø§Ù„Ù…Ø¦ÙˆÙŠ', icon: 'ðŸ’¯', desc: '100 Ù†Ù‚Ø·Ø©' },
                { id: 'fiveHundred', name: 'Ø§Ù„Ù…Ø­ØªØ±Ù', icon: 'ðŸ…', desc: '500 Ù†Ù‚Ø·Ø©' },
                { id: 'thousand', name: 'Ø§Ù„Ø£Ù„ÙÙŠ', icon: 'ðŸ‘‘', desc: '1000 Ù†Ù‚Ø·Ø©' }
            ],
            programs: {
                family: {
                    cultural: {
                        name: 'Ø§Ù„Ø«Ù‚Ø§ÙÙŠØ©',
                        icon: 'ðŸ“š',
                        color: '#9C27B0',
                        programs: [
                            {
                                id: 'rouh',
                                name: 'Ø±ÙˆØ­',
                                max: 1000,
                                criteria: [
                                    { name: 'Ø·Ø±ÙŠÙ‚Ø© Ø§Ù„ØªÙ‚Ø¯ÙŠÙ…', pct: 20 },
                                    { name: 'Ù…Ø´Ø§Ø±ÙƒØ© Ø§Ù„Ø¬Ù…ÙŠØ¹', pct: 20 },
                                    { name: 'Ù…Ø¯Ø© Ø§Ù„Ù…Ù‚Ø·Ø¹', pct: 20 },
                                    { name: 'ØªØ­Ù‚ÙŠÙ‚ Ø§Ù„Ù‡Ø¯Ù', pct: 30 },
                                    { name: 'Ø§Ù„Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ù…Ø¨ÙƒØ±', pct: 10 }
                                ]
                            },
                            {
                                id: 'qiyam',
                                name: 'Ù‚ÙŠÙ…',
                                max: 1500,
                                criteria: [
                                    { name: 'Ø·Ø±ÙŠÙ‚Ø© Ø§Ù„ØªÙ‚Ø¯ÙŠÙ…', pct: 20 },
                                    { name: 'Ù…Ø´Ø§Ø±ÙƒØ© Ø§Ù„Ø¬Ù…ÙŠØ¹', pct: 20 },
                                    { name: 'ØªØ­Ù‚ÙŠÙ‚ Ø§Ù„Ù‡Ø¯Ù', pct: 30 },
                                    { name: 'Ø§Ù„Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ù…Ø¨ÙƒØ±', pct: 10 },
                                    { name: 'Ù…Ø¯Ø© Ø§Ù„Ù…Ù‚Ø·Ø¹', pct: 20 }
                                ]
                            }
                        ]
                    },
                    social: {
                        name: 'Ø§Ù„Ø§Ø¬ØªÙ…Ø§Ø¹ÙŠØ©',
                        icon: 'ðŸ¤',
                        color: '#2196F3',
                        programs: [
                            {
                                id: 'sufra',
                                name: 'Ø§Ù„Ø³ÙØ±Ø© Ø§Ù„Ø±Ù…Ø¶Ø§Ù†ÙŠØ©',
                                max: 1500,
                                criteria: [
                                    { name: 'Ø§Ù„Ø·Ø¹Ù…', pct: 20 },
                                    { name: 'Ù…Ø´Ø§Ø±ÙƒØ© Ø§Ù„Ø¬Ù…ÙŠØ¹', pct: 25 },
                                    { name: 'ØªÙ†ÙˆØ¹ Ø§Ù„Ø£Ø·Ø¨Ø§Ù‚', pct: 25 },
                                    { name: 'Ø§Ù„Ø¯ÙŠÙƒÙˆØ±', pct: 20 },
                                    { name: 'Ø§Ù„Ø¥Ø¹Ù„Ø§Ù†', pct: 10 }
                                ]
                            },
                            {
                                id: 'makarim',
                                name: 'Ù…ÙƒØ§Ø±Ù…',
                                max: 1000,
                                criteria: [
                                    { name: 'Ù…Ø´Ø§Ø±ÙƒØ© Ø§Ù„Ø¬Ù…ÙŠØ¹', pct: 20 },
                                    { name: 'Ø§Ù„ØªÙ‚Ø¯ÙŠÙ…', pct: 20 },
                                    { name: 'Ø§Ù„Ø·Ø¹Ù…', pct: 40 },
                                    { name: 'Ø§Ù„ØªØ±ØªÙŠØ¨', pct: 20 }
                                ]
                            },
                            {
                                id: 'khidma_adiya',
                                name: 'Ø®Ø¯Ù…Ø© Ø¹Ø§Ø¯ÙŠØ©',
                                max: 500,
                                criteria: [
                                    { name: 'Ø§Ù„ÙƒÙØ§ÙŠØ©', pct: 50 },
                                    { name: 'Ù…Ø´Ø§Ø±ÙƒØ© Ø§Ù„Ø¬Ù…ÙŠØ¹', pct: 30 },
                                    { name: 'Ø§Ù„Ù„Ù…Ø³Ø©', pct: 20 }
                                ]
                            },
                            {
                                id: 'khidma_dawal',
                                name: 'Ø®Ø¯Ù…Ø© Ø¯ÙˆÙ„',
                                max: 1500,
                                criteria: [
                                    { name: 'Ù…Ø´Ø§Ø±ÙƒØ© Ø§Ù„Ø¬Ù…ÙŠØ¹', pct: 20 },
                                    { name: 'Ø§Ù„Ø¯ÙŠÙƒÙˆØ±', pct: 20 },
                                    { name: 'Ø¬ÙˆØ¯Ø© Ø§Ù„Ø£Ø·Ø¨Ø§Ù‚', pct: 30 },
                                    { name: 'Ø§Ù„ØªÙ‚Ø¯ÙŠÙ…', pct: 20 },
                                    { name: 'Ø§Ù„Ø¥Ø¹Ù„Ø§Ù†', pct: 10 }
                                ]
                            },
                            {
                                id: 'ekhlat_ha',
                                name: 'Ø§Ø®Ù„Ø·Ù‡Ø§',
                                max: 1000,
                                criteria: [
                                    { name: 'Ø§Ù„Ø·Ø¹Ù…', pct: 70 },
                                    { name: 'Ø§Ù„Ø´ÙƒÙ„', pct: 30 }
                                ]
                            },
                            {
                                id: 'tabaq_shatwi',
                                name: 'Ø§Ù„Ø·Ø¨Ù‚ Ø§Ù„Ø´ØªÙˆÙŠ',
                                max: 1000,
                                criteria: [
                                    { name: 'Ø§Ù„ÙƒÙØ§ÙŠØ©', pct: 30 },
                                    { name: 'Ø§Ù„ØªÙ‚Ø¯ÙŠÙ…', pct: 20 },
                                    { name: 'Ø§Ù„Ø·Ø¹Ù…', pct: 30 },
                                    { name: 'Ø§Ù„Ø¥Ø¹Ù„Ø§Ù†', pct: 20 }
                                ]
                            },
                            {
                                id: 'majlis_ajawid',
                                name: 'Ù…Ø¬Ù„Ø³ Ø§Ù„Ø£Ø¬Ø§ÙˆÙŠØ¯',
                                max: 1000,
                                criteria: [
                                    { name: 'Ù…Ø´Ø§Ø±ÙƒØ© Ø§Ù„Ø¬Ù…ÙŠØ¹', pct: 40 },
                                    { name: 'Ø¬ÙˆØ¯Ø© Ø§Ù„Ù…Ø´Ø§Ø±ÙƒØ§Øª ÙˆØªÙ†ÙˆØ¹Ù‡Ø§', pct: 30 },
                                    { name: 'Ø§Ù„Ø¥Ø¨Ø¯Ø§Ø¹ ÙˆØ§Ù„ØªØ¬Ø¯ÙŠØ¯', pct: 30 }
                                ]
                            },
                            {
                                id: 'marajil',
                                name: 'Ù…Ø±Ø§Ø¬Ù„',
                                max: 1500,
                                criteria: [
                                    { name: 'Ù…Ø´Ø§Ø±ÙƒØ© Ø§Ù„Ø¬Ù…ÙŠØ¹', pct: 20 },
                                    { name: 'Ø§Ù„Ø¯ÙŠÙƒÙˆØ±', pct: 20 },
                                    { name: 'Ø¬ÙˆØ¯Ø© Ø§Ù„Ø·Ø¨Ø® ÙˆØ§Ù„Ø·Ø¹Ù…', pct: 30 },
                                    { name: 'Ø§Ù„Ù†Ø¸Ø§ÙØ© ÙˆØ§Ù„ØªØ±ØªÙŠØ¨', pct: 20 },
                                    { name: 'Ø§Ù„Ø¥Ø¹Ù„Ø§Ù†', pct: 10 }
                                ]
                            },
                            {
                                id: 'awalim_thalatha',
                                name: 'Ø§Ù„Ø¹ÙˆØ§Ù„Ù… Ø§Ù„Ø«Ù„Ø§Ø«',
                                max: 1500,
                                criteria: [
                                    { name: 'Ù…Ø´Ø§Ø±ÙƒØ© Ø§Ù„Ø¬Ù…ÙŠØ¹', pct: 15 },
                                    { name: 'ØªÙ†ÙˆØ¹ Ø§Ù„Ø£Ø·Ø¨Ø§Ù‚', pct: 15 },
                                    { name: 'Ø§Ù„Ø¯ÙŠÙƒÙˆØ±', pct: 20 },
                                    { name: 'Ø§Ù„Ø·Ø¹Ù…', pct: 20 },
                                    { name: 'Ø§Ù„ØªØ±ØªÙŠØ¨ ÙˆØ§Ù„Ù†Ø¸Ø§ÙØ©', pct: 20 },
                                    { name: 'Ø§Ù„Ø¥Ø¹Ù„Ø§Ù†', pct: 10 }
                                ]
                            }
                        ]
                    },
                    sports: {
                        name: 'Ø§Ù„Ø±ÙŠØ§Ø¶ÙŠØ©',
                        icon: 'âš½',
                        color: '#4CAF50',
                        programs: [
                            {
                                id: 'olympiad',
                                name: 'Ø§Ù„Ø£ÙˆÙ„Ù…Ø¨ÙŠØ§Ø¯',
                                max: 1000,
                                free: true,
                                criteria: []
                            },
                            {
                                id: 'football',
                                name: 'Ø¯ÙˆØ±ÙŠ Ø§Ù„Ù‚Ø¯Ù…',
                                max: 1000,
                                free: true,
                                criteria: []
                            },
                            {
                                id: 'tafadi',
                                name: 'Ø§Ù„ØªÙØ§Ø¯ÙŠ',
                                max: 500,
                                free: true,
                                criteria: []
                            },
                            {
                                id: 'volleyball',
                                name: 'Ø¯ÙˆØ±ÙŠ Ø§Ù„Ø·Ø§Ø¦Ø±Ø©',
                                max: 1000,
                                free: true,
                                criteria: []
                            }
                        ]
                    }
                },
                individual: {
                    educational: {
                        name: 'Ø§Ù„ØªØ±Ø¨ÙˆÙŠØ©',
                        icon: 'ðŸŽ“',
                        color: '#FF9800',
                        programs: [
                            {
                                id: 'halqa',
                                name: 'Ø§Ù„Ø­Ù„Ù‚Ø©',
                                max: 1000,
                                criteria: [
                                    { name: 'Ø§Ù„Ø­Ø¶ÙˆØ±', pct: 50 },
                                    { name: 'Ø§Ù„ØªØ³Ù…ÙŠØ¹', pct: 50 }
                                ]
                            },
                            {
                                id: 'talaat',
                                name: 'Ø§Ù„Ø·Ù„Ø¹Ø§Øª',
                                max: 1000,
                                free: true,
                                criteria: []
                            }
                        ]
                    },
                    cultural: {
                        name: 'Ø§Ù„Ø«Ù‚Ø§ÙÙŠØ©',
                        icon: 'ðŸ“–',
                        color: '#9C27B0',
                        programs: [
                            {
                                id: 'ilm',
                                name: 'Ø¹Ù„Ù…',
                                max: 1000,
                                criteria: [
                                    { name: 'Ø§Ù„Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ù…Ø¨ÙƒØ±', pct: 10 },
                                    { name: 'Ø§Ù„Ø§Ø±ØªØ¬Ø§Ù„', pct: 40 },
                                    { name: 'Ø¬ÙˆØ¯Ø© Ø§Ù„Ù…Ø§Ø¯Ø©', pct: 30 },
                                    { name: 'Ø§Ù„ÙˆÙ‚Øª', pct: 20 }
                                ]
                            },
                            {
                                id: 'hulal',
                                name: 'Ø­Ù„Ù„',
                                max: 1500,
                                criteria: [
                                    { name: 'Ø§Ù„Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ù…Ø¨ÙƒØ±', pct: 15 },
                                    { name: 'Ø§Ù„Ø§Ø±ØªØ¬Ø§Ù„', pct: 35 },
                                    { name: 'Ø¬ÙˆØ¯Ø© Ø§Ù„Ù…Ø§Ø¯Ø©', pct: 30 },
                                    { name: 'Ø§Ù„ÙˆÙ‚Øª', pct: 20 }
                                ]
                            },
                            {
                                id: 'huthu',
                                name: 'Ø­Ø°Ùˆ',
                                max: 500,
                                criteria: [
                                    { name: 'Ù…Ø­Ø§Ø°Ø§Ø© Ù†ÙØ³ Ø§Ù„Ø´ÙƒÙ„', pct: 100 }
                                ]
                            }
                        ]
                    },
                    social: {
                        name: 'Ø§Ù„Ø§Ø¬ØªÙ…Ø§Ø¹ÙŠØ©',
                        icon: 'ðŸ‘¨â€ðŸ‘©â€ðŸ‘§â€ðŸ‘¦',
                        color: '#2196F3',
                        programs: [
                            {
                                id: 'khayrkum',
                                name: 'Ø®ÙŠØ±ÙƒÙ… Ù„Ø£Ù‡Ù„Ù‡',
                                max: 1000,
                                criteria: [
                                    { name: 'Ø§Ù„ØªØµÙˆÙŠØ±', pct: 25 },
                                    { name: 'Ø§Ù„Ø´ÙƒÙ„ Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ', pct: 50 },
                                    { name: 'Ø§Ù„Ø¥Ø¨Ø¯Ø§Ø¹', pct: 25 }
                                ]
                            },
                            {
                                id: 'tostan',
                                name: 'ØªÙˆØ³ØªØ§Ù†',
                                max: 1500,
                                criteria: [
                                    { name: 'Ø§Ù„Ø·Ø¹Ù…', pct: 50 },
                                    { name: 'Ø§Ù„Ø´ÙƒÙ„', pct: 50 }
                                ]
                            },
                            {
                                id: 'mithla',
                                name: 'Ù…Ø«Ù„ Ø£Ø¬Ø±Ù‡',
                                max: 500,
                                criteria: [
                                    { name: 'Ø§Ù„Ø¥Ø¨Ø¯Ø§Ø¹ ÙˆØ§Ù„ØªØ¬Ø¯ÙŠØ¯', pct: 50 },
                                    { name: 'Ø§Ù„ØªÙˆØ«ÙŠÙ‚', pct: 50 }
                                ]
                            },
                            {
                                id: 'mudhif',
                                name: 'Ù…Ø¶ÙŠØ§Ù',
                                max: 1000,
                                criteria: [
                                    { name: 'Ø§Ù„Ù†Ø¸Ø§ÙØ© ÙˆØ§Ù„ØªØ±ØªÙŠØ¨', pct: 20 },
                                    { name: 'Ø§Ù„ØªÙ‚Ø¯ÙŠÙ…', pct: 20 },
                                    { name: 'Ø¬ÙˆØ¯Ø© Ø§Ù„Ø·Ø¨Ø® ÙˆØ§Ù„Ø·Ø¹Ù…', pct: 50 },
                                    { name: 'Ø§Ù„Ø¥Ø¹Ù„Ø§Ù†', pct: 10 }
                                ]
                            }
                        ]
                    },
                    sports: {
                        name: 'Ø§Ù„Ø±ÙŠØ§Ø¶ÙŠØ©',
                        icon: 'ðŸƒ',
                        color: '#4CAF50',
                        programs: [
                            {
                                id: 'tahaddi',
                                name: 'ØªØ­Ø¯ÙŠ Ø§Ù„Ø¹Ø§Ø¯Ø§Øª',
                                max: 1500,
                                free: true,
                                criteria: []
                            },
                            {
                                id: 'rami',
                                name: 'Ø§Ù„Ø±Ø§Ù…ÙŠ Ø§Ù„Ù…Ø§Ù‡Ø± (Ø§Ù„Ù‚Ù†Ø§Øµ)',
                                max: 500,
                                free: true,
                                criteria: []
                            },
                            {
                                id: 'ashara',
                                name: 'Ø§Ù„Ø¹Ø´Ø±Ø© Ø§Ù„ÙƒØ§Ù…Ù„Ø©',
                                max: 500,
                                free: true,
                                criteria: []
                            }
                        ]
                    }
                }
            }
        });
        
        // ==================== UTILITY FUNCTIONS ====================
        const getRank = (points) => {
            if (points >= 5000) return { name: '', icon: 'ðŸ‘‘', color: '#FFD700' };
            if (points >= 3000) return { name: '', icon: 'ðŸš€', color: '#9C27B0' };
            if (points >= 1500) return { name: '', icon: 'âœˆï¸', color: '#2196F3' };
            if (points >= 500) return { name: '', icon: 'ðŸš—', color: '#4CAF50' };
            return { name: '', icon: 'ðŸš²', color: '#78909C' };
        };
        
        const formatDate = (date = new Date()) => {
            return date.toLocaleDateString('ar-SA', {
                year: 'numeric',
                month: 'long',
                day: 'numeric'
            });
        };
        
        const formatNumber = (num) => {
            return new Intl.NumberFormat('en-US').format(num || 0);
        };

        // Ø¯Ø§Ù„Ø© Ù„ØªØ­ÙˆÙŠÙ„ Ù†Ø³Ø¨Ø© Ù…Ø¦ÙˆÙŠØ© Ø¥Ù„Ù‰ Ø±Ù‚Ù…
        const parsePercentage = (str) => {
            if (!str) return 0;
            const cleaned = str.toString().replace(/%/g, '').trim();
            const num = parseFloat(cleaned);
            return isNaN(num) ? 0 : num;
        };
        
        // ==================== MODAL COMPONENT ====================
        const Modal = ({ children, onClose, wide = false }) => {
            return ReactDOM.createPortal(
                <div className="modal-overlay" onClick={onClose}>
                    <div 
                        className={`modal-content ${wide ? 'modal-wide' : ''}`} 
                        onClick={(e) => e.stopPropagation()}
                    >
                        <button 
                            onClick={onClose}
                            style={{
                                position: 'absolute',
                                top: '15px',
                                left: '15px',
                                background: 'none',
                                border: 'none',
                                color: '#fff',
                                fontSize: '1.5rem',
                                cursor: 'pointer'
                            }}
                        >
                            âœ•
                        </button>
                        {children}
                    </div>
                </div>,
                document.body
            );
        };
        
        // ==================== LOADING COMPONENT ====================
        const LoadingScreen = () => (
            <div className="loading">
                <div className="spinner"></div>
            </div>
        );
        
        // ==================== SPLASH SCREEN ====================
        const SplashScreen = ({ onFinish, theme, data }) => {
            useEffect(() => {
                const timer = setTimeout(onFinish, 2000);
                return () => clearTimeout(timer);
            }, [onFinish]);

            const currentTheme = themes[theme] || themes.classic;

            return (
                <div style={{
                    minHeight: '100vh',
                    background: currentTheme.presentationBg,
                    display: 'flex',
                    flexDirection: 'column',
                    alignItems: 'center',
                    justifyContent: 'center',
                    animation: 'fadeIn 1s ease'
                }}>
                    <div style={{
                        width: '140px',
                        height: '140px',
                        borderRadius: theme === 'modern' ? '30px' : '50%',
                        background: `linear-gradient(135deg, ${currentTheme.primaryColor}, ${currentTheme.secondaryColor})`,
                        display: 'flex',
                        alignItems: 'center',
                        justifyContent: 'center',
                        fontSize: '5rem',
                        boxShadow: `0 0 60px ${currentTheme.primaryColor}66`,
                        marginBottom: '30px',
                        animation: 'pulse 2s infinite'
                    }}>
                        {currentTheme.icon}
                    </div>
                    <h1 style={{
                        color: currentTheme.primaryColor,
                        fontSize: '3rem',
                        marginBottom: '10px',
                        textAlign: 'center',
                        ...currentTheme.titleStyle
                    }}>
                        {data?.settings?.title || 'Ø§Ù„Ø¨Ø±Ù†Ø§Ù…Ø¬ Ø§Ù„ØªÙ†Ø´ÙŠØ·ÙŠ'}
                    </h1>
                    <p style={{
                        color: 'rgba(255, 255, 255, 0.6)',
                        fontSize: '1.2rem',
                        textAlign: 'center'
                    }}>
                        Ø§Ù„Ù…Ù†ØµØ© Ø§Ù„ØªØ­ÙÙŠØ²ÙŠØ©
                    </p>
                    <div className="poetry-line" style={{ marginTop: '40px', color: currentTheme.primaryColor }}>
                        {currentTheme.poetry}
                    </div>
                </div>
            );
        };
        
        // ==================== LOGIN SCREEN ====================
        const LoginScreen = ({ data, onLogin }) => {
            const [password, setPassword] = useState('');
            const [error, setError] = useState('');
            const [showPassword, setShowPassword] = useState(false);
            
            const handleLogin = () => {
                if (password === data.settings.supervisorPassword) {
                    onLogin('supervisor', {});
                    return;
                }
                
                for (const station of data.stations) {
                    const student = station.students.find(s => s.password === password);
                    if (student) {
                        onLogin('student', {
                            studentId: student.id,
                            stationId: station.id
                        });
                        return;
                    }
                }
                
                setError('Ø§Ù„Ø±Ù…Ø² Ø§Ù„Ø³Ø±ÙŠ ØºÙŠØ± ØµØ­ÙŠØ­');
                setTimeout(() => setError(''), 3000);
            };
            
            const handleKeyPress = (e) => {
                if (e.key === 'Enter') {
                    handleLogin();
                }
            };
            
            const currentTheme = themes[data.settings.theme] || themes.classic;
            
            return (
                <div style={{
                    minHeight: '100vh',
                    display: 'flex',
                    alignItems: 'center',
                    justifyContent: 'center',
                    padding: '20px',
                    animation: 'fadeIn 0.5s ease'
                }}>
                    <div className="card" style={{
                        width: '100%',
                        maxWidth: '400px',
                        padding: '30px',
                        textAlign: 'center'
                    }}>
                        <div style={{ marginBottom: '25px' }}>
                            <div style={{
                                width: '100px',
                                height: '100px',
                                background: `linear-gradient(135deg, ${data.settings.primaryColor}, ${data.settings.primaryColor}aa)`,
                                borderRadius: '50%',
                                display: 'flex',
                                alignItems: 'center',
                                justifyContent: 'center',
                                fontSize: '3.5rem',
                                margin: '0 auto 20px'
                            }}>
                                {data.settings.currencyIcon}
                            </div>
                            <h1 style={{
                                color: '#fff',
                                fontSize: '1.8rem',
                                marginBottom: '5px'
                            }}>
                                {data.settings.title}
                            </h1>
                            <p style={{ color: 'rgba(255, 255, 255, 0.6)' }}>
                                Ø£Ø¯Ø®Ù„ Ø§Ù„Ø±Ù…Ø² Ø§Ù„Ø³Ø±ÙŠ Ù„Ù„Ø¯Ø®ÙˆÙ„
                            </p>
                        </div>
                        
                        <div style={{ position: 'relative', marginBottom: '15px' }}>
                            <input
                                type={showPassword ? "text" : "password"}
                                value={password}
                                onChange={(e) => setPassword(e.target.value)}
                                onKeyPress={handleKeyPress}
                                placeholder="Ø§Ù„Ø±Ù…Ø² Ø§Ù„Ø³Ø±ÙŠ"
                                style={{
                                    width: '100%',
                                    padding: '15px 45px 15px 15px',
                                    fontSize: '1.1rem'
                                }}
                            />
                            <button
                                onClick={() => setShowPassword(!showPassword)}
                                style={{
                                    position: 'absolute',
                                    left: '15px',
                                    top: '50%',
                                    transform: 'translateY(-50%)',
                                    background: 'none',
                                    border: 'none',
                                    color: 'rgba(255, 255, 255, 0.5)',
                                    cursor: 'pointer',
                                    fontSize: '1.2rem'
                                }}
                            >
                                {showPassword ? 'ðŸ‘ï¸' : 'ðŸ‘ï¸â€ðŸ—¨ï¸'}
                            </button>
                        </div>
                        
                        {error && (
                            <div style={{
                                background: 'rgba(255, 82, 82, 0.1)',
                                border: '1px solid #FF5252',
                                borderRadius: '10px',
                                padding: '12px',
                                marginBottom: '15px',
                                color: '#FF5252',
                                textAlign: 'center',
                                animation: 'fadeIn 0.3s ease'
                            }}>
                                {error}
                            </div>
                        )}
                        
                        <button
                            onClick={handleLogin}
                            className="btn-primary"
                            style={{ width: '100%', padding: '15px', fontSize: '1.1rem' }}
                        >
                            Ø¯Ø®ÙˆÙ„
                        </button>

                        <div className="poetry-line" style={{ marginTop: '30px', fontSize: '0.9rem' }}>
                            {currentTheme.poetry}
                        </div>
                    </div>
                </div>
            );
        };
        
        // ==================== STUDENT DASHBOARD ====================
        const StudentDashboard = ({ student, station, data, setData, onLogout }) => {
            const [modal, setModal] = useState(null);
            const [newPassword, setNewPassword] = useState('');
            
            const rank = getRank(student.liters);
            const primaryColor = data.settings.primaryColor;
            const currency = data.settings.currency;
            
            const handlePasswordChange = () => {
                if (newPassword.length < 6) {
                    alert('ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± ÙŠØ¬Ø¨ Ø£Ù† ØªÙƒÙˆÙ† 6 Ø£Ø­Ø±Ù Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„');
                    return;
                }
                
                setData(prev => {
                    const newData = JSON.parse(JSON.stringify(prev));
                    for (const s of newData.stations) {
                        const studentIndex = s.students.findIndex(st => st.id === student.id);
                        if (studentIndex !== -1) {
                            s.students[studentIndex].password = newPassword;
                            break;
                        }
                    }
                    return newData;
                });
                
                setNewPassword('');
                setModal(null);
                alert('ØªÙ… ØªØºÙŠÙŠØ± ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ø¨Ù†Ø¬Ø§Ø­');
            };
            
            const confirmLogout = () => {
                if (window.confirm('Ù‡Ù„ ØªØ±ÙŠØ¯ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬ØŸ')) {
                    onLogout();
                }
            };
            
            return (
                <div style={{ minHeight: '100vh' }}>
                    <div className="header">
                        <div className="flex justify-between align-center">
                            <button
                                onClick={confirmLogout}
                                style={{
                                    background: 'none',
                                    border: 'none',
                                    color: '#fff',
                                    cursor: 'pointer',
                                    fontSize: '1rem'
                                }}
                            >
                                â† ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬
                            </button>
                            
                            <div className="flex gap-1">
                                <button
                                    onClick={() => setModal('news')}
                                    className="btn-primary btn-small"
                                >
                                    ðŸ“° Ø§Ù„Ø£Ø®Ø¨Ø§Ø±
                                </button>
                                <button
                                    onClick={() => setModal('password')}
                                    className="btn-secondary btn-small"
                                >
                                    ðŸ”‘ ØªØºÙŠÙŠØ± ÙƒÙ„Ù…Ø© Ø§Ù„Ø³Ø±
                                </button>
                            </div>
                        </div>
                    </div>
                    
                    <div className="container" style={{ paddingTop: '30px', paddingBottom: '50px' }}>
                        <div className="card card-highlight" style={{ marginBottom: '25px' }}>
                            <div className="flex align-center gap-3">
                                <div className="rank-badge" style={{ background: `linear-gradient(135deg, ${rank.color}, ${rank.color}aa)` }}>
                                    {rank.icon}
                                </div>
                                <div style={{ flex: 1 }}>
                                    <h2 style={{ color: '#fff', marginBottom: '5px' }}>
                                        Ù…Ø±Ø­Ø¨Ø§Ù‹ {student.name.split(' ')[0]} ðŸ‘‹
                                    </h2>
                                    <p style={{ color: station.color, marginBottom: '10px' }}>
                                        {station.name}
                                    </p>
                                </div>
                            </div>
                        </div>
                        
                        {!data.settings.pointsHidden ? (
                            <div className="grid grid-2 gap-2 mb-3">
                                <div className="card" style={{ textAlign: 'center' }}>
                                    <div style={{ fontSize: '2.5rem', fontWeight: '900', color: primaryColor, marginBottom: '5px' }}>
                                        {formatNumber(student.liters)}
                                    </div>
                                    <div style={{ color: 'rgba(255, 255, 255, 0.6)' }}>
                                        Ø±ØµÙŠØ¯Ùƒ Ø§Ù„Ø´Ø®ØµÙŠ ({currency})
                                    </div>
                                </div>
                                
                                <div className="card" style={{ textAlign: 'center' }}>
                                    <div style={{ fontSize: '2.5rem', fontWeight: '900', color: station.color, marginBottom: '5px' }}>
                                        {formatNumber(station.totalLiters)}
                                    </div>
                                    <div style={{ color: 'rgba(255, 255, 255, 0.6)' }}>
                                        Ø±ØµÙŠØ¯ Ø§Ù„Ø£Ø³Ø±Ø© ({currency})
                                    </div>
                                </div>
                            </div>
                        ) : (
                            <div className="card" style={{ 
                                background: 'rgba(255, 82, 82, 0.1)',
                                borderColor: '#FF5252',
                                textAlign: 'center',
                                padding: '30px',
                                marginBottom: '25px'
                            }}>
                                <div style={{ fontSize: '3rem', marginBottom: '15px' }}>
                                    ðŸ”’
                                </div>
                                <h3 style={{ color: '#FF5252', margin: 0 }}>
                                    ØªÙ… Ø¥Ø®ÙØ§Ø¡ Ø§Ù„Ù†Ù‚Ø§Ø· Ù…Ø¤Ù‚ØªØ§Ù‹
                                </h3>
                            </div>
                        )}
                        
                        {!data.settings.pointsHidden && (
                        <div className="card">
                            <h3 style={{ color: '#fff', marginBottom: '20px' }}>ðŸ“œ Ø³Ø¬Ù„ Ø§Ù„Ø¥Ù†Ø¬Ø§Ø²Ø§Øª</h3>
                            {student.achievements.length === 0 ? (
                                <div style={{ textAlign: 'center', padding: '40px', color: 'rgba(255, 255, 255, 0.5)' }}>
                                    <div style={{ fontSize: '3rem', marginBottom: '15px' }}>ðŸ“</div>
                                    <p>Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¥Ù†Ø¬Ø§Ø²Ø§Øª Ù…Ø³Ø¬Ù„Ø© Ø¨Ø¹Ø¯</p>
                                    <p style={{ fontSize: '0.9rem', marginTop: '10px' }}>
                                        Ø´Ø§Ø±Ùƒ ÙÙŠ Ø§Ù„Ø¨Ø±Ø§Ù…Ø¬ Ù„ØªØ±Ù‰ Ø¥Ù†Ø¬Ø§Ø²Ø§ØªÙƒ Ù‡Ù†Ø§!
                                    </p>
                                </div>
                            ) : (
                                <div style={{ maxHeight: '350px', overflowY: 'auto' }}>
                                    {[...student.achievements].reverse().map((achievement, index) => (
                                        <div
                                            key={index}
                                            style={{
                                                padding: '15px',
                                                background: 'rgba(255, 255, 255, 0.03)',
                                                borderRadius: '12px',
                                                marginBottom: '10px',
                                                borderRight: `4px solid ${achievement.liters >= 0 ? primaryColor : '#FF5252'}`
                                            }}
                                        >
                                            <div className="flex justify-between mb-2">
                                                <span style={{
                                                    color: achievement.liters >= 0 ? primaryColor : '#FF5252',
                                                    fontWeight: '700',
                                                    fontSize: '1.1rem'
                                                }}>
                                                    {achievement.liters >= 0 ? '+' : ''}{formatNumber(achievement.liters)} {currency}
                                                </span>
                                                <span style={{ color: 'rgba(255, 255, 255, 0.5)', fontSize: '0.85rem' }}>
                                                    {achievement.date}
                                                </span>
                                            </div>
                                            <p style={{ color: '#fff', margin: 0 }}>
                                                {achievement.description}
                                            </p>
                                        </div>
                                    ))}
                                </div>
                            )}
                        </div>
                        )}
                    </div>
                    
                    {modal === 'password' && (
                        <Modal onClose={() => setModal(null)}>
                            <h3 style={{ color: primaryColor, marginBottom: '20px', textAlign: 'center' }}>
                                ðŸ”‘ ØªØºÙŠÙŠØ± ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±
                            </h3>
                            <input
                                type="password"
                                value={newPassword}
                                onChange={(e) => setNewPassword(e.target.value)}
                                placeholder="ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø© (6 Ø£Ø­Ø±Ù Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„)"
                                style={{ width: '100%', marginBottom: '15px' }}
                            />
                            <div className="flex gap-2">
                                <button
                                    onClick={handlePasswordChange}
                                    className="btn-primary"
                                    style={{ flex: 1 }}
                                >
                                    Ø­ÙØ¸
                                </button>
                                <button
                                    onClick={() => setModal(null)}
                                    className="btn-secondary"
                                    style={{ flex: 1 }}
                                >
                                    Ø¥Ù„ØºØ§Ø¡
                                </button>
                            </div>
                        </Modal>
                    )}
                    
                    {modal === 'news' && (
                        <Modal onClose={() => setModal(null)}>
                            <h3 style={{ color: primaryColor, marginBottom: '20px', textAlign: 'center' }}>
                                ðŸ“° Ø§Ù„Ù†Ø´Ø±Ø© Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹ÙŠØ©
                            </h3>
                            {data.news.length === 0 ? (
                                <div style={{ textAlign: 'center', padding: '30px', color: 'rgba(255, 255, 255, 0.5)' }}>
                                    Ù„Ø§ ØªÙˆØ¬Ø¯ Ø£Ø®Ø¨Ø§Ø± Ø­Ø§Ù„ÙŠØ§Ù‹
                                </div>
                            ) : (
                                <div style={{ maxHeight: '300px', overflowY: 'auto' }}>
                                    {[...data.news].reverse().map((newsItem, index) => (
                                        <div
                                            key={index}
                                            style={{
                                                background: 'rgba(255, 255, 255, 0.05)',
                                                padding: '15px',
                                                borderRadius: '10px',
                                                marginBottom: '10px',
                                                borderRight: `3px solid ${primaryColor}`
                                            }}
                                        >
                                            <p style={{ color: '#fff', marginBottom: '5px' }}>
                                                {newsItem.content}
                                            </p>
                                            <span style={{ color: 'rgba(255, 255, 255, 0.5)', fontSize: '0.8rem' }}>
                                                {newsItem.date}
                                            </span>
                                        </div>
                                    ))}
                                </div>
                            )}
                            <button
                                onClick={() => setModal(null)}
                                className="btn-primary"
                                style={{ width: '100%', marginTop: '20px' }}
                            >
                                Ø¥ØºÙ„Ø§Ù‚
                            </button>
                        </Modal>
                    )}
                </div>
            );
        };
        
        // ==================== WEEKLY REPORT IMPORT MODAL (Excel) ====================
        const WeeklyReportImportModal = ({ data, setData, onClose }) => {
            const [importResult, setImportResult] = useState(null);
            const [loading, setLoading] = useState(false);

            const handleFileUpload = (e) => {
                const file = e.target.files[0];
                if (!file) return;

                setLoading(true);
                const reader = new FileReader();
                reader.onload = (evt) => {
                    try {
                        const bstr = evt.target.result;
                        const wb = XLSX.read(bstr, { type: 'binary' });
                        const wsname = wb.SheetNames[0];
                        const ws = wb.Sheets[wsname];
                        const rows = XLSX.utils.sheet_to_json(ws, { header: 1 });

                        // Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø£Ø¹Ù…Ø¯Ø© Ø§Ù„ØªÙ‚Ø±ÙŠØ±
                        let firstNameIdx = -1, familyNameIdx = -1, hifzIdx = -1, tathbeetIdx = -1, murajaIdx = -1;

                        for (let r = 0; r < Math.min(rows.length, 5); r++) {
                            const row = rows[r];
                            row.forEach((cell, idx) => {
                                if (typeof cell !== 'string') return;
                                if (cell.includes('Ø§Ù„Ø¥Ø³Ù… Ø§Ù„Ø£ÙˆÙ„') || cell.includes('Ø§Ù„Ø§Ø³Ù… Ø§Ù„Ø£ÙˆÙ„')) firstNameIdx = idx;
                                if (cell.includes('Ø§Ø³Ù… Ø§Ù„Ø¹Ø§Ø¦Ù„Ø©')) familyNameIdx = idx;
                                if (cell.includes('Ù†Ø³Ø¨Ø© Ø¥Ù†Ø¬Ø§Ø² Ø§Ù„Ø­ÙØ¸')) hifzIdx = idx;
                                if (cell.includes('Ù†Ø³Ø¨Ø© Ø¥Ù†Ø¬Ø§Ø² Ø§Ù„ØªØ«Ø¨ÙŠØª')) tathbeetIdx = idx;
                                if (cell.includes('Ù†Ø³Ø¨Ø© Ø¥Ù†Ø¬Ø§Ø² Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹Ø©')) murajaIdx = idx;
                            });
                            if (firstNameIdx !== -1 && familyNameIdx !== -1) break;
                        }

                        if (firstNameIdx === -1 || familyNameIdx === -1 || hifzIdx === -1 || tathbeetIdx === -1 || murajaIdx === -1) {
                            alert('Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø§Ù„Ø£Ø¹Ù…Ø¯Ø© Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø©. ØªØ£ÙƒØ¯ Ù…Ù† Ø£Ù† Ø§Ù„Ø£Ø¹Ù…Ø¯Ø©: Ø§Ù„Ø¥Ø³Ù… Ø§Ù„Ø£ÙˆÙ„, Ø§Ø³Ù… Ø§Ù„Ø¹Ø§Ø¦Ù„Ø©, Ù†Ø³Ø¨Ø© Ø¥Ù†Ø¬Ø§Ø² Ø§Ù„Ø­ÙØ¸, Ù†Ø³Ø¨Ø© Ø¥Ù†Ø¬Ø§Ø² Ø§Ù„ØªØ«Ø¨ÙŠØª, Ù†Ø³Ø¨Ø© Ø¥Ù†Ø¬Ø§Ø² Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹Ø©');
                            setLoading(false);
                            return;
                        }

                        if (!window.confirm('Ø³ÙŠØªÙ… Ø¥Ø¶Ø§ÙØ© Ù†Ù‚Ø§Ø· Ø§Ù„Ø­ÙØ¸ + Ø§Ù„ØªØ«Ø¨ÙŠØª + Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹Ø© Ù„Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø·Ù„Ø§Ø¨ Ø§Ù„Ù…ÙˆØ¬ÙˆØ¯ÙŠÙ† ÙÙŠ Ø§Ù„Ù…Ù„Ù. Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ØŸ')) {
                            setLoading(false);
                            return;
                        }

                        setData(prev => {
                            const newData = JSON.parse(JSON.stringify(prev));
                            if (!newData.archive) newData.archive = [];
                            const dateStr = formatDate();
                            const timeStr = new Date().toLocaleTimeString('ar-SA');

                            let updatedCount = 0;
                            let notFound = [];

                            for (let i = 1; i < rows.length; i++) {
                                const row = rows[i];
                                if (!row[firstNameIdx] || !row[familyNameIdx]) continue;

                                const firstName = row[firstNameIdx].toString().trim();
                                const familyName = row[familyNameIdx].toString().trim();
                                const fullName = firstName + ' ' + familyName;

                                const hifz = parsePercentage(row[hifzIdx]);
                                const tathbeet = parsePercentage(row[tathbeetIdx]);
                                const muraja = parsePercentage(row[murajaIdx]);

                                const totalPoints = Math.round(hifz + tathbeet + muraja);
                                if (totalPoints === 0) continue;

                                // Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø§Ù„Ø·Ø§Ù„Ø¨ Ø¨Ø§Ù„Ø§Ø³Ù… Ø§Ù„ÙƒØ§Ù…Ù„
                                let found = false;
                                for (const station of newData.stations) {
                                    const student = station.students.find(s => s.name.trim() === fullName);
                                    if (student) {
                                        student.liters += totalPoints;
                                        student.achievements.push({
                                            liters: totalPoints,
                                            description: 'ØªÙ‚Ø±ÙŠØ± Ø£Ø³Ø¨ÙˆØ¹ÙŠ (Ø­ÙØ¸ + ØªØ«Ø¨ÙŠØª + Ù…Ø±Ø§Ø¬Ø¹Ø©)',
                                            date: dateStr
                                        });

                                        station.totalLiters += Math.floor(totalPoints * FAMILY_PERCENTAGE);

                                        newData.archive.push({
                                            id: Date.now() + Math.random(),
                                            type: 'student',
                                            targetName: student.name,
                                            points: totalPoints,
                                            description: 'Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ù…Ù† Ø§Ù„ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹ÙŠ',
                                            date: dateStr,
                                            timestamp: timeStr
                                        });

                                        updatedCount++;
                                        found = true;
                                        break;
                                    }
                                }
                                if (!found) {
                                    notFound.push(fullName);
                                }
                            }

                            setImportResult({ updated: updatedCount, notFound });
                            setLoading(false);
                            alert(`ØªÙ… ØªØ­Ø¯ÙŠØ« ${updatedCount} Ø·Ø§Ù„Ø¨ Ø¨Ù†Ø¬Ø§Ø­. ${notFound.length > 0 ? 'Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰: ' + notFound.join(', ') : ''}`);
                            onClose(); // Ù†ØºÙ„Ù‚ Ø§Ù„Ù…ÙˆØ¯Ø§Ù„ Ø¨Ø¹Ø¯ Ø§Ù„Ø§Ù†ØªÙ‡Ø§Ø¡
                            return newData;
                        });
                    } catch (err) {
                        console.error(err);
                        alert('Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ù‚Ø±Ø§Ø¡Ø© Ø§Ù„Ù…Ù„Ù: ' + err.message);
                        setLoading(false);
                    }
                };
                reader.readAsBinaryString(file);
            };

            return (
                <Modal onClose={onClose} wide>
                    <h3 style={{ color: '#D4AF37', marginBottom: '20px', textAlign: 'center' }}>
                        ðŸ“Š Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ø§Ù„ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹ÙŠ
                    </h3>
                    <div className="card" style={{ textAlign: 'center', padding: '30px', border: '2px dashed #D4AF37' }}>
                        <p style={{ marginBottom: '15px' }}>
                            ÙŠØ±Ø¬Ù‰ Ø±ÙØ¹ Ù…Ù„Ù Excel Ø¨Ø§Ù„ØªÙ†Ø³ÙŠÙ‚ Ø§Ù„ØªØ§Ù„ÙŠ:<br/>
                            <strong>Ø§Ù„Ø¥Ø³Ù… Ø§Ù„Ø£ÙˆÙ„ - Ø§Ø³Ù… Ø§Ù„Ø¹Ø§Ø¦Ù„Ø© - Ù†Ø³Ø¨Ø© Ø¥Ù†Ø¬Ø§Ø² Ø§Ù„Ø­ÙØ¸ - Ù†Ø³Ø¨Ø© Ø¥Ù†Ø¬Ø§Ø² Ø§Ù„ØªØ«Ø¨ÙŠØª - Ù†Ø³Ø¨Ø© Ø¥Ù†Ø¬Ø§Ø² Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹Ø©</strong>
                        </p>
                        <input 
                            type="file" 
                            accept=".xlsx, .xls, .csv" 
                            onChange={handleFileUpload} 
                            disabled={loading}
                        />
                        {loading && <p style={{ marginTop: '15px' }}>Ø¬Ø§Ø±ÙŠ Ø§Ù„Ù…Ø¹Ø§Ù„Ø¬Ø©...</p>}
                    </div>
                </Modal>
            );
        };
        
        // ==================== SUPERVISOR DASHBOARD ====================
        const SupervisorDashboard = ({ data, setData, onLogout }) => {
            const [view, setView] = useState('overview');
            const [isMenuOpen, setIsMenuOpen] = useState(false);
            const [selectedStation, setSelectedStation] = useState(null);
            const [selectedStudent, setSelectedStudent] = useState(null);
            const [modal, setModal] = useState(null);
            const [quickPoints, setQuickPoints] = useState('');
            const [quickDescription, setQuickDescription] = useState('');
            const [isDeduction, setIsDeduction] = useState(false);
            const [newsContent, setNewsContent] = useState('');
            const [selectedProgram, setSelectedProgram] = useState(null);
            const [criteriaScores, setCriteriaScores] = useState({});
            const [freeProgramScore, setFreeProgramScore] = useState(0);
            
            const primaryColor = data.settings.primaryColor;
            const currency = data.settings.currency;
            
            const calculateProgramScore = (program) => {
                if (program.free || !program.criteria || program.criteria.length === 0) {
                    return freeProgramScore || 0;
                }
                
                const total = program.criteria.reduce((sum, criterion) => {
                    const score = criteriaScores[criterion.name] || 0;
                    return sum + score * (criterion.pct / 100);
                }, 0);
                
                return Math.round(total) || 0;
            };
            
            const calculateLiters = (program) => {
                const score = calculateProgramScore(program);
                if (program.free || !program.criteria || program.criteria.length === 0) {
                    return freeProgramScore || 0;
                }
                return Math.round(score * program.max / 100) || 0;
            };
            
            const addPoints = (points, description, isFamily = false, isQuick = false) => {
                setData(prev => {
                    const newData = JSON.parse(JSON.stringify(prev));
                    if (!newData.archive) newData.archive = [];
                    
                    let targetName = '';

                    if (isFamily && selectedStation) {
                        const stationIndex = newData.stations.findIndex(s => s.id === selectedStation.id);
                        newData.stations[stationIndex].totalLiters += points;
                        
                        newData.stations[stationIndex].familyAchievements.push({
                            liters: points,
                            description: description,
                            date: formatDate()
                        });
                        targetName = selectedStation.name;
                    } else if (selectedStudent && selectedStation) {
                        const stationIndex = newData.stations.findIndex(s => s.id === selectedStation.id);
                        const studentIndex = newData.stations[stationIndex].students.findIndex(s => s.id === selectedStudent.id);
                        
                        newData.stations[stationIndex].students[studentIndex].liters += points;
                        
                        newData.stations[stationIndex].students[studentIndex].achievements.push({
                            liters: points,
                            description: description,
                            date: formatDate()
                        });
                        
                        if (points > 0) {
                            newData.stations[stationIndex].totalLiters += Math.floor(points * FAMILY_PERCENTAGE);
                        }
                        targetName = selectedStudent.name;
                    }
                    
                    if (targetName) {
                        let type;
                        if (isQuick) {
                            type = 'quick';
                        } else {
                            type = isFamily ? 'family' : 'student';
                        }

                        newData.archive.push({
                            id: Date.now(),
                            type: type,
                            targetName: targetName,
                            points: points,
                            description: description,
                            date: formatDate(),
                            timestamp: new Date().toLocaleTimeString('ar-SA')
                        });
                    }
                    
                    return newData;
                });
            };
            
            const handleQuickPoints = (isFamily = false) => {
                const points = parseInt(quickPoints) || 0;
                if (points <= 0) return;
                
                const finalPoints = isDeduction ? -points : points;
                const description = quickDescription || (isDeduction ? 'Ø®ØµÙ…' : 'Ù…ÙƒØ§ÙØ£Ø©');
                
                addPoints(finalPoints, description, isFamily, true);
                
                setQuickPoints('');
                setQuickDescription('');
                setIsDeduction(false);
                setModal(null);
            };
            
            const handleProgramSubmit = (isFamily = false) => {
                if (!selectedProgram) return;
                
                const liters = calculateLiters(selectedProgram.program);
                const description = selectedProgram.program.name;
                
                addPoints(liters, description, isFamily, false);
                
                setSelectedProgram(null);
                setCriteriaScores({});
                setFreeProgramScore(0);
                setModal(null);
            };
            
            const addNews = () => {
                if (!newsContent.trim()) return;
                
                setData(prev => ({
                    ...prev,
                    news: [
                        ...prev.news,
                        {
                            id: Date.now(),
                            content: newsContent.trim(),
                            date: formatDate()
                        }
                    ]
                }));
                
                setNewsContent('');
            };
            
            const deleteNews = (id) => {
                setData(prev => ({
                    ...prev,
                    news: prev.news.filter(item => item.id !== id)
                }));
            };
            
            const renderOverview = () => (
                <div style={{ padding: '20px' }}>
                    <h2 style={{ color: primaryColor, marginBottom: '25px', textAlign: 'center' }}>
                        ðŸ™ï¸ Ù†Ø¸Ø±Ø© Ø¹Ø§Ù…Ø© Ø¹Ù„Ù‰ Ø§Ù„Ù…Ø­Ø·Ø§Øª
                    </h2>
                    
                    <div className="grid grid-3 gap-3">
                        {data.stations.map(station => (
                            <div
                                key={station.id}
                                className="card"
                                onClick={() => {
                                    setSelectedStation(station);
                                    setView('station');
                                }}
                                style={{
                                    cursor: 'pointer',
                                    textAlign: 'center',
                                    transition: 'transform 0.3s'
                                }}
                                onMouseEnter={(e) => e.currentTarget.style.transform = 'translateY(-5px)'}
                                onMouseLeave={(e) => e.currentTarget.style.transform = 'translateY(0)'}
                            >
                                <div style={{
                                    width: '80px',
                                    height: '80px',
                                    borderRadius: '50%',
                                    background: station.color,
                                    display: 'flex',
                                    alignItems: 'center',
                                    justifyContent: 'center',
                                    fontSize: '2rem',
                                    margin: '0 auto 15px'
                                }}>
                                    â­
                                </div>
                                <h3 style={{ color: station.color, marginBottom: '10px' }}>
                                    {station.name}
                                </h3>
                                <div style={{ fontSize: '1.5rem', fontWeight: '900', color: '#fff', marginBottom: '5px' }}>
                                    {formatNumber(station.totalLiters)}
                                </div>
                                <div style={{ color: 'rgba(255, 255, 255, 0.6)' }}>
                                    {station.students.length} Ø·Ø§Ù„Ø¨
                                </div>
                            </div>
                        ))}
                    </div>
                </div>
            );
            
            const renderStation = () => {
                if (!selectedStation) return renderOverview();
                
                return (
                    <div style={{ padding: '20px' }}>
                        <div className="flex justify-between align-center mb-3">
                            <button
                                onClick={() => {
                                    setSelectedStation(null);
                                    setView('overview');
                                }}
                                className="btn-secondary"
                            >
                                â† Ø§Ù„Ø¹ÙˆØ¯Ø©
                            </button>
                            <h2 style={{ color: selectedStation.color, margin: 0 }}>
                                {selectedStation.name}
                            </h2>
                            <div style={{ color: primaryColor, fontWeight: '700' }}>
                                {formatNumber(selectedStation.totalLiters)} {currency}
                            </div>
                        </div>
                        
                        <div className="flex gap-2 mb-3" style={{ justifyContent: 'center' }}>
                            <button
                                onClick={() => {
                                    setIsDeduction(false);
                                    setModal('quickFamily');
                                }}
                                className="btn-success"
                            >
                                âž• Ø¥Ø¶Ø§ÙØ© Ù†Ù‚Ø§Ø· Ù„Ù„Ø£Ø³Ø±Ø©
                            </button>
                            <button
                                onClick={() => {
                                    setIsDeduction(true);
                                    setModal('quickFamily');
                                }}
                                className="btn-danger"
                            >
                                âž– Ø®ØµÙ… Ù†Ù‚Ø§Ø· Ù…Ù† Ø§Ù„Ø£Ø³Ø±Ø©
                            </button>
                            <button
                                onClick={() => setModal('familyPrograms')}
                                className="btn-primary"
                            >
                                ðŸ  ØªÙ‚ÙŠÙŠÙ… Ø¨Ø±Ø§Ù…Ø¬ Ø£Ø³Ø±ÙŠØ©
                            </button>
                        </div>
                        
                        <h3 style={{ color: '#fff', marginBottom: '15px' }}>ðŸ‘¥ Ø·Ù„Ø§Ø¨ Ø§Ù„Ù…Ø­Ø·Ø©</h3>
                        <div className="grid gap-2" style={{ maxHeight: '500px', overflowY: 'auto' }}>
                            {selectedStation.students.map(student => {
                                const rank = getRank(student.liters);
                                return (
                                    <div
                                        key={student.id}
                                        className="card"
                                        style={{
                                            display: 'flex',
                                            justifyContent: 'space-between',
                                            alignItems: 'center'
                                        }}
                                    >
                                        <div className="flex align-center gap-2">
                                            <div style={{
                                                width: '45px',
                                                height: '45px',
                                                borderRadius: '50%',
                                                background: rank.color,
                                                display: 'flex',
                                                alignItems: 'center',
                                                justifyContent: 'center',
                                                fontSize: '1.2rem'
                                            }}>
                                                {rank.icon}
                                            </div>
                                            <div>
                                                <div style={{ color: '#fff', fontWeight: '600' }}>
                                                    {student.name}
                                                </div>
                                                <div style={{ color: primaryColor, fontSize: '0.9rem' }}>
                                                    {formatNumber(student.liters)} {currency}
                                                </div>
                                            </div>
                                        </div>
                                        
                                        <div className="flex gap-1">
                                            <button
                                                onClick={() => {
                                                    setSelectedStudent(student);
                                                    setIsDeduction(false);
                                                    setModal('quickStudent');
                                                }}
                                                className="btn-success btn-small"
                                            >
                                                âž•
                                            </button>
                                            <button
                                                onClick={() => {
                                                    setSelectedStudent(student);
                                                    setIsDeduction(true);
                                                    setModal('quickStudent');
                                                }}
                                                className="btn-danger btn-small"
                                            >
                                                âž–
                                            </button>
                                            <button
                                                onClick={() => {
                                                    setSelectedStudent(student);
                                                    setModal('studentPrograms');
                                                }}
                                                className="btn-primary btn-small"
                                            >
                                                ðŸ“
                                            </button>
                                        </div>
                                    </div>
                                );
                            })}
                        </div>
                    </div>
                );
            };
            
            const renderContent = () => {
                switch(view) {
                    case 'overview': return renderOverview();
                    case 'station': return renderStation();
                    default: return renderOverview();
                }
            };
            
            return (
                <div style={{ minHeight: '100vh' }}>
                    <div className="header">
                        <div className="flex justify-between align-center">
                            <h1 style={{ color: primaryColor, margin: 0, fontSize: '1.3rem' }}>
                                ðŸ”§ Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ… - Ø§Ù„Ù…Ø´Ø±Ù
                            </h1>
                            
                            {/* Desktop Menu */}
                            <div className="desktop-menu flex gap-1">
                                <button
                                    onClick={() => setModal('weeklyReport')}
                                    className="btn-excel btn-small"
                                >
                                    ðŸ“Š Ø§Ø³ØªÙŠØ±Ø§Ø¯ ØªÙ‚Ø±ÙŠØ± Ø£Ø³Ø¨ÙˆØ¹ÙŠ
                                </button>
                                <button
                                    onClick={() => setModal('halqa')}
                                    className="btn-primary btn-small"
                                    style={{ background: '#FF9800', color: '#fff' }}
                                >
                                    â­• Ø±ØµØ¯ Ø§Ù„Ø­Ù„Ù‚Ø©
                                </button>
                                <button
                                    onClick={() => setModal('assignments')}
                                    className="btn-primary btn-small"
                                    style={{ background: '#9C27B0', color: '#fff' }}
                                >
                                    ðŸ“© ØªÙƒÙ„ÙŠÙ
                                </button>
                                <button
                                    onClick={() => setModal('assignmentsArchive')}
                                    className="btn-secondary btn-small"
                                >
                                    ðŸ“ Ø£Ø±Ø´ÙŠÙ Ø§Ù„ØªÙƒØ§Ù„ÙŠÙ
                                </button>
                                <button
                                    onClick={() => setModal('achievements')}
                                    className="btn-success btn-small"
                                >
                                    âœ… Ø¥Ù†Ø¬Ø§Ø² Ø§Ù„Ø·Ù„Ø§Ø¨
                                </button>
                                <button
                                    onClick={() => setModal('archive')}
                                    className="btn-secondary btn-small"
                                >
                                    ðŸ“ Ø§Ù„Ø£Ø±Ø´ÙŠÙ
                                </button>
                                <button
                                    onClick={() => setModal('news')}
                                    className="btn-secondary btn-small"
                                >
                                    ðŸ“° Ø§Ù„Ø£Ø®Ø¨Ø§Ø±
                                </button>
                                <button
                                    onClick={() => setModal('students')}
                                    className="btn-secondary btn-small"
                                >
                                    ðŸ‘¥ Ø§Ù„Ø·Ù„Ø§Ø¨
                                </button>
                                <button
                                    onClick={() => setModal('report')}
                                    className="btn-success btn-small"
                                >
                                    ðŸ“Š Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ±
                                </button>
                                <button
                                    onClick={() => setModal('settings')}
                                    className="btn-secondary btn-small"
                                >
                                    âš™ï¸ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª
                                </button>
                                <button
                                    onClick={onLogout}
                                    className="btn-danger btn-small"
                                >
                                    ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬
                                </button>
                            </div>

                            {/* Mobile Menu Toggle */}
                            <button 
                                className="mobile-menu-btn"
                                onClick={() => setIsMenuOpen(!isMenuOpen)}
                            >
                                {isMenuOpen ? 'âœ•' : 'â˜°'}
                            </button>
                        </div>
                        
                        {/* Mobile Menu Dropdown */}
                        {isMenuOpen && (
                            <div className="mobile-menu-overlay">
                                <button onClick={() => { setModal('weeklyReport'); setIsMenuOpen(false); }} className="btn-excel">ðŸ“Š Ø§Ø³ØªÙŠØ±Ø§Ø¯ ØªÙ‚Ø±ÙŠØ± Ø£Ø³Ø¨ÙˆØ¹ÙŠ</button>
                                <button onClick={() => { setModal('halqa'); setIsMenuOpen(false); }} className="btn-secondary" style={{ background: '#FF9800', color: '#fff' }}>â­• Ø±ØµØ¯ Ø§Ù„Ø­Ù„Ù‚Ø©</button>
                                <button onClick={() => { setModal('assignments'); setIsMenuOpen(false); }} className="btn-secondary" style={{ background: '#9C27B0', color: '#fff' }}>ðŸ“© ØªÙƒÙ„ÙŠÙ</button>
                                <button onClick={() => { setModal('assignmentsArchive'); setIsMenuOpen(false); }} className="btn-secondary">ðŸ“ Ø£Ø±Ø´ÙŠÙ Ø§Ù„ØªÙƒØ§Ù„ÙŠÙ</button>
                                <button onClick={() => { setModal('achievements'); setIsMenuOpen(false); }} className="btn-secondary">âœ… Ø¥Ù†Ø¬Ø§Ø² Ø§Ù„Ø·Ù„Ø§Ø¨</button>
                                <button onClick={() => { setModal('archive'); setIsMenuOpen(false); }} className="btn-secondary">ðŸ“ Ø§Ù„Ø£Ø±Ø´ÙŠÙ</button>
                                <button onClick={() => { setModal('news'); setIsMenuOpen(false); }} className="btn-secondary">ðŸ“° Ø§Ù„Ø£Ø®Ø¨Ø§Ø±</button>
                                <button onClick={() => { setModal('students'); setIsMenuOpen(false); }} className="btn-secondary">ðŸ‘¥ Ø§Ù„Ø·Ù„Ø§Ø¨</button>
                                <button onClick={() => { setModal('report'); setIsMenuOpen(false); }} className="btn-success">ðŸ“Š Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ±</button>
                                <button onClick={() => { setModal('settings'); setIsMenuOpen(false); }} className="btn-secondary">âš™ï¸ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª</button>
                                <button onClick={onLogout} className="btn-danger">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬</button>
                            </div>
                        )}
                    </div>
                    
                    {renderContent()}
                    
                    {modal === 'halqa' && <HalqaMonitoringModal data={data} setData={setData} onClose={() => setModal(null)} addPoints={addPoints} />}
                    {modal === 'assignments' && <AssignmentsSystem data={data} setData={setData} onClose={() => setModal(null)} />}
                    {modal === 'assignmentsArchive' && <AssignmentsArchiveViewer data={data} onClose={() => setModal(null)} />}
                    {modal === 'achievements' && <AchievementsViewer data={data} onClose={() => setModal(null)} />}
                    {modal === 'weeklyReport' && <WeeklyReportImportModal data={data} setData={setData} onClose={() => setModal(null)} />}

                    {modal === 'quickStudent' && (
                        <Modal onClose={() => setModal(null)}>
                            <h3 style={{ color: isDeduction ? '#FF5252' : '#00C853', textAlign: 'center', marginBottom: '15px' }}>
                                {isDeduction ? 'âž– Ø®ØµÙ… Ù†Ù‚Ø§Ø·' : 'âž• Ø¥Ø¶Ø§ÙØ© Ù†Ù‚Ø§Ø·'} Ù„Ù„Ø·Ø§Ù„Ø¨
                            </h3>
                            <p style={{ color: '#fff', textAlign: 'center', marginBottom: '20px' }}>
                                {selectedStudent?.name}
                            </p>
                            
                            <input
                                type="number"
                                value={quickPoints}
                                onChange={(e) => setQuickPoints(e.target.value)}
                                placeholder={`Ø¹Ø¯Ø¯ ${currency}`}
                                style={{
                                    width: '100%',
                                    fontSize: '1.5rem',
                                    textAlign: 'center',
                                    marginBottom: '15px',
                                    color: isDeduction ? '#FF5252' : '#00C853'
                                }}
                            />
                            
                            <input
                                value={quickDescription}
                                onChange={(e) => setQuickDescription(e.target.value)}
                                placeholder="Ø§Ù„Ø³Ø¨Ø¨ (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)"
                                style={{ width: '100%', marginBottom: '20px' }}
                            />
                            
                            <div className="flex gap-2">
                                <button
                                    onClick={() => handleQuickPoints(false)}
                                    style={{
                                        flex: 1,
                                        background: isDeduction ? '#FF5252' : '#00C853',
                                        color: '#fff'
                                    }}
                                >
                                    {isDeduction ? 'Ø®ØµÙ…' : 'Ø¥Ø¶Ø§ÙØ©'}
                                </button>
                                <button
                                    onClick={() => setModal(null)}
                                    className="btn-secondary"
                                    style={{ flex: 1 }}
                                >
                                    Ø¥Ù„ØºØ§Ø¡
                                </button>
                            </div>
                        </Modal>
                    )}
                    
                    {modal === 'quickFamily' && (
                        <Modal onClose={() => setModal(null)}>
                            <h3 style={{ color: isDeduction ? '#FF5252' : '#00C853', textAlign: 'center', marginBottom: '15px' }}>
                                {isDeduction ? 'âž– Ø®ØµÙ… Ù†Ù‚Ø§Ø·' : 'âž• Ø¥Ø¶Ø§ÙØ© Ù†Ù‚Ø§Ø·'} Ù„Ù„Ø£Ø³Ø±Ø©
                            </h3>
                            <p style={{ color: '#fff', textAlign: 'center', marginBottom: '20px' }}>
                                {selectedStation?.name}
                            </p>
                            
                            <input
                                type="number"
                                value={quickPoints}
                                onChange={(e) => setQuickPoints(e.target.value)}
                                placeholder={`Ø¹Ø¯Ø¯ ${currency}`}
                                style={{
                                    width: '100%',
                                    fontSize: '1.5rem',
                                    textAlign: 'center',
                                    marginBottom: '15px',
                                    color: isDeduction ? '#FF5252' : '#00C853'
                                }}
                            />
                            
                            <input
                                value={quickDescription}
                                onChange={(e) => setQuickDescription(e.target.value)}
                                placeholder="Ø§Ù„Ø³Ø¨Ø¨ (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)"
                                style={{ width: '100%', marginBottom: '20px' }}
                            />
                            
                            <div className="flex gap-2">
                                <button
                                    onClick={() => handleQuickPoints(true)}
                                    style={{
                                        flex: 1,
                                        background: isDeduction ? '#FF5252' : '#00C853',
                                        color: '#fff'
                                    }}
                                >
                                    {isDeduction ? 'Ø®ØµÙ…' : 'Ø¥Ø¶Ø§ÙØ©'}
                                </button>
                                <button
                                    onClick={() => setModal(null)}
                                    className="btn-secondary"
                                    style={{ flex: 1 }}
                                >
                                    Ø¥Ù„ØºØ§Ø¡
                                </button>
                            </div>
                        </Modal>
                    )}
                    
                    {modal === 'news' && (
                        <Modal onClose={() => setModal(null)}>
                            <h3 style={{ color: primaryColor, marginBottom: '20px', textAlign: 'center' }}>
                                ðŸ“° Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø£Ø®Ø¨Ø§Ø±
                            </h3>
                            
                            <textarea
                                value={newsContent}
                                onChange={(e) => setNewsContent(e.target.value)}
                                placeholder="Ø§ÙƒØªØ¨ Ø®Ø¨Ø±Ø§Ù‹ Ø¬Ø¯ÙŠØ¯Ø§Ù‹..."
                                rows="4"
                                style={{ width: '100%', marginBottom: '15px' }}
                            />
                            
                            <button
                                onClick={addNews}
                                className="btn-primary"
                                style={{ width: '100%', marginBottom: '20px' }}
                            >
                                Ù†Ø´Ø± Ø§Ù„Ø®Ø¨Ø±
                            </button>
                            
                            <h4 style={{ color: '#fff', marginBottom: '15px' }}>Ø§Ù„Ø£Ø®Ø¨Ø§Ø± Ø§Ù„Ù…Ù†Ø´ÙˆØ±Ø©</h4>
                            <div style={{ maxHeight: '250px', overflowY: 'auto' }}>
                                {data.news.length === 0 ? (
                                    <p style={{ color: 'rgba(255, 255, 255, 0.5)', textAlign: 'center' }}>
                                        Ù„Ø§ ØªÙˆØ¬Ø¯ Ø£Ø®Ø¨Ø§Ø± Ù…Ù†Ø´ÙˆØ±Ø©
                                    </p>
                                ) : (
                                    [...data.news].reverse().map((item, index) => (
                                        <div
                                            key={item.id}
                                            style={{
                                                background: 'rgba(255, 255, 255, 0.05)',
                                                padding: '12px',
                                                borderRadius: '8px',
                                                marginBottom: '10px',
                                                display: 'flex',
                                                justifyContent: 'space-between',
                                                alignItems: 'flex-start'
                                            }}
                                        >
                                            <div style={{ flex: 1 }}>
                                                <p style={{ color: '#fff', margin: '0 0 5px 0', fontSize: '0.9rem' }}>
                                                    {item.content}
                                                </p>
                                                <span style={{ color: 'rgba(255, 255, 255, 0.5)', fontSize: '0.8rem' }}>
                                                    {item.date}
                                                </span>
                                            </div>
                                            <button
                                                onClick={() => deleteNews(item.id)}
                                                className="btn-danger btn-small"
                                                style={{ marginLeft: '10px' }}
                                            >
                                                Ø­Ø°Ù
                                            </button>
                                        </div>
                                    ))
                                )}
                            </div>
                            
                            <button
                                onClick={() => setModal(null)}
                                className="btn-secondary"
                                style={{ width: '100%', marginTop: '20px' }}
                            >
                                Ø¥ØºÙ„Ø§Ù‚
                            </button>
                        </Modal>
                    )}

                    {modal === 'archive' && (
                        <Modal onClose={() => setModal(null)} wide>
                            <h3 style={{ color: primaryColor, marginBottom: '20px', textAlign: 'center' }}>
                                ðŸ“ Ø³Ø¬Ù„ Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª (Ø§Ù„Ø£Ø±Ø´ÙŠÙ)
                            </h3>
                            
                            <div>
                                {(!data.archive || data.archive.length === 0) ? (
                                    <p style={{ color: 'rgba(255, 255, 255, 0.5)', textAlign: 'center', padding: '20px' }}>
                                        Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¹Ù…Ù„ÙŠØ§Øª Ù…Ø³Ø¬Ù„Ø© ÙÙŠ Ø§Ù„Ø£Ø±Ø´ÙŠÙ
                                    </p>
                                ) : (
                                    <table style={{ width: '100%', borderCollapse: 'collapse', color: '#fff' }}>
                                        <thead>
                                            <tr style={{ borderBottom: '1px solid rgba(255, 255, 255, 0.2)', textAlign: 'right' }}>
                                                <th style={{ padding: '10px' }}>Ø§Ù„ØªØ§Ø±ÙŠØ®</th>
                                                <th style={{ padding: '10px' }}>Ø§Ù„Ù†ÙˆØ¹</th>
                                                <th style={{ padding: '10px' }}>Ø§Ù„Ø§Ø³Ù…</th>
                                                <th style={{ padding: '10px' }}>Ø§Ù„Ù†Ù‚Ø§Ø·</th>
                                                <th style={{ padding: '10px' }}>Ø§Ù„Ø¨ÙŠØ§Ù†</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            {[...data.archive].reverse().map((log, index) => (
                                                <tr key={index} style={{ borderBottom: '1px solid rgba(255, 255, 255, 0.05)' }}>
                                                    <td style={{ padding: '10px', fontSize: '0.9rem', color: 'rgba(255, 255, 255, 0.6)' }}>
                                                        {log.date} {log.timestamp}
                                                    </td>
                                                    <td style={{ padding: '10px' }}>
                                                        {log.type === 'family' ? 'ðŸ  Ø£Ø³Ø±Ø©' : log.type === 'quick' ? 'âš¡ Ø¨Ø¯ÙˆÙ† Ø¨Ø±Ù†Ø§Ù…Ø¬' : 'ðŸ‘¤ Ø·Ø§Ù„Ø¨'}
                                                    </td>
                                                    <td style={{ padding: '10px', fontWeight: 'bold' }}>
                                                        {log.targetName}
                                                    </td>
                                                    <td style={{ 
                                                        padding: '10px', 
                                                        color: log.points >= 0 ? '#00C853' : '#FF5252',
                                                        fontWeight: 'bold',
                                                        direction: 'ltr',
                                                        textAlign: 'right'
                                                    }}>
                                                        {log.points > 0 ? '+' : ''}{log.points}
                                                    </td>
                                                    <td style={{ padding: '10px', fontSize: '0.9rem' }}>
                                                        {log.description}
                                                    </td>
                                                </tr>
                                            ))}
                                        </tbody>
                                    </table>
                                )}
                            </div>
                            
                            <button
                                onClick={() => setModal(null)}
                                className="btn-secondary"
                                style={{ width: '100%', marginTop: '20px' }}
                            >
                                Ø¥ØºÙ„Ø§Ù‚
                            </button>
                        </Modal>
                    )}
                    
                    {modal === 'students' && (
                        <StudentsModal data={data} setData={setData} onClose={() => setModal(null)} />
                    )}
                    
                    {modal === 'settings' && (
                        <SettingsModal data={data} setData={setData} onClose={() => setModal(null)} />
                    )}
                    
                    {modal === 'report' && (
                        <ReportModal data={data} onClose={() => setModal(null)} />
                    )}
                    
                    {(modal === 'familyPrograms' || modal === 'studentPrograms') && (
                        <ProgramEvaluationModal
                            isFamily={modal === 'familyPrograms'}
                            data={data}
                            setData={setData}
                            selectedProgram={selectedProgram}
                            setSelectedProgram={setSelectedProgram}
                            criteriaScores={criteriaScores}
                            setCriteriaScores={setCriteriaScores}
                            freeProgramScore={freeProgramScore}
                            setFreeProgramScore={setFreeProgramScore}
                            onSubmit={handleProgramSubmit}
                            onClose={() => {
                                setModal(null);
                                setSelectedProgram(null);
                                setCriteriaScores({});
                                setFreeProgramScore(0);
                            }}
                        />
                    )}
                </div>
            );
        };
        
        // ==================== PROGRAM EVALUATION MODAL ====================
        const ProgramEvaluationModal = ({
            isFamily,
            data,
            setData,
            selectedProgram,
            setSelectedProgram,
            criteriaScores,
            setCriteriaScores,
            freeProgramScore,
            setFreeProgramScore,
            onSubmit,
            onClose
        }) => {
            const programs = isFamily ? data.programs.family : data.programs.individual;
            const primaryColor = data.settings.primaryColor;
            
            const renderProgramSelection = () => (
                <div>
                    <h3 style={{ color: primaryColor, marginBottom: '20px', textAlign: 'center' }}>
                        {isFamily ? 'ðŸ  Ø¨Ø±Ø§Ù…Ø¬ Ø£Ø³Ø±ÙŠØ©' : 'ðŸ‘¤ Ø¨Ø±Ø§Ù…Ø¬ ÙØ±Ø¯ÙŠØ©'}
                    </h3>
                    
                    <div className="grid grid-3 gap-2">
                        {Object.entries(programs).map(([key, category]) => (
                            <div
                                key={key}
                                onClick={() => setSelectedProgram({ category, type: key })}
                                className="card"
                                style={{
                                    textAlign: 'center',
                                    cursor: 'pointer',
                                    border: `2px solid ${category.color}`,
                                    background: `${category.color}15`
                                }}
                            >
                                <div style={{ fontSize: '2rem', marginBottom: '10px' }}>
                                    {category.icon}
                                </div>
                                <div style={{ color: '#fff', fontWeight: '600' }}>
                                    {category.name}
                                </div>
                            </div>
                        ))}
                    </div>
                </div>
            );
            
            const renderCategoryPrograms = () => {
                if (!selectedProgram?.category) return null;
                
                const { category } = selectedProgram;
                
                return (
                    <div>
                        <button
                            onClick={() => setSelectedProgram(null)}
                            className="btn-secondary"
                            style={{ marginBottom: '20px' }}
                        >
                            â† Ø§Ù„Ø¹ÙˆØ¯Ø©
                        </button>
                        
                        <h3 style={{ color: category.color, marginBottom: '15px' }}>
                            {category.icon} {category.name}
                        </h3>
                        
                        <div>
                            <div className="grid grid-2 gap-2">
                                {category.programs.map(program => (
                                    <div
                                        key={program.id}
                                        className="card"
                                        onClick={() => setSelectedProgram({ ...selectedProgram, program })}
                                        style={{
                                            textAlign: 'center',
                                            cursor: 'pointer',
                                            border: `1px solid ${category.color}`,
                                            minHeight: '100px',
                                            display: 'flex',
                                            flexDirection: 'column',
                                            justifyContent: 'center',
                                            padding: '15px'
                                        }}
                                    >
                                        <div style={{ color: '#fff', fontWeight: '600', marginBottom: '5px' }}>
                                            {program.name}
                                        </div>
                                        <div style={{ color: primaryColor, fontSize: '0.9rem' }}>
                                            {formatNumber(program.max)} {data.settings.currency}
                                        </div>
                                        {program.free && (
                                            <div style={{ color: '#00C853', fontSize: '0.8rem', marginTop: '5px' }}>
                                                ØªÙ‚ÙŠÙŠÙ… Ø­Ø±
                                            </div>
                                        )}
                                    </div>
                                ))}
                            </div>
                        </div>
                    </div>
                );
            };

            const handleHalqaExcelUpload = (e) => {
                const file = e.target.files[0];
                if (!file) return;

                const reader = new FileReader();
                reader.onload = (evt) => {
                    try {
                        const bstr = evt.target.result;
                        const wb = XLSX.read(bstr, { type: 'binary' });
                        const wsname = wb.SheetNames[0];
                        const ws = wb.Sheets[wsname];
                        const rows = XLSX.utils.sheet_to_json(ws, { header: 1 });

                        let nameIdx = -1, hifzIdx = -1, murajaIdx = -1, tathbeetIdx = -1;
                        
                        // Search for headers
                        for(let r=0; r<Math.min(rows.length, 10); r++) {
                            const row = rows[r];
                            row.forEach((cell, idx) => {
                                if (typeof cell !== 'string') return;
                                if (cell.includes('Ø§Ù„Ø§Ø³Ù…')) nameIdx = idx;
                                else if (cell.includes('Ø­ÙØ¸')) hifzIdx = idx;
                                else if (cell.includes('Ù…Ø±Ø§Ø¬Ø¹Ø©')) murajaIdx = idx;
                                else if (cell.includes('ØªØ«Ø¨ÙŠØª')) tathbeetIdx = idx;
                            });
                            if (nameIdx !== -1) break;
                        }

                        if (nameIdx === -1 || hifzIdx === -1 || murajaIdx === -1 || tathbeetIdx === -1) {
                            alert('Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø§Ù„Ø£Ø¹Ù…Ø¯Ø© Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø© (Ø§Ù„Ø§Ø³Ù…ØŒ Ø­ÙØ¸ØŒ Ù…Ø±Ø§Ø¬Ø¹Ø©ØŒ ØªØ«Ø¨ÙŠØª)');
                            return;
                        }

                        if (window.confirm('Ø³ÙŠØªÙ… Ø±ØµØ¯ Ø§Ù„Ø¯Ø±Ø¬Ø§Øª Ù„Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø·Ù„Ø§Ø¨ Ø§Ù„Ù…ÙˆØ¬ÙˆØ¯ÙŠÙ† ÙÙŠ Ø§Ù„Ù…Ù„Ù. Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ØŸ')) {
                            setData(prev => {
                                const newData = JSON.parse(JSON.stringify(prev));
                                let count = 0;
                                const timestamp = new Date().toLocaleTimeString('ar-SA');
                                const date = formatDate();

                                if (!newData.archive) newData.archive = [];

                                rows.forEach((row, idx) => {
                                    const name = row[nameIdx];
                                    if (!name || typeof name !== 'string') return;

                                    const hifz = parseFloat(row[hifzIdx]) || 0;
                                    const muraja = parseFloat(row[murajaIdx]) || 0;
                                    const tathbeet = parseFloat(row[tathbeetIdx]) || 0;

                                    const avg = Math.round((hifz + muraja + tathbeet) / 3);
                                    if (avg <= 0) return;

                                    for (const station of newData.stations) {
                                        const student = station.students.find(s => s.name.trim() === name.trim());
                                        if (student) {
                                            student.liters += avg;
                                            student.achievements.push({
                                                liters: avg,
                                                description: 'Ø±ØµØ¯ Ø§Ù„Ø­Ù„Ù‚Ø© (Ù…Ù„Ù Ø¥ÙƒØ³Ù„)',
                                                date: date
                                            });

                                            station.totalLiters += Math.floor(avg * FAMILY_PERCENTAGE);

                                            newData.archive.push({
                                                id: Date.now() + Math.random(),
                                                type: 'student',
                                                targetName: student.name,
                                                points: avg,
                                                description: 'Ø±ØµØ¯ Ø§Ù„Ø­Ù„Ù‚Ø© (Ù…Ù„Ù Ø¥ÙƒØ³Ù„)',
                                                date: date,
                                                timestamp: timestamp
                                            });

                                            count++;
                                            break;
                                        }
                                    }
                                });

                                if (count > 0) {
                                    alert(`ØªÙ… Ø±ØµØ¯ Ø§Ù„Ø¯Ø±Ø¬Ø§Øª Ù„Ù€ ${count} Ø·Ø§Ù„Ø¨ Ø¨Ù†Ø¬Ø§Ø­`);
                                    onClose();
                                } else {
                                    alert('Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø·Ù„Ø§Ø¨ Ù…Ø·Ø§Ø¨Ù‚ÙŠÙ† ÙÙŠ Ø§Ù„Ù…Ù„Ù');
                                }
                                return newData;
                            });
                        }
                    } catch (error) {
                        console.error(error);
                        alert('Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ù‚Ø±Ø§Ø¡Ø© Ø§Ù„Ù…Ù„Ù: ' + error.message);
                    }
                };
                reader.readAsBinaryString(file);
            };
            
            const renderProgramEvaluation = () => {
                if (!selectedProgram?.program) return null;
                
                const { category, program } = selectedProgram;

                const totalScore = program.free ? freeProgramScore : 
                    program.criteria.reduce((sum, criterion) => {
                        const score = criteriaScores[criterion.name] || 0;
                        return sum + score * (criterion.pct / 100);
                    }, 0);
                
                const calculatedLiters = program.free ? freeProgramScore : 
                    Math.round(totalScore * program.max / 100);
                
                return (
                    <div>
                        <button
                            onClick={() => setSelectedProgram({ ...selectedProgram, program: null })}
                            className="btn-secondary"
                            style={{ marginBottom: '20px' }}
                        >
                            â† Ø§Ù„Ø¹ÙˆØ¯Ø©
                        </button>
                        
                        <h3 style={{ color: category.color, marginBottom: '15px' }}>
                            {category.icon} ØªÙ‚ÙŠÙŠÙ…: {program.name}
                        </h3>
                        
                        {program.free || !program.criteria || program.criteria.length === 0 ? (
                            <div style={{ marginBottom: '25px' }}>
                                <div className="flex justify-between mb-2">
                                    <span style={{ color: '#fff' }}>Ø§Ù„Ù†Ù‚Ø§Ø·</span>
                                    <span style={{ color: primaryColor, fontWeight: '700' }}>
                                        {freeProgramScore} / {program.max}
                                    </span>
                                </div>
                                <input
                                    type="range"
                                    min="0"
                                    max={program.max}
                                    value={freeProgramScore}
                                    onChange={(e) => setFreeProgramScore(parseInt(e.target.value) || 0)}
                                    style={{ width: '100%', marginBottom: '10px' }}
                                />
                                <div style={{ textAlign: 'center', padding: '20px', background: 'rgba(255, 255, 255, 0.05)', borderRadius: '12px' }}>
                                    <div style={{ fontSize: '2.5rem', fontWeight: '900', color: primaryColor }}>
                                        {freeProgramScore}
                                    </div>
                                    <div style={{ color: 'rgba(255, 255, 255, 0.6)' }}>
                                        {data.settings.currency}
                                    </div>
                                </div>
                            </div>
                        ) : (
                            <div style={{ marginBottom: '25px' }}>
                                {program.criteria.map(criterion => {
                                    const score = criteriaScores[criterion.name] || 0;
                                    const calculatedPercentage = score * (criterion.pct / 100);
                                    
                                    return (
                                        <div
                                            key={criterion.name}
                                            className="card"
                                            style={{ marginBottom: '10px' }}
                                        >
                                            <div className="flex justify-between mb-2">
                                                <span style={{ color: '#fff' }}>{criterion.name}</span>
                                                <span style={{ color: primaryColor }}>{criterion.pct}%</span>
                                            </div>
                                            <input
                                                type="range"
                                                min="0"
                                                max="100"
                                                value={score}
                                                onChange={(e) => setCriteriaScores({
                                                    ...criteriaScores,
                                                    [criterion.name]: parseInt(e.target.value) || 0
                                                })}
                                                style={{ width: '100%' }}
                                            />
                                            <div className="flex justify-between mt-2">
                                                <div style={{ color: 'rgba(255, 255, 255, 0.5)', fontSize: '0.9rem' }}>
                                                    Ø§Ù„Ù†Ø³Ø¨Ø©: {score}%
                                                </div>
                                                <div style={{ color: '#00C853', fontSize: '0.9rem', fontWeight: '600' }}>
                                                    Ø§Ù„Ù…Ø­Ø³ÙˆØ¨Ø©: {calculatedPercentage.toFixed(1)}%
                                                </div>
                                            </div>
                                        </div>
                                    );
                                })}
                                
                                <div className="card" style={{ 
                                    background: `${primaryColor}15`,
                                    border: `1px solid ${primaryColor}`,
                                    textAlign: 'center'
                                }}>
                                    <div style={{ fontSize: '1.8rem', fontWeight: '900', color: primaryColor }}>
                                        {calculatedLiters}
                                    </div>
                                    <div style={{ color: 'rgba(255, 255, 255, 0.6)' }}>
                                        {data.settings.currency} ({Math.round(totalScore)}%)
                                    </div>
                                </div>
                            </div>
                        )}
                        
                        <button
                            onClick={() => onSubmit(isFamily)}
                            className="btn-success"
                            style={{ width: '100%', padding: '15px', fontSize: '1.1rem' }}
                        >
                            âœ“ Ø¥Ø¶Ø§ÙØ© {calculatedLiters} {data.settings.currency}
                        </button>
                    </div>
                );
            };
            
            const renderContent = () => {
                if (!selectedProgram) return renderProgramSelection();
                if (!selectedProgram.program) return renderCategoryPrograms();
                return renderProgramEvaluation();
            };
            
            return (
                <Modal onClose={onClose} wide>
                    {renderContent()}
                </Modal>
            );
        };

        // ==================== HALQA MONITORING MODAL (EXCEL) ====================
        const HalqaMonitoringModal = ({ data, setData, onClose, addPoints }) => {
            const handleFileUpload = (e) => {
                const file = e.target.files[0];
                if (!file) return;
                const reader = new FileReader();
                reader.onload = (evt) => {
                    try {
                        const bstr = evt.target.result;
                        const wb = XLSX.read(bstr, { type: 'binary' });
                        const wsname = wb.SheetNames[0];
                        const ws = wb.Sheets[wsname];
                        const rows = XLSX.utils.sheet_to_json(ws, { header: 1 });

                        let count = 0;
                        setData(prev => {
                            const newData = JSON.parse(JSON.stringify(prev));
                            if (!newData.archive) newData.archive = [];
                            const dateStr = formatDate();
                            const timeStr = new Date().toLocaleTimeString('ar-SA');

                            for (let i = 1; i < rows.length; i++) {
                                const row = rows[i];
                                if (!row[0]) continue; 
                                const name = row[0];
                                const hifz = parseInt(row[2]) || 0;
                                const tathbeet = parseInt(row[3]) || 0;
                                const muraja = parseInt(row[4]) || 0;
                                const totalPoints = hifz + tathbeet + muraja; 

                                if (totalPoints > 0) {
                                    for (const station of newData.stations) {
                                        const student = station.students.find(s => s.name.trim() === name.trim());
                                        if (student) {
                                            student.liters += totalPoints;
                                            student.achievements.push({ liters: totalPoints, description: 'Ø±ØµØ¯ Ø§Ù„Ø­Ù„Ù‚Ø©', date: dateStr });
                                            station.totalLiters += Math.floor(totalPoints * FAMILY_PERCENTAGE);
                                            
                                            newData.archive.push({ id: Date.now()+i, type: 'student', targetName: student.name, points: totalPoints, description: 'Ø±ØµØ¯ Ø§Ù„Ø­Ù„Ù‚Ø© (Ù…Ù„Ù Ø¥ÙƒØ³Ù„)', date: dateStr, timestamp: timeStr });
                                            count++;
                                            break;
                                        }
                                    }
                                }
                            }
                            alert(`ØªÙ… Ø±ØµØ¯ Ø¯Ø±Ø¬Ø§Øª ${count} Ø·Ø§Ù„Ø¨ Ø¨Ù†Ø¬Ø§Ø­!`);
                            onClose();
                            return newData;
                        });
                    } catch (err) {
                        alert('Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ù‚Ø±Ø§Ø¡Ø© Ø§Ù„Ù…Ù„Ù. ØªØ£ÙƒØ¯ Ù…Ù† ØµØ­Ø© Ø§Ù„ØªØ±ØªÙŠØ¨ (Ø§Ù„Ø§Ø³Ù…ØŒ Ø§Ù„Ø¹Ø§Ø¦Ù„Ø©ØŒ Ø­ÙØ¸ØŒ ØªØ«Ø¨ÙŠØªØŒ Ù…Ø±Ø§Ø¬Ø¹Ø©).');
                    }
                };
                reader.readAsBinaryString(file);
            };

            return (
                <Modal onClose={onClose}>
                    <h3 style={{ color: '#D4AF37', marginBottom: '20px', textAlign: 'center' }}>â­• Ø±ØµØ¯ Ø§Ù„Ø­Ù„Ù‚Ø© (Ø¥ÙƒØ³Ù„)</h3>
                    <div className="card" style={{ textAlign: 'center', padding: '30px', border: '2px dashed #D4AF37' }}>
                        <p style={{ marginBottom: '15px' }}>Ø§Ø±ÙØ¹ Ù…Ù„Ù Ø§Ù„Ø¥ÙƒØ³Ù„ Ø¨Ø­ÙŠØ« ÙŠÙƒÙˆÙ† Ø§Ù„ØªØ±ØªÙŠØ¨ ÙƒØ§Ù„ØªØ§Ù„ÙŠ:<br/>(Ø§Ù„Ø§Ø³Ù… - Ø§Ù„Ø¹Ø§Ø¦Ù„Ø© - Ø§Ù„Ø­ÙØ¸ - Ø§Ù„ØªØ«Ø¨ÙŠØª - Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹Ø©)</p>
                        <input type="file" accept=".xlsx, .xls" onChange={handleFileUpload} />
                    </div>
                </Modal>
            );
        };

        // ==================== ASSIGNMENTS SYSTEM (ØªÙƒÙ„ÙŠÙ) ====================
        const AssignmentsSystem = ({ data, setData, onClose }) => {
            const [selectedCommittee, setSelectedCommittee] = useState('');
            const [assignmentType, setAssignmentType] = useState(''); 
            const [selectedProgram, setSelectedProgram] = useState(null);
            const [selectedTarget, setSelectedTarget] = useState('');
            const [messageText, setMessageText] = useState('');
            const [isEditingMessage, setIsEditingMessage] = useState(false);

            const getProgramsList = () => {
                if (!selectedCommittee || !assignmentType) return [];
                const typeKey = assignmentType === 'Ø£Ø³Ø±ÙŠ' ? 'family' : 'individual';
                const programsObj = data.programs[typeKey];
                let list = [];
                Object.values(programsObj).forEach(cat => {
                    if (cat.name === selectedCommittee) { list = cat.programs; }
                });
                return list;
            };

            const getTargetsList = () => {
                if (assignmentType === 'Ø£Ø³Ø±ÙŠ') return data.stations.map(s => s.name);
                let students = [];
                data.stations.forEach(s => s.students.forEach(st => students.push(st.name)));
                return students;
            };

            // Ø§Ù„Ù…Ù†Ø¹ Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ Ø¨Ø¯Ø§ÙŠØ© Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹ (ÙŠÙˆÙ… Ø§Ù„Ø³Ø¨Øª)
            const checkMultipleAssignments = (targetName) => {
                const logs = data.assignmentsArchive || [];
                
                const now = new Date();
                const dayOfWeek = now.getDay(); 
                const daysToSubtract = (dayOfWeek + 1) % 7; 
                
                const startOfThisWeek = new Date(now.getFullYear(), now.getMonth(), now.getDate() - daysToSubtract);
                startOfThisWeek.setHours(0, 0, 0, 0);

                return logs.some(log => {
                    if (log.target !== targetName) return false;
                    if (!log.timestamp) return false;
                    const logTime = new Date(log.timestamp); 
                    return logTime >= startOfThisWeek;
                });
            };

            const handleSelectTarget = (targetName) => {
                if (checkMultipleAssignments(targetName)) {
                    alert(`âš ï¸ ØªØ­Ø°ÙŠØ±: Ø¹Ø°Ø±Ø§Ù‹ØŒ ÙŠÙ…Ù†Ø¹ Ø§Ù„ØªÙƒÙ„ÙŠÙ! [ ${targetName} ] ÙƒÙÙ„Ù‘Ù Ø¨Ø¨Ø±Ù†Ø§Ù…Ø¬ Ù…Ø³Ø¨Ù‚Ø§Ù‹ Ø®Ù„Ø§Ù„ Ù‡Ø°Ø§ Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹.`);
                    return;
                }
                setSelectedTarget(targetName);
                
                // Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø±Ø¦ÙŠØ³ Ø§Ù„Ø£Ø³Ø±Ø© Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„ØªÙƒÙ„ÙŠÙ Ø£Ø³Ø±ÙŠ
                let headName = targetName;
                if (assignmentType === 'Ø£Ø³Ø±ÙŠ') {
                    const station = data.stations.find(s => s.name === targetName);
                    headName = station ? station.head : targetName;
                }
                
                let criteriaText = 'Ø¨Ø±Ù†Ø§Ù…Ø¬ Ø­Ø± Ø¨Ø¯ÙˆÙ† Ø¨Ù†ÙˆØ¯ ØªÙ‚ÙŠÙŠÙ…';
                if (selectedProgram && selectedProgram.criteria && selectedProgram.criteria.length > 0) {
                    criteriaText = selectedProgram.criteria.map(c => `- ${c.name} (${c.pct}%)`).join('\n');
                }

                const defaultMsg = `Ø§Ù„Ø³Ù„Ø§Ù… Ø¹Ù„ÙŠÙƒÙ… ÙˆØ±Ø­Ù…Ø© Ø§Ù„Ù„Ù‡ ÙˆØ¨Ø±ÙƒØ§ØªÙ‡\nØ­ÙŠØ§Ùƒ Ø§Ù„Ù„Ù‡ ÙŠØ§Ø´ÙŠØ® (${headName})\nØ¨ÙŠÙƒÙˆÙ† Ø¨Ø¥Ø°Ù† Ø§Ù„Ù„Ù‡ Ø¹Ù†Ø¯ÙƒÙ… ÙÙŠ Ø§Ù„Ø·Ù„Ø¹Ø© Ø§Ù„Ù‚Ø§Ø¯Ù…Ø© Ø¨Ø±Ù†Ø§Ù…Ø¬ (${selectedProgram?.name})\nØ´Ø¯Ù‘ÙˆØ§ Ø­ÙŠÙ„ÙƒÙ… ÙÙŠ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯ Ø§Ù„Ù„Ù‡ ÙŠÙ‚ÙˆÙŠÙƒÙ… ÙˆÙŠØ¹ÙŠÙ†ÙƒÙ…\nÙˆÙ‡Ø°Ù‡ Ø¨Ù†ÙˆØ¯ Ø§Ù„Ø¨Ø±Ù†Ø§Ù…Ø¬:\n${criteriaText}\n\nÙˆØ§Ù„Ø³Ù„Ø§Ù… Ø¹Ù„ÙŠÙƒÙ… ÙˆØ±Ø­Ù…Ø© Ø§Ù„Ù„Ù‡ ÙˆØ¨Ø±ÙƒØ§ØªÙ‡`;
                
                setMessageText(defaultMsg);
                setIsEditingMessage(false);
            };

            const handleSendWhatsApp = () => {
                let headName = selectedTarget;
                if (assignmentType === 'Ø£Ø³Ø±ÙŠ') {
                    const station = data.stations.find(s => s.name === selectedTarget);
                    headName = station ? station.head : selectedTarget;
                }
                
                // Use data.phoneBook if available, otherwise fallback to global constant
                let phoneNum = (data.phoneBook && data.phoneBook[headName]) ? data.phoneBook[headName] : (typeof phoneBook !== 'undefined' ? phoneBook[headName] : null);

                if (!phoneNum) {
                    alert("âš ï¸ Ø±Ù‚Ù… Ø§Ù„Ø¬ÙˆØ§Ù„ ØºÙŠØ± Ù…Ø³Ø¬Ù„ ÙÙŠ Ø§Ù„Ù†Ø¸Ø§Ù…!");
                    return;
                }

                setData(prev => {
                    const newData = JSON.parse(JSON.stringify(prev));
                    if(!newData.assignmentsArchive) newData.assignmentsArchive = [];
                    newData.assignmentsArchive.push({
                        date: formatDate(),
                        day: getDayName(),
                        target: selectedTarget,
                        program: selectedProgram.name,
                        committee: selectedCommittee, // Added committee
                        message: messageText,
                        timestamp: Date.now()
                    });
                    return newData;
                });

                const finalMsg = messageText.replace(/\(/g, '').replace(/\)/g, '');
                const waLink = `https://api.whatsapp.com/send?phone=${phoneNum}&text=${encodeURIComponent(finalMsg)}`;
                window.open(waLink, '_blank');
                
                setSelectedTarget('');
                setSelectedProgram(null);
            };

            function getDayName() {
                const days = ['Ø§Ù„Ø£Ø­Ø¯', 'Ø§Ù„Ø¥Ø«Ù†ÙŠÙ†', 'Ø§Ù„Ø«Ù„Ø§Ø«Ø§Ø¡', 'Ø§Ù„Ø£Ø±Ø¨Ø¹Ø§Ø¡', 'Ø§Ù„Ø®Ù…ÙŠØ³', 'Ø§Ù„Ø¬Ù…Ø¹Ø©', 'Ø§Ù„Ø³Ø¨Øª'];
                return days[new Date().getDay()];
            }

            return (
                <Modal onClose={onClose} wide>
                    <h3 style={{ color: '#D4AF37', marginBottom: '20px', textAlign: 'center' }}>ðŸ“© Ù†Ø¸Ø§Ù… Ø§Ù„ØªÙƒÙ„ÙŠÙ</h3>
                    
                    <div className="flex gap-2 mb-3" style={{ justifyContent: 'center' }}>
                        {['Ø§Ù„Ø±ÙŠØ§Ø¶ÙŠØ©', 'Ø§Ù„Ø§Ø¬ØªÙ…Ø§Ø¹ÙŠØ©', 'Ø§Ù„Ø«Ù‚Ø§ÙÙŠØ©', 'Ø§Ù„ØªØ±Ø¨ÙˆÙŠØ©'].map(com => (
                            <button key={com} onClick={() => { setSelectedCommittee(com); setSelectedProgram(null); setSelectedTarget(''); }} className={selectedCommittee === com ? "btn-primary" : "btn-secondary"}>{com}</button>
                        ))}
                    </div>

                    {selectedCommittee && (
                        <div className="flex gap-2 mb-3" style={{ justifyContent: 'center' }}>
                            <button onClick={() => { setAssignmentType('Ø£Ø³Ø±ÙŠ'); setSelectedProgram(null); setSelectedTarget(''); }} className={assignmentType === 'Ø£Ø³Ø±ÙŠ' ? "btn-success" : "btn-secondary"}>ØªÙƒÙ„ÙŠÙ Ø£Ø³Ø±ÙŠ</button>
                            <button onClick={() => { setAssignmentType('ÙØ±Ø¯ÙŠ'); setSelectedProgram(null); setSelectedTarget(''); }} className={assignmentType === 'ÙØ±Ø¯ÙŠ' ? "btn-success" : "btn-secondary"}>ØªÙƒÙ„ÙŠÙ ÙØ±Ø¯ÙŠ</button>
                        </div>
                    )}

                    {assignmentType && (
                        <div className="mb-3">
                            <select onChange={(e) => {
                                const prog = getProgramsList().find(p => p.name === e.target.value);
                                setSelectedProgram(prog);
                                setSelectedTarget('');
                            }} style={{ width: '100%' }}>
                                <option value="">Ø§Ø®ØªØ± Ø§Ù„Ø¨Ø±Ù†Ø§Ù…Ø¬</option>
                                {getProgramsList().map(p => <option key={p.id} value={p.name}>{p.name}</option>)}
                            </select>
                        </div>
                    )}

                    {selectedProgram && (
                        <div className="mb-3">
                            <h4 style={{marginBottom:'10px'}}>Ø§Ø®ØªØ± Ø§Ù„Ù€ {assignmentType === 'Ø£Ø³Ø±ÙŠ' ? 'Ø£Ø³Ø±Ø©' : 'Ø·Ø§Ù„Ø¨'}:</h4>
                            <div className="grid grid-3 gap-2" style={{maxHeight:'150px', overflowY:'auto'}}>
                                {getTargetsList().map(t => (
                                    <button key={t} onClick={() => handleSelectTarget(t)} className={selectedTarget === t ? "btn-primary btn-small" : "btn-secondary btn-small"}>{t}</button>
                                ))}
                            </div>
                        </div>
                    )}

                    {selectedTarget && (
                        <div className="card" style={{ marginTop: '20px', background: 'rgba(0,0,0,0.3)' }}>
                            {isEditingMessage ? (
                                <textarea value={messageText} onChange={(e) => setMessageText(e.target.value)} rows="8" style={{ width: '100%', marginBottom: '10px' }} />
                            ) : (
                                <pre style={{ whiteSpace: 'pre-wrap', color: '#D4AF37', marginBottom: '10px', fontStyle: 'italic' }}>{messageText}</pre>
                            )}
                            
                            <div className="flex gap-2">
                                <button onClick={() => setIsEditingMessage(!isEditingMessage)} className="btn-secondary" style={{ flex: 1 }}>
                                    {isEditingMessage ? 'Ø­ÙØ¸ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„' : 'âœï¸ ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø±Ø³Ø§Ù„Ø©'}
                                </button>
                                <button onClick={handleSendWhatsApp} className="btn-success" style={{ flex: 2, background: '#25D366' }}>
                                    Ø§Ø±Ø³Ø§Ù„ ÙˆØ§ØªØ³Ø§Ø¨ ðŸ’¬
                                </button>
                            </div>
                        </div>
                    )}
                </Modal>
            );
        };

        // ==================== ASSIGNMENTS ARCHIVE ====================
        const AssignmentsArchiveViewer = ({ data, onClose }) => {
            const archive = data.assignmentsArchive || [];
            return (
                <Modal onClose={onClose} wide>
                    <h3 style={{ color: '#D4AF37', marginBottom: '20px', textAlign: 'center' }}>ðŸ“ Ø£Ø±Ø´ÙŠÙ Ø§Ù„ØªÙƒØ§Ù„ÙŠÙ</h3>
                    {archive.length === 0 ? <p style={{textAlign:'center'}}>Ù„Ø§ ØªÙˆØ¬Ø¯ Ø±Ø³Ø§Ø¦Ù„ Ù…Ø±Ø³Ù„Ø© Ø¨Ø¹Ø¯.</p> : (
                        <div style={{ maxHeight: '600px', overflowY: 'auto' }}>
                        <table style={{ width: '100%', borderCollapse: 'collapse', color: '#fff' }}>
                            <thead>
                                <tr style={{ borderBottom: '1px solid rgba(255, 255, 255, 0.2)', textAlign: 'right' }}>
                                    <th style={{ padding: '10px' }}>Ø§Ù„ØªØ§Ø±ÙŠØ®</th>
                                    <th style={{ padding: '10px' }}>Ø§Ù„Ø§Ø³Ù…</th>
                                    <th style={{ padding: '10px' }}>Ø§Ù„Ø¨Ø±Ù†Ø§Ù…Ø¬</th>
                                    <th style={{ padding: '10px' }}>Ø§Ù„Ù„Ø¬Ù†Ø©</th>
                                </tr>
                            </thead>
                            <tbody>
                                {[...archive].reverse().map((item, index) => (
                                    <tr key={index} style={{ borderBottom: '1px solid rgba(255, 255, 255, 0.05)' }}>
                                        <td style={{ padding: '10px', fontSize: '0.9rem', color: 'rgba(255, 255, 255, 0.6)' }}>
                                            {item.date}
                                        </td>
                                        <td style={{ padding: '10px', fontWeight: 'bold' }}>
                                            {item.target}
                                        </td>
                                        <td style={{ padding: '10px', color: '#00C853' }}>
                                            {item.program}
                                        </td>
                                        <td style={{ padding: '10px', fontSize: '0.9rem' }}>
                                            {item.committee || '-'}
                                        </td>
                                    </tr>
                                ))}
                            </tbody>
                        </table>
                        </div>
                    )}
                    <button onClick={onClose} className="btn-secondary" style={{width:'100%', marginTop:'20px'}}>Ø¥ØºÙ„Ø§Ù‚</button>
                </Modal>
            );
        };

        // ==================== ACHIEVEMENTS VIEWER (Ø¥Ù†Ø¬Ø§Ø² Ø§Ù„Ø·Ù„Ø§Ø¨) ====================
        const AchievementsViewer = ({ data, onClose }) => {
            const [selectedStudent, setSelectedStudent] = useState(null);
            
            // Collect all students
            const allStudents = [];
            data.stations.forEach(station => {
                station.students.forEach(student => {
                    allStudents.push({ ...student, stationName: station.name, stationColor: station.color });
                });
            });

            // Collect all individual programs
            const allPrograms = [];
            Object.values(data.programs.individual).forEach(category => {
                category.programs.forEach(program => {
                    allPrograms.push(program.name);
                });
            });

            const renderStudentList = () => (
                <div>
                    <h3 style={{ color: '#D4AF37', marginBottom: '20px', textAlign: 'center' }}>âœ… Ø³Ø¬Ù„ Ø¥Ù†Ø¬Ø§Ø² Ø§Ù„Ø·Ù„Ø§Ø¨</h3>
                    <div className="grid grid-3 gap-2" style={{ maxHeight: '60vh', overflowY: 'auto' }}>
                        {allStudents.map(student => (
                            <div 
                                key={student.id} 
                                className="card" 
                                onClick={() => setSelectedStudent(student)}
                                style={{ cursor: 'pointer', textAlign: 'center', transition: 'transform 0.2s' }}
                                onMouseEnter={(e) => e.currentTarget.style.transform = 'scale(1.02)'}
                                onMouseLeave={(e) => e.currentTarget.style.transform = 'scale(1)'}
                            >
                                <div style={{ fontWeight: 'bold', color: '#fff' }}>{student.name}</div>
                                <div style={{ fontSize: '0.8rem', color: student.stationColor }}>{student.stationName}</div>
                            </div>
                        ))}
                    </div>
                    <button onClick={onClose} className="btn-secondary" style={{width:'100%', marginTop:'20px'}}>Ø¥ØºÙ„Ø§Ù‚</button>
                </div>
            );

            const renderStudentDetails = () => {
                const presentedPrograms = [];
                // Check student achievements
                selectedStudent.achievements.forEach(ach => {
                    if (allPrograms.includes(ach.description)) {
                        presentedPrograms.push(ach.description);
                    }
                });
                // Remove duplicates
                const uniquePresented = [...new Set(presentedPrograms)];
                
                const notPresentedPrograms = allPrograms.filter(p => !uniquePresented.includes(p));

                return (
                    <div>
                        <button onClick={() => setSelectedStudent(null)} className="btn-secondary mb-2">â† Ø§Ù„Ø¹ÙˆØ¯Ø© Ù„Ù„Ù‚Ø§Ø¦Ù…Ø©</button>
                        <h3 style={{ color: '#D4AF37', marginBottom: '20px', textAlign: 'center' }}>
                            Ø³Ø¬Ù„ Ø¥Ù†Ø¬Ø§Ø²: {selectedStudent.name}
                        </h3>
                        <div className="grid grid-2 gap-2">
                            <div className="card">
                                <h4 style={{ color: '#00C853', marginBottom: '15px', textAlign: 'center', borderBottom: '1px solid #00C853', paddingBottom: '10px' }}>
                                    âœ… Ø§Ù„Ø¨Ø±Ø§Ù…Ø¬ Ø§Ù„Ù…Ù‚Ø¯Ù…Ø© ({uniquePresented.length})
                                </h4>
                                <div style={{ maxHeight: '400px', overflowY: 'auto' }}>
                                    {uniquePresented.length === 0 ? <p style={{textAlign:'center', color:'#aaa'}}>Ù„Ø§ ÙŠÙˆØ¬Ø¯</p> : 
                                        uniquePresented.map((prog, i) => (
                                            <div key={i} style={{ padding: '8px', borderBottom: '1px solid rgba(255,255,255,0.1)', color: '#fff' }}>
                                                {prog}
                                            </div>
                                        ))
                                    }
                                </div>
                            </div>
                            <div className="card">
                                <h4 style={{ color: '#FF5252', marginBottom: '15px', textAlign: 'center', borderBottom: '1px solid #FF5252', paddingBottom: '10px' }}>
                                    âŒ Ø§Ù„Ø¨Ø±Ø§Ù…Ø¬ ØºÙŠØ± Ø§Ù„Ù…Ù‚Ø¯Ù…Ø© ({notPresentedPrograms.length})
                                </h4>
                                <div style={{ maxHeight: '400px', overflowY: 'auto' }}>
                                    {notPresentedPrograms.length === 0 ? <p style={{textAlign:'center', color:'#aaa'}}>Ù„Ø§ ÙŠÙˆØ¬Ø¯</p> : 
                                        notPresentedPrograms.map((prog, i) => (
                                            <div key={i} style={{ padding: '8px', borderBottom: '1px solid rgba(255,255,255,0.1)', color: 'rgba(255,255,255,0.6)' }}>
                                                {prog}
                                            </div>
                                        ))
                                    }
                                </div>
                            </div>
                        </div>
                    </div>
                );
            };

            return (
                <Modal onClose={onClose} wide>
                    {selectedStudent ? renderStudentDetails() : renderStudentList()}
                </Modal>
            );
        };
        
        // ==================== STUDENTS MANAGEMENT MODAL ====================
        const StudentsModal = ({ data, setData, onClose }) => {
            const [selectedStation, setSelectedStation] = useState('');
            const [newStudentName, setNewStudentName] = useState('');
            const [newStudentPassword, setNewStudentPassword] = useState('');
            const [showPasswords, setShowPasswords] = useState(false);
            
            const primaryColor = data.settings.primaryColor;
            
            const addStudent = () => {
                if (!newStudentName.trim() || !selectedStation) {
                    alert('Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ø³Ù… Ø§Ù„Ø·Ø§Ù„Ø¨ ÙˆØ§Ø®ØªÙŠØ§Ø± Ø§Ù„Ù…Ø­Ø·Ø©');
                    return;
                }
                
                if (!newStudentPassword.trim()) {
                    alert('Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ ÙƒÙ„Ù…Ø© Ù…Ø±ÙˆØ± Ù„Ù„Ø·Ø§Ù„Ø¨');
                    return;
                }
                
                setData(prev => {
                    const newData = JSON.parse(JSON.stringify(prev));
                    const stationIndex = newData.stations.findIndex(s => s.id === selectedStation);
                    
                    newData.stations[stationIndex].students.push({
                        id: newData.settings.nextStudentId,
                        name: newStudentName.trim(),
                        liters: 0,
                        password: newStudentPassword.trim(),
                        achievements: [],
                        badges: []
                    });
                    
                    newData.settings.nextStudentId++;
                    return newData;
                });
                
                setNewStudentName('');
                setNewStudentPassword('');
                alert('ØªÙ… Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø·Ø§Ù„Ø¨ Ø¨Ù†Ø¬Ø§Ø­');
            };
            
            const deleteStudent = (stationId, studentId, studentName) => {
                if (!window.confirm(`Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ø§Ù„Ø·Ø§Ù„Ø¨ "${studentName}"ØŸ`)) {
                    return;
                }
                
                setData(prev => {
                    const newData = JSON.parse(JSON.stringify(prev));
                    const stationIndex = newData.stations.findIndex(s => s.id === stationId);
                    newData.stations[stationIndex].students = newData.stations[stationIndex].students.filter(s => s.id !== studentId);
                    return newData;
                });
            };
            
            const generatePassword = () => {
                const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789!@#$%^&*';
                let password = '';
                for (let i = 0; i < 10; i++) {
                    password += chars.charAt(Math.floor(Math.random() * chars.length));
                }
                setNewStudentPassword(password);
            };
            
            return (
                <Modal onClose={onClose} wide>
                    <h2 style={{ color: primaryColor, marginBottom: '20px', textAlign: 'center' }}>
                        ðŸ‘¥ Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø·Ù„Ø§Ø¨
                    </h2>
                    
                    <div className="card" style={{ marginBottom: '25px' }}>
                        <h3 style={{ color: '#00C853', marginBottom: '15px' }}>
                            âž• Ø¥Ø¶Ø§ÙØ© Ø·Ø§Ù„Ø¨ Ø¬Ø¯ÙŠØ¯
                        </h3>
                        
                        <select
                            value={selectedStation}
                            onChange={(e) => setSelectedStation(e.target.value)}
                            style={{ width: '100%', marginBottom: '10px' }}
                        >
                            <option value="">Ø§Ø®ØªØ± Ø§Ù„Ù…Ø­Ø·Ø©</option>
                            {data.stations.map(station => (
                                <option key={station.id} value={station.id}>
                                    {station.name}
                                </option>
                            ))}
                        </select>
                        
                        <input
                            value={newStudentName}
                            onChange={(e) => setNewStudentName(e.target.value)}
                            placeholder="Ø§Ø³Ù… Ø§Ù„Ø·Ø§Ù„Ø¨"
                            style={{ width: '100%', marginBottom: '10px' }}
                        />
                        
                        <div style={{ position: 'relative', marginBottom: '10px' }}>
                            <input
                                type={showPasswords ? "text" : "password"}
                                value={newStudentPassword}
                                onChange={(e) => setNewStudentPassword(e.target.value)}
                                placeholder="ÙƒÙ„Ù…Ø© Ù…Ø±ÙˆØ± Ø§Ù„Ø·Ø§Ù„Ø¨"
                                style={{ width: '100%', paddingRight: '120px' }}
                            />
                            <button
                                onClick={generatePassword}
                                className="btn-primary btn-small"
                                style={{ position: 'absolute', left: '10px', top: '50%', transform: 'translateY(-50%)' }}
                            >
                                ØªÙˆÙ„ÙŠØ¯
                            </button>
                        </div>
                        
                        <button
                            onClick={addStudent}
                            className="btn-success"
                            style={{ width: '100%' }}
                        >
                            Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø·Ø§Ù„Ø¨
                        </button>
                    </div>
                    
                    <div>
                        {data.stations.map(station => (
                            <div key={station.id} style={{ marginBottom: '20px' }}>
                                <h4 style={{ color: station.color, marginBottom: '10px', paddingRight: '10px' }}>
                                    {station.name} ({station.students.length} Ø·Ø§Ù„Ø¨)
                                </h4>
                                
                                {station.students.map(student => (
                                    <div
                                        key={student.id}
                                        className="card"
                                        style={{
                                            display: 'flex',
                                            justifyContent: 'space-between',
                                            alignItems: 'center',
                                            marginBottom: '8px',
                                            padding: '12px'
                                        }}
                                    >
                                        <div>
                                            <div style={{ color: '#fff', fontWeight: '600', marginBottom: '3px' }}>
                                                {student.name}
                                            </div>
                                            <div style={{ color: primaryColor, fontSize: '0.9rem' }}>
                                                {formatNumber(student.liters)} {data.settings.currency}
                                            </div>
                                            {showPasswords && (
                                                <div style={{ color: 'rgba(255, 255, 255, 0.5)', fontSize: '0.8rem', fontFamily: 'monospace', marginTop: '3px' }}>
                                                    {student.password}
                                                </div>
                                            )}
                                        </div>
                                        
                                        <button
                                            onClick={() => deleteStudent(station.id, student.id, student.name)}
                                            className="btn-danger btn-small"
                                        >
                                            Ø­Ø°Ù
                                        </button>
                                    </div>
                                ))}
                            </div>
                        ))}
                    </div>
                    
                    <div className="flex justify-between align-center mt-3">
                        <button
                            onClick={() => setShowPasswords(!showPasswords)}
                            className="btn-secondary"
                        >
                            {showPasswords ? 'ðŸ‘ï¸ Ø¥Ø®ÙØ§Ø¡ ÙƒÙ„Ù…Ø§Øª Ø§Ù„Ù…Ø±ÙˆØ±' : 'ðŸ‘ï¸â€ðŸ—¨ï¸ Ø¹Ø±Ø¶ ÙƒÙ„Ù…Ø§Øª Ø§Ù„Ù…Ø±ÙˆØ±'}
                        </button>
                        
                        <button
                            onClick={onClose}
                            className="btn-primary"
                        >
                            Ø¥ØºÙ„Ø§Ù‚
                        </button>
                    </div>
                </Modal>
            );
        };
        
        // ==================== SETTINGS MODAL ====================
        const SettingsModal = ({ data, setData, onClose }) => {
            const [showPasswords, setShowPasswords] = useState(false);
            const [currentPassword, setCurrentPassword] = useState('');
            const [newPassword, setNewPassword] = useState('');
            const [confirmPassword, setConfirmPassword] = useState('');
            const [stationNames, setStationNames] = useState({});
            const [stationHeads, setStationHeads] = useState({}); // Ù„Ø¥Ù…ÙƒØ§Ù†ÙŠØ© ØªØ¹Ø¯ÙŠÙ„ Ø±Ø¦ÙŠØ³ Ø§Ù„Ø£Ø³Ø±Ø©
            const [activeTab, setActiveTab] = useState('general');
            const [showStudentEditor, setShowStudentEditor] = useState(false);
            
            const primaryColor = data.settings.primaryColor;
            
            const colorOptions = [
                { name: 'Ø°Ù‡Ø¨ÙŠ', value: '#D4AF37' },
                { name: 'Ø£Ø­Ù…Ø±', value: '#FF6B6B' },
                { name: 'ÙÙŠØ±ÙˆØ²ÙŠ', value: '#4ECDC4' },
                { name: 'Ø¨Ù†ÙØ³Ø¬ÙŠ', value: '#A66CFF' },
                { name: 'Ø£Ø®Ø¶Ø±', value: '#00C853' },
                { name: 'Ø¨Ø±ØªÙ‚Ø§Ù„ÙŠ', value: '#FF9800' },
                { name: 'Ø£Ø²Ø±Ù‚', value: '#2196F3' },
                { name: 'ÙˆØ±Ø¯ÙŠ', value: '#E91E63' }
            ];
            
            const iconOptions = ['â­', 'ðŸ’°', 'ðŸŽ¯', 'ðŸ’Ž', 'ðŸ†', 'ðŸ”¥', 'âš¡', 'âœ¨', 'ðŸ’«', 'ðŸŽ–ï¸'];
            
            useEffect(() => {
                const names = {};
                const heads = {};
                data.stations.forEach(station => {
                    names[station.id] = station.name;
                    heads[station.id] = station.head || '';
                });
                setStationNames(names);
                setStationHeads(heads);
            }, [data.stations]);
            
            const saveStationNames = () => {
                setData(prev => {
                    const newData = JSON.parse(JSON.stringify(prev));
                    newData.stations.forEach(station => {
                        if (stationNames[station.id]) {
                            station.name = stationNames[station.id];
                        }
                        if (stationHeads[station.id]) {
                            station.head = stationHeads[station.id];
                        }
                    });
                    return newData;
                });
                alert('ØªÙ… Ø­ÙØ¸ Ø£Ø³Ù…Ø§Ø¡ Ø§Ù„Ù…Ø­Ø·Ø§Øª ÙˆØ±Ø¤Ø³Ø§Ø¡ Ø§Ù„Ø£Ø³Ø± Ø¨Ù†Ø¬Ø§Ø­');
            };
            
            const changeSupervisorPassword = () => {
                if (currentPassword !== data.settings.supervisorPassword) {
                    alert('ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ø§Ù„Ø­Ø§Ù„ÙŠØ© ØºÙŠØ± ØµØ­ÙŠØ­Ø©');
                    return;
                }
                
                if (newPassword.length < 8) {
                    alert('ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø© ÙŠØ¬Ø¨ Ø£Ù† ØªÙƒÙˆÙ† 8 Ø£Ø­Ø±Ù Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„');
                    return;
                }
                
                if (newPassword !== confirmPassword) {
                    alert('ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø© ØºÙŠØ± Ù…ØªØ·Ø§Ø¨Ù‚Ø©');
                    return;
                }
                
                setData(prev => ({
                    ...prev,
                    settings: {
                        ...prev.settings,
                        supervisorPassword: newPassword
                    }
                }));
                
                setCurrentPassword('');
                setNewPassword('');
                setConfirmPassword('');
                alert('ØªÙ… ØªØºÙŠÙŠØ± ÙƒÙ„Ù…Ø© Ù…Ø±ÙˆØ± Ø§Ù„Ù…Ø´Ø±Ù Ø¨Ù†Ø¬Ø§Ø­');
            };
            
            const resetAllData = () => {
                if (window.confirm('âš ï¸ Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ù…Ø³Ø­ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§ØªØŸ\n\nÙ‡Ø°Ø§ Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡ Ø³ÙŠØ­Ø°Ù Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù†Ù‚Ø§Ø· ÙˆØ§Ù„Ø¥Ù†Ø¬Ø§Ø²Ø§Øª ÙˆÙ„Ø§ ÙŠÙ…ÙƒÙ† Ø§Ù„ØªØ±Ø§Ø¬Ø¹ Ø¹Ù†Ù‡.')) {
                    setData(generateInitialData());
                    alert('ØªÙ… Ù…Ø³Ø­ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ÙˆØ¥Ø¹Ø§Ø¯Ø© Ø§Ù„ØªØ¹ÙŠÙŠÙ†');
                }
            };
            
            const exportData = () => {
                const exportObj = {
                    ...data,
                    exportDate: new Date().toISOString(),
                    version: '2.0'
                };
                
                const dataStr = JSON.stringify(exportObj, null, 2);
                const dataUri = 'data:application/json;charset=utf-8,'+ encodeURIComponent(dataStr);
                
                const exportFileDefaultName = `bayan-backup-${new Date().toISOString().split('T')[0]}.json`;
                
                const linkElement = document.createElement('a');
                linkElement.setAttribute('href', dataUri);
                linkElement.setAttribute('download', exportFileDefaultName);
                linkElement.click();
            };
            
            const importData = (event) => {
                const file = event.target.files[0];
                if (!file) return;
                
                const reader = new FileReader();
                reader.onload = (e) => {
                    try {
                        const importedData = JSON.parse(e.target.result);
                        
                        if (!importedData.stations || !importedData.settings) {
                            throw new Error('Ù…Ù„Ù ØºÙŠØ± ØµØ§Ù„Ø­');
                        }
                        
                        if (window.confirm('Ù‡Ù„ ØªØ±ÙŠØ¯ Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§ØªØŸ Ø³ÙŠØªÙ… Ø§Ø³ØªØ¨Ø¯Ø§Ù„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø­Ø§Ù„ÙŠØ©.')) {
                            setData(importedData);
                            alert('ØªÙ… Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¨Ù†Ø¬Ø§Ø­');
                        }
                    } catch (error) {
                        alert('Ø®Ø·Ø£ ÙÙŠ Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª: ' + error.message);
                    }
                };
                reader.readAsText(file);
            };
            
            // Ø¯Ø§Ù„Ø© ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ø¥Ù†Ø¬Ø§Ø²Ø§Øª Ù„Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø£Ø¯Ø§Ø¡ ÙƒÙ„ Ø¨Ø±Ù†Ø§Ù…Ø¬
            const getProgramPerformance = (achievements) => {
                const performance = {};
                
                achievements.forEach(achievement => {
                    const programName = achievement.description;
                    if (programName) {
                        if (!performance[programName]) {
                            performance[programName] = {
                                total: 0,
                                count: 0
                            };
                        }
                        performance[programName].total += achievement.liters;
                        performance[programName].count++;
                    }
                });
                
                return performance;
            };
            
            // Ø¯Ø§Ù„Ø© ØªØµØ¯ÙŠØ± Excel Ø§Ù„Ù…Ø¹Ø¯Ù„Ø©
            const exportToExcel = () => {
                try {
                    // Ø¥Ù†Ø´Ø§Ø¡ Ù…ØµÙ†Ù Excel Ø¬Ø¯ÙŠØ¯
                    const wb = XLSX.utils.book_new();
                    
                    // ===== ÙˆØ±Ù‚Ø© Ø§Ù„Ø·Ù„Ø§Ø¨ =====
                    const studentsData = [];
                    
                    // Ø¹Ù†ÙˆØ§Ù† Ø§Ù„ÙˆØ±Ù‚Ø©
                    studentsData.push(['ðŸ“Š ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ø·Ù„Ø§Ø¨', '', '', '', '']);
                    studentsData.push(['ØªØ§Ø±ÙŠØ® Ø§Ù„ØªØµØ¯ÙŠØ±', new Date().toLocaleDateString('ar-SA'), '', '', '']);
                    studentsData.push([]); // Ø³Ø·Ø± ÙØ§Ø±Øº
                    
                    // Ø±Ø¤ÙˆØ³ Ø§Ù„Ø£Ø¹Ù…Ø¯Ø©
                    studentsData.push([
                        'Ø§Ù„Ù…Ø³Ù„Ø³Ù„',
                        'Ø§Ø³Ù… Ø§Ù„Ø·Ø§Ù„Ø¨', 
                        'Ø§Ù„Ù…Ø­Ø·Ø©', 
                        `Ø§Ù„Ù†Ù‚Ø§Ø· (${data.settings.currency})`, 
                        'Ø§Ù„Ø±ØªØ¨Ø©'
                    ]);
                    
                    // Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø·Ù„Ø§Ø¨
                    let studentCounter = 1;
                    data.stations.forEach(station => {
                        station.students.forEach(student => {
                            const rank = getRank(student.liters);
                            studentsData.push([
                                studentCounter++,
                                student.name,
                                station.name,
                                student.liters,
                                rank.icon
                            ]);
                        });
                    });
                    
                    // Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„Ø·Ù„Ø§Ø¨
                    studentsData.push([]); // Ø³Ø·Ø± ÙØ§Ø±Øº
                    studentsData.push(['Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª:', '', '', '', '']);
                    studentsData.push(['Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø·Ù„Ø§Ø¨', studentCounter - 1, '', '', '']);
                    studentsData.push(['Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ø­Ø·Ø§Øª', data.stations.length, '', '', '']);
                    
                    // Ø¥Ù†Ø´Ø§Ø¡ ÙˆØ±Ù‚Ø© Ø§Ù„Ø·Ù„Ø§Ø¨
                    const wsStudents = XLSX.utils.aoa_to_sheet(studentsData);
                    
                    // ===== ÙˆØ±Ù‚Ø© Ø§Ù„Ù…Ø­Ø·Ø§Øª =====
                    const stationsData = [];
                    
                    // Ø¹Ù†ÙˆØ§Ù† Ø§Ù„ÙˆØ±Ù‚Ø©
                    stationsData.push(['ðŸ  ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ù…Ø­Ø·Ø§Øª', '', '', '']);
                    stationsData.push([]); // Ø³Ø·Ø± ÙØ§Ø±Øº
                    
                    // Ø±Ø¤ÙˆØ³ Ø§Ù„Ø£Ø¹Ù…Ø¯Ø©
                    stationsData.push([
                        'Ø§Ù„Ù…Ø³Ù„Ø³Ù„',
                        'Ø§Ø³Ù… Ø§Ù„Ù…Ø­Ø·Ø©', 
                        `Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù†Ù‚Ø§Ø· (${data.settings.currency})`, 
                        'Ø¹Ø¯Ø¯ Ø§Ù„Ø·Ù„Ø§Ø¨'
                    ]);
                    
                    // Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø­Ø·Ø§Øª
                    let stationCounter = 1;
                    data.stations.forEach(station => {
                        stationsData.push([
                            stationCounter++,
                            station.name,
                            station.totalLiters,
                            station.students.length
                        ]);
                    });
                    
                    // Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„Ù…Ø­Ø·Ø§Øª
                    stationsData.push([]); // Ø³Ø·Ø± ÙØ§Ø±Øº
                    stationsData.push(['Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª:', '', '', '']);
                    stationsData.push(['Ø£Ø¹Ù„Ù‰ Ù…Ø­Ø·Ø©', data.stations.reduce((max, s) => s.totalLiters > max.totalLiters ? s : max, data.stations[0]).name, '', '']);
                    stationsData.push(['Ø£Ø¯Ù†Ù‰ Ù…Ø­Ø·Ø©', data.stations.reduce((min, s) => s.totalLiters < min.totalLiters ? s : min, data.stations[0]).name, '', '']);
                    stationsData.push(['Ø§Ù„Ù…Ø¹Ø¯Ù„ Ù„Ù„Ù…Ø­Ø·Ø©', Math.round(data.stations.reduce((sum, s) => sum + s.totalLiters, 0) / data.stations.length), '', '']);
                    
                    // Ø¥Ù†Ø´Ø§Ø¡ ÙˆØ±Ù‚Ø© Ø§Ù„Ù…Ø­Ø·Ø§Øª
                    const wsStations = XLSX.utils.aoa_to_sheet(stationsData);
                    
                    // ===== ÙˆØ±Ù‚Ø© Ø§Ù„Ø¨Ø±Ø§Ù…Ø¬ Ø§Ù„Ø£Ø³Ø±ÙŠØ© Ø§Ù„ØªÙØµÙŠÙ„ÙŠØ© =====
                    const familyPerformanceData = [];
                    
                    // Ø¹Ù†ÙˆØ§Ù† Ø§Ù„ÙˆØ±Ù‚Ø©
                    familyPerformanceData.push(['ðŸ  Ø£Ø¯Ø§Ø¡ Ø§Ù„Ø£Ø³Ø± ÙÙŠ Ø§Ù„Ø¨Ø±Ø§Ù…Ø¬ Ø§Ù„Ø£Ø³Ø±ÙŠØ©', '', '', '', '']);
                    familyPerformanceData.push(['ØªØ§Ø±ÙŠØ® Ø§Ù„ØªØµØ¯ÙŠØ±', new Date().toLocaleDateString('ar-SA'), '', '', '']);
                    familyPerformanceData.push([]); // Ø³Ø·Ø± ÙØ§Ø±Øº
                    
                    // Ø¬Ù…Ø¹ ÙƒÙ„ Ø¨Ø±Ø§Ù…Ø¬ Ø§Ù„Ø£Ø³Ø±ÙŠØ© ÙÙŠ Ù‚Ø§Ø¦Ù…Ø©
                    const allFamilyPrograms = [];
                    Object.values(data.programs.family).forEach(category => {
                        category.programs.forEach(program => {
                            allFamilyPrograms.push(program.name);
                        });
                    });
                    
                    // Ø¥Ø²Ø§Ù„Ø© Ø§Ù„ØªÙƒØ±Ø§Ø±Ø§Øª
                    const uniqueFamilyPrograms = [...new Set(allFamilyPrograms)];
                    
                    // Ø±Ø¤ÙˆØ³ Ø§Ù„Ø£Ø¹Ù…Ø¯Ø© Ù„Ù„Ù…Ø­Ø·Ø§Øª ÙˆØ§Ù„Ø¨Ø±Ø§Ù…Ø¬
                    const familyHeaders = ['Ø§Ø³Ù… Ø§Ù„Ù…Ø­Ø·Ø©', 'Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù†Ù‚Ø§Ø·', ...uniqueFamilyPrograms];
                    familyPerformanceData.push(familyHeaders);
                    
                    // Ø¨ÙŠØ§Ù†Ø§Øª Ø£Ø¯Ø§Ø¡ ÙƒÙ„ Ù…Ø­Ø·Ø© ÙÙŠ ÙƒÙ„ Ø¨Ø±Ù†Ø§Ù…Ø¬
                    data.stations.forEach(station => {
                        const stationPerformance = getProgramPerformance(station.familyAchievements || []);
                        const rowData = [station.name, station.totalLiters];
                        
                        // Ù„ÙƒÙ„ Ø¨Ø±Ù†Ø§Ù…Ø¬ØŒ Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù†Ù‚Ø§Ø· Ø§Ù„Ù…Ø­ØµÙ„ Ø¹Ù„ÙŠÙ‡Ø§
                        uniqueFamilyPrograms.forEach(programName => {
                            const performance = stationPerformance[programName];
                            rowData.push(performance ? performance.total : 0);
                        });
                        
                        familyPerformanceData.push(rowData);
                    });
                    
                    // Ø¥Ù†Ø´Ø§Ø¡ ÙˆØ±Ù‚Ø© Ø§Ù„Ø£Ø¯Ø§Ø¡ Ø§Ù„Ø£Ø³Ø±ÙŠ
                    const wsFamilyPerformance = XLSX.utils.aoa_to_sheet(familyPerformanceData);
                    
                    // ===== ÙˆØ±Ù‚Ø© Ø§Ù„Ø¨Ø±Ø§Ù…Ø¬ Ø§Ù„ÙØ±Ø¯ÙŠØ© Ø§Ù„ØªÙØµÙŠÙ„ÙŠØ© =====
                    const individualPerformanceData = [];
                    
                    // Ø¹Ù†ÙˆØ§Ù† Ø§Ù„ÙˆØ±Ù‚Ø©
                    individualPerformanceData.push(['ðŸ‘¤ Ø£Ø¯Ø§Ø¡ Ø§Ù„Ø·Ù„Ø§Ø¨ ÙÙŠ Ø§Ù„Ø¨Ø±Ø§Ù…Ø¬ Ø§Ù„ÙØ±Ø¯ÙŠØ©', '', '', '', '']);
                    individualPerformanceData.push(['ØªØ§Ø±ÙŠØ® Ø§Ù„ØªØµØ¯ÙŠØ±', new Date().toLocaleDateString('ar-SA'), '', '', '']);
                    individualPerformanceData.push([]); // Ø³Ø·Ø± ÙØ§Ø±Øº
                    
                    // Ø¬Ù…Ø¹ ÙƒÙ„ Ø¨Ø±Ø§Ù…Ø¬ Ø§Ù„ÙØ±Ø¯ÙŠØ© ÙÙŠ Ù‚Ø§Ø¦Ù…Ø©
                    const allIndividualPrograms = [];
                    Object.values(data.programs.individual).forEach(category => {
                        category.programs.forEach(program => {
                            allIndividualPrograms.push(program.name);
                        });
                    });
                    
                    // Ø¥Ø²Ø§Ù„Ø© Ø§Ù„ØªÙƒØ±Ø§Ø±Ø§Øª
                    const uniqueIndividualPrograms = [...new Set(allIndividualPrograms)];
                    
                    // Ø±Ø¤ÙˆØ³ Ø§Ù„Ø£Ø¹Ù…Ø¯Ø© Ù„Ù„Ø·Ù„Ø§Ø¨ ÙˆØ§Ù„Ø¨Ø±Ø§Ù…Ø¬
                    const individualHeaders = ['Ø§Ø³Ù… Ø§Ù„Ø·Ø§Ù„Ø¨', 'Ø§Ù„Ù…Ø­Ø·Ø©', 'Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù†Ù‚Ø§Ø·', ...uniqueIndividualPrograms];
                    individualPerformanceData.push(individualHeaders);
                    
                    // Ø¨ÙŠØ§Ù†Ø§Øª Ø£Ø¯Ø§Ø¡ ÙƒÙ„ Ø·Ø§Ù„Ø¨ ÙÙŠ ÙƒÙ„ Ø¨Ø±Ù†Ø§Ù…Ø¬
                    let individualCounter = 1;
                    data.stations.forEach(station => {
                        station.students.forEach(student => {
                            const studentPerformance = getProgramPerformance(student.achievements || []);
                            const rowData = [student.name, station.name, student.liters];
                            
                            // Ù„ÙƒÙ„ Ø¨Ø±Ù†Ø§Ù…Ø¬ØŒ Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù†Ù‚Ø§Ø· Ø§Ù„Ù…Ø­ØµÙ„ Ø¹Ù„ÙŠÙ‡Ø§
                            uniqueIndividualPrograms.forEach(programName => {
                                const performance = studentPerformance[programName];
                                rowData.push(performance ? performance.total : 0);
                            });
                            
                            individualPerformanceData.push(rowData);
                            individualCounter++;
                        });
                    });
                    
                    // Ø¥Ù†Ø´Ø§Ø¡ ÙˆØ±Ù‚Ø© Ø§Ù„Ø£Ø¯Ø§Ø¡ Ø§Ù„ÙØ±Ø¯ÙŠ
                    const wsIndividualPerformance = XLSX.utils.aoa_to_sheet(individualPerformanceData);
                    
                    // ===== ÙˆØ±Ù‚Ø© Ø§Ù„Ø¨Ø±Ø§Ù…Ø¬ Ø§Ù„Ø£Ø³Ø±ÙŠØ© =====
                    const familyProgramsData = [];
                    
                    // Ø¹Ù†ÙˆØ§Ù† Ø§Ù„ÙˆØ±Ù‚Ø©
                    familyProgramsData.push(['ðŸ  Ø§Ù„Ø¨Ø±Ø§Ù…Ø¬ Ø§Ù„Ø£Ø³Ø±ÙŠØ©', '', '', '', '']);
                    familyProgramsData.push([]); // Ø³Ø·Ø± ÙØ§Ø±Øº
                    
                    // Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¨Ø±Ø§Ù…Ø¬ Ø§Ù„Ø£Ø³Ø±ÙŠØ©
                    Object.entries(data.programs.family).forEach(([categoryKey, category]) => {
                        familyProgramsData.push([`ðŸ“ ${category.name}`, '', '', '', '']);
                        familyProgramsData.push(['Ø§Ø³Ù… Ø§Ù„Ø¨Ø±Ù†Ø§Ù…Ø¬', `Ø§Ù„Ø­Ø¯ Ø§Ù„Ø£Ù‚ØµÙ‰ (${data.settings.currency})`, 'ØªÙ‚ÙŠÙŠÙ… Ø­Ø±', 'Ø¹Ø¯Ø¯ Ø§Ù„Ù…Ø¹Ø§ÙŠÙŠØ±', 'Ø§Ù„Ù…Ø¹Ø§ÙŠÙŠØ±']);
                        
                        category.programs.forEach(program => {
                            const criteriaList = program.criteria.map(c => `${c.name}: ${c.pct}%`).join(', ');
                            familyProgramsData.push([
                                program.name,
                                program.max,
                                program.free ? 'Ù†Ø¹Ù…' : 'Ù„Ø§',
                                program.criteria.length,
                                criteriaList || 'Ù„Ø§ ÙŠÙˆØ¬Ø¯'
                            ]);
                        });
                        
                        familyProgramsData.push([]); // Ø³Ø·Ø± ÙØ§Ø±Øº
                    });
                    
                    // Ø¥Ù†Ø´Ø§Ø¡ ÙˆØ±Ù‚Ø© Ø§Ù„Ø¨Ø±Ø§Ù…Ø¬ Ø§Ù„Ø£Ø³Ø±ÙŠØ©
                    const wsFamilyPrograms = XLSX.utils.aoa_to_sheet(familyProgramsData);
                    
                    // ===== ÙˆØ±Ù‚Ø© Ø§Ù„Ø¨Ø±Ø§Ù…Ø¬ Ø§Ù„ÙØ±Ø¯ÙŠØ© =====
                    const individualProgramsData = [];
                    
                    // Ø¹Ù†ÙˆØ§Ù† Ø§Ù„ÙˆØ±Ù‚Ø©
                    individualProgramsData.push(['ðŸ‘¤ Ø§Ù„Ø¨Ø±Ø§Ù…Ø¬ Ø§Ù„ÙØ±Ø¯ÙŠØ©', '', '', '', '']);
                    individualProgramsData.push([]); // Ø³Ø·Ø± ÙØ§Ø±Øº
                    
                    // Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¨Ø±Ø§Ù…Ø¬ Ø§Ù„ÙØ±Ø¯ÙŠØ©
                    Object.entries(data.programs.individual).forEach(([categoryKey, category]) => {
                        individualProgramsData.push([`ðŸ“ ${category.name}`, '', '', '', '']);
                        individualProgramsData.push(['Ø§Ø³Ù… Ø§Ù„Ø¨Ø±Ù†Ø§Ù…Ø¬', `Ø§Ù„Ø­Ø¯ Ø§Ù„Ø£Ù‚ØµÙ‰ (${data.settings.currency})`, 'ØªÙ‚ÙŠÙŠÙ… Ø­Ø±', 'Ø¹Ø¯Ø¯ Ø§Ù„Ù…Ø¹Ø§ÙŠÙŠØ±', 'Ø§Ù„Ù…Ø¹Ø§ÙŠÙŠØ±']);
                        
                        category.programs.forEach(program => {
                            const criteriaList = program.criteria.map(c => `${c.name}: ${c.pct}%`).join(', ');
                            individualProgramsData.push([
                                program.name,
                                program.max,
                                program.free ? 'Ù†Ø¹Ù…' : 'Ù„Ø§',
                                program.criteria.length,
                                criteriaList || 'Ù„Ø§ ÙŠÙˆØ¬Ø¯'
                            ]);
                        });
                        
                        individualProgramsData.push([]); // Ø³Ø·Ø± ÙØ§Ø±Øº
                    });
                    
                    // Ø¥Ù†Ø´Ø§Ø¡ ÙˆØ±Ù‚Ø© Ø§Ù„Ø¨Ø±Ø§Ù…Ø¬ Ø§Ù„ÙØ±Ø¯ÙŠØ©
                    const wsIndividualPrograms = XLSX.utils.aoa_to_sheet(individualProgramsData);
                    
                    // ===== Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø£ÙˆØ±Ø§Ù‚ Ø¥Ù„Ù‰ Ø§Ù„Ù…ØµÙ†Ù =====
                    XLSX.utils.book_append_sheet(wb, wsStudents, 'Ø§Ù„Ø·Ù„Ø§Ø¨');
                    XLSX.utils.book_append_sheet(wb, wsStations, 'Ø§Ù„Ù…Ø­Ø·Ø§Øª');
                    XLSX.utils.book_append_sheet(wb, wsFamilyPerformance, 'Ø£Ø¯Ø§Ø¡ Ø§Ù„Ø£Ø³Ø±');
                    XLSX.utils.book_append_sheet(wb, wsIndividualPerformance, 'Ø£Ø¯Ø§Ø¡ Ø§Ù„Ø·Ù„Ø§Ø¨');
                    XLSX.utils.book_append_sheet(wb, wsFamilyPrograms, 'Ø§Ù„Ø¨Ø±Ø§Ù…Ø¬ Ø§Ù„Ø£Ø³Ø±ÙŠØ©');
                    XLSX.utils.book_append_sheet(wb, wsIndividualPrograms, 'Ø§Ù„Ø¨Ø±Ø§Ù…Ø¬ Ø§Ù„ÙØ±Ø¯ÙŠØ©');
                    
                    // ===== ØªÙ†Ø³ÙŠÙ‚ Ø§Ù„Ø£Ø¹Ù…Ø¯Ø© =====
                    // ØªÙ†Ø³ÙŠÙ‚ Ø£Ø¹Ù…Ø¯Ø© ÙˆØ±Ù‚Ø© Ø§Ù„Ø·Ù„Ø§Ø¨
                    const wscols = [
                        {wch: 8},  // Ø§Ù„Ù…Ø³Ù„Ø³Ù„
                        {wch: 25}, // Ø§Ø³Ù… Ø§Ù„Ø·Ø§Ù„Ø¨
                        {wch: 15}, // Ø§Ù„Ù…Ø­Ø·Ø©
                        {wch: 12}, // Ø§Ù„Ù†Ù‚Ø§Ø·
                        {wch: 10}  // Ø§Ù„Ø±ØªØ¨Ø©
                    ];
                    wsStudents['!cols'] = wscols;
                    
                    // ØªÙ†Ø³ÙŠÙ‚ Ø£Ø¹Ù…Ø¯Ø© ÙˆØ±Ù‚Ø© Ø§Ù„Ø£Ø¯Ø§Ø¡ Ø§Ù„Ø£Ø³Ø±ÙŠ
                    const familyPerfCols = [{wch: 20}, {wch: 15}];
                    uniqueFamilyPrograms.forEach(() => familyPerfCols.push({wch: 12}));
                    wsFamilyPerformance['!cols'] = familyPerfCols;
                    
                    // ØªÙ†Ø³ÙŠÙ‚ Ø£Ø¹Ù…Ø¯Ø© ÙˆØ±Ù‚Ø© Ø§Ù„Ø£Ø¯Ø§Ø¡ Ø§Ù„ÙØ±Ø¯ÙŠ
                    const individualPerfCols = [{wch: 25}, {wch: 15}, {wch: 12}];
                    uniqueIndividualPrograms.forEach(() => individualPerfCols.push({wch: 12}));
                    wsIndividualPerformance['!cols'] = individualPerfCols;
                    
                    // ===== ØªØµØ¯ÙŠØ± Ø§Ù„Ù…Ù„Ù =====
                    const fileName = `bayan-report-${new Date().toISOString().split('T')[0]}.xlsx`;
                    XLSX.writeFile(wb, fileName);
                    
                    alert(`ØªÙ… ØªØµØ¯ÙŠØ± Ø§Ù„ØªÙ‚Ø±ÙŠØ± Ø¨Ù†Ø¬Ø§Ø­ Ø¥Ù„Ù‰ ${fileName}\n\nÙŠØ´Ù…Ù„:\n- Ø§Ù„Ø·Ù„Ø§Ø¨ ÙˆØ§Ù„Ù…Ø­Ø·Ø§Øª\n- Ø£Ø¯Ø§Ø¡ ÙƒÙ„ Ø£Ø³Ø±Ø© ÙÙŠ ÙƒÙ„ Ø¨Ø±Ù†Ø§Ù…Ø¬ Ø£Ø³Ø±ÙŠ\n- Ø£Ø¯Ø§Ø¡ ÙƒÙ„ Ø·Ø§Ù„Ø¨ ÙÙŠ ÙƒÙ„ Ø¨Ø±Ù†Ø§Ù…Ø¬ ÙØ±Ø¯ÙŠ\n- Ù‚ÙˆØ§Ø¦Ù… Ø§Ù„Ø¨Ø±Ø§Ù…Ø¬ ÙˆØ§Ù„Ù…Ø¹Ø§ÙŠÙŠØ±`);
                } catch (error) {
                    console.error('Ø®Ø·Ø£ ÙÙŠ ØªØµØ¯ÙŠØ± Excel:', error);
                    alert('Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ ØªØµØ¯ÙŠØ± Ø§Ù„ØªÙ‚Ø±ÙŠØ±. ÙŠØ±Ø¬Ù‰ Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø© Ù…Ø±Ø© Ø£Ø®Ø±Ù‰.');
                }
            };
            
            const renderGeneralSettings = () => (
                <div>
                    <div className="card" style={{ marginBottom: '15px' }}>
                        <div className="flex justify-between align-center">
                            <div>
                                <div style={{ color: '#fff', fontWeight: '600', marginBottom: '5px' }}>
                                    ðŸ”’ Ø¥Ø®ÙØ§Ø¡ Ø§Ù„Ù†Ù‚Ø§Ø·
                                </div>
                                <div style={{ color: 'rgba(255, 255, 255, 0.6)', fontSize: '0.9rem' }}>
                                    Ø¥Ø®ÙØ§Ø¡ Ù†Ù‚Ø§Ø· Ø§Ù„Ø·Ù„Ø§Ø¨ Ù…Ø¤Ù‚ØªØ§Ù‹
                                </div>
                            </div>
                            <button
                                onClick={() => setData(prev => ({
                                    ...prev,
                                    settings: { ...prev.settings, pointsHidden: !prev.settings.pointsHidden }
                                }))}
                                style={{
                                    width: '60px',
                                    height: '30px',
                                    borderRadius: '15px',
                                    background: data.settings.pointsHidden ? '#00C853' : 'rgba(255, 255, 255, 0.2)',
                                    border: 'none',
                                    position: 'relative',
                                    cursor: 'pointer'
                                }}
                            >
                                <div style={{
                                    width: '26px',
                                    height: '26px',
                                    borderRadius: '50%',
                                    background: '#fff',
                                    position: 'absolute',
                                    top: '2px',
                                    right: data.settings.pointsHidden ? '2px' : '32px',
                                    transition: 'all 0.3s'
                                }} />
                            </button>
                        </div>
                    </div>
                    
                    <div className="card" style={{ marginBottom: '15px' }}>
                        <h4 style={{ color: '#fff', marginBottom: '15px' }}>
                            ðŸ  ØªØ¹Ø¯ÙŠÙ„ Ø£Ø³Ù…Ø§Ø¡ Ø§Ù„Ù…Ø­Ø·Ø§Øª ÙˆØ±Ø¤Ø³Ø§Ø¡ Ø§Ù„Ø£Ø³Ø±
                        </h4>
                        
                        {data.stations.map(station => (
                            <div key={station.id} style={{ marginBottom: '15px', padding: '10px', background: 'rgba(255,255,255,0.03)', borderRadius: '8px' }}>
                                <label style={{ color: station.color, display: 'block', marginBottom: '5px' }}>
                                    Ù…Ø¹Ø±Ù Ø§Ù„Ù…Ø­Ø·Ø©: {station.id}
                                </label>
                                <input
                                    value={stationNames[station.id] || station.name}
                                    onChange={(e) => setStationNames({
                                        ...stationNames,
                                        [station.id]: e.target.value
                                    })}
                                    placeholder="Ø§Ø³Ù… Ø§Ù„Ù…Ø­Ø·Ø©"
                                    style={{ width: '100%', marginBottom: '8px' }}
                                />
                                <input
                                    value={stationHeads[station.id] || station.head || ''}
                                    onChange={(e) => setStationHeads({
                                        ...stationHeads,
                                        [station.id]: e.target.value
                                    })}
                                    placeholder="Ø±Ø¦ÙŠØ³ Ø§Ù„Ø£Ø³Ø±Ø© (Ø§Ù„Ø§Ø³Ù… Ø§Ù„ÙƒØ§Ù…Ù„)"
                                    style={{ width: '100%' }}
                                />
                            </div>
                        ))}
                        
                        <button
                            onClick={saveStationNames}
                            className="btn-primary"
                            style={{ width: '100%', marginTop: '10px' }}
                        >
                            Ø­ÙØ¸ Ø£Ø³Ù…Ø§Ø¡ Ø§Ù„Ù…Ø­Ø·Ø§Øª ÙˆØ±Ø¤Ø³Ø§Ø¡ Ø§Ù„Ø£Ø³Ø±
                        </button>
                    </div>
                    
                    <div className="card" style={{ marginBottom: '15px' }}>
                        <label style={{ color: '#fff', display: 'block', marginBottom: '8px' }}>
                            Ø§Ø³Ù… Ø§Ù„Ø¨Ø±Ù†Ø§Ù…Ø¬
                        </label>
                        <input
                            value={data.settings.title}
                            onChange={(e) => setData(prev => ({
                                ...prev,
                                settings: { ...prev.settings, title: e.target.value }
                            }))}
                            style={{ width: '100%' }}
                        />
                    </div>
                    
                    <div className="grid grid-2 gap-2 mb-3">
                        <div className="card">
                            <label style={{ color: '#fff', display: 'block', marginBottom: '8px' }}>
                                Ø§Ø³Ù… Ø§Ù„Ø¹Ù…Ù„Ø©
                            </label>
                            <input
                                value={data.settings.currency}
                                onChange={(e) => setData(prev => ({
                                    ...prev,
                                    settings: { ...prev.settings, currency: e.target.value }
                                }))}
                                style={{ width: '100%' }}
                            />
                        </div>
                        
                        <div className="card">
                            <label style={{ color: '#fff', display: 'block', marginBottom: '8px' }}>
                                Ø£ÙŠÙ‚ÙˆÙ†Ø© Ø§Ù„Ø¹Ù…Ù„Ø©
                            </label>
                            <div className="flex gap-1" style={{ flexWrap: 'wrap' }}>
                                {iconOptions.map(icon => (
                                    <button
                                        key={icon}
                                        onClick={() => setData(prev => ({
                                            ...prev,
                                            settings: { ...prev.settings, currencyIcon: icon }
                                        }))}
                                        style={{
                                            width: '45px',
                                            height: '45px',
                                            background: data.settings.currencyIcon === icon ? `${primaryColor}44` : 'rgba(255, 255, 255, 0.1)',
                                            border: data.settings.currencyIcon === icon ? `2px solid ${primaryColor}` : 'none',
                                            borderRadius: '8px',
                                            fontSize: '1.5rem',
                                            cursor: 'pointer'
                                        }}
                                    >
                                        {icon}
                                    </button>
                                ))}
                            </div>
                        </div>
                    </div>
                    
                    <div className="card" style={{ marginBottom: '15px' }}>
                        <label style={{ color: '#fff', display: 'block', marginBottom: '10px' }}>
                            Ø§Ù„Ù„ÙˆÙ† Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ
                        </label>
                        <div className="flex gap-2" style={{ flexWrap: 'wrap' }}>
                            {colorOptions.map(color => (
                                <div
                                    key={color.value}
                                    onClick={() => setData(prev => ({
                                        ...prev,
                                        settings: { ...prev.settings, primaryColor: color.value }
                                    }))}
                                    style={{
                                        width: '40px',
                                        height: '40px',
                                        borderRadius: '50%',
                                        background: color.value,
                                        border: data.settings.primaryColor === color.value ? '3px solid #fff' : 'none',
                                        cursor: 'pointer',
                                        display: 'flex',
                                        alignItems: 'center',
                                        justifyContent: 'center',
                                        color: '#fff',
                                        fontSize: '0.8rem',
                                        fontWeight: '600'
                                    }}
                                    title={color.name}
                                >
                                    {data.settings.primaryColor === color.value ? 'âœ“' : ''}
                                </div>
                            ))}
                        </div>
                    </div>
                </div>
            );
            
            const renderSecuritySettings = () => (
                <div>
                    <div className="card" style={{ marginBottom: '15px' }}>
                        <h4 style={{ color: '#fff', marginBottom: '15px' }}>
                            ðŸ” ØªØºÙŠÙŠØ± ÙƒÙ„Ù…Ø© Ù…Ø±ÙˆØ± Ø§Ù„Ù…Ø´Ø±Ù
                        </h4>
                        
                        <input
                            type="password"
                            value={currentPassword}
                            onChange={(e) => setCurrentPassword(e.target.value)}
                            placeholder="ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ø§Ù„Ø­Ø§Ù„ÙŠØ©"
                            style={{ width: '100%', marginBottom: '10px' }}
                        />
                        
                        <input
                            type="password"
                            value={newPassword}
                            onChange={(e) => setNewPassword(e.target.value)}
                            placeholder="ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©"
                            style={{ width: '100%', marginBottom: '10px' }}
                        />
                        
                        <input
                            type="password"
                            value={confirmPassword}
                            onChange={(e) => setConfirmPassword(e.target.value)}
                            placeholder="ØªØ£ÙƒÙŠØ¯ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±"
                            style={{ width: '100%', marginBottom: '15px' }}
                        />
                        
                        <button
                            onClick={changeSupervisorPassword}
                            className="btn-primary"
                            style={{ width: '100%' }}
                        >
                            ØªØºÙŠÙŠØ± ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±
                        </button>
                    </div>
                </div>
            );
            
            const renderStudentEditor = () => {
                const allStudents = [];
                data.stations.forEach(station => {
                    station.students.forEach(student => {
                        allStudents.push({ ...student, stationId: station.id, stationName: station.name });
                    });
                });

                return (
                    <div>
                        <button onClick={() => setShowStudentEditor(false)} className="btn-secondary mb-3">â† Ø§Ù„Ø¹ÙˆØ¯Ø©</button>
                        <h3 style={{ color: primaryColor, marginBottom: '20px', textAlign: 'center' }}>
                            ðŸ‘¥ ØªØ¹Ø¯ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø·Ù„Ø§Ø¨
                        </h3>
                        <div style={{ maxHeight: '400px', overflowY: 'auto' }}>
                            {allStudents.map(student => (
                                <div key={student.id} className="card" style={{ marginBottom: '10px' }}>
                                    <div className="grid grid-2 gap-2 mb-2">
                                        <div>
                                            <label style={{display:'block', fontSize:'0.8rem', color:'#aaa'}}>Ø§Ù„Ø§Ø³Ù…</label>
                                            <input 
                                                value={student.name}
                                                onChange={(e) => {
                                                    const newName = e.target.value;
                                                    const oldName = student.name;
                                                    setData(prev => {
                                                        const newData = JSON.parse(JSON.stringify(prev));
                                                        const stStation = newData.stations.find(s => s.id === student.stationId);
                                                        const st = stStation.students.find(s => s.id === student.id);
                                                        if(st) st.name = newName;
                                                        
                                                        if (newData.phoneBook && newData.phoneBook[oldName]) {
                                                            newData.phoneBook[newName] = newData.phoneBook[oldName];
                                                            delete newData.phoneBook[oldName];
                                                        }
                                                        
                                                        return newData;
                                                    });
                                                }}
                                                style={{width:'100%'}}
                                            />
                                        </div>
                                        <div>
                                            <label style={{display:'block', fontSize:'0.8rem', color:'#aaa'}}>Ø±Ù‚Ù… Ø§Ù„Ø¬ÙˆØ§Ù„</label>
                                            <input 
                                                value={(data.phoneBook && data.phoneBook[student.name]) || ''}
                                                placeholder="966..."
                                                onChange={(e) => {
                                                    const newPhone = e.target.value;
                                                    setData(prev => {
                                                        const newData = JSON.parse(JSON.stringify(prev));
                                                        if (!newData.phoneBook) newData.phoneBook = {};
                                                        newData.phoneBook[student.name] = newPhone;
                                                        return newData;
                                                    });
                                                }}
                                                style={{width:'100%'}}
                                            />
                                        </div>
                                    </div>
                                    <div>
                                        <label style={{display:'block', fontSize:'0.8rem', color:'#aaa'}}>Ø§Ù„Ù…Ø­Ø·Ø© (Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø©)</label>
                                        <select 
                                            value={student.stationId}
                                            onChange={(e) => {
                                                const newStationId = e.target.value;
                                                if (newStationId === student.stationId) return;
                                                
                                                setData(prev => {
                                                    const newData = JSON.parse(JSON.stringify(prev));
                                                    const oldStation = newData.stations.find(s => s.id === student.stationId);
                                                    if (oldStation) {
                                                        const studentIndex = oldStation.students.findIndex(s => s.id === student.id);
                                                        if(studentIndex !== -1) {
                                                            const studentObj = oldStation.students[studentIndex];
                                                            oldStation.students.splice(studentIndex, 1);
                                                            
                                                            const newStation = newData.stations.find(s => s.id === newStationId);
                                                            if (newStation) newStation.students.push(studentObj);
                                                        }
                                                    }
                                                    return newData;
                                                });
                                            }}
                                            style={{width:'100%'}}
                                        >
                                            {data.stations.map(s => <option key={s.id} value={s.id}>{s.name}</option>)}
                                        </select>
                                    </div>
                                </div>
                            ))}
                        </div>
                    </div>
                );
            };

            const renderDataManagement = () => {
                if (showStudentEditor) return renderStudentEditor();

                return (
                <div>
                    <h3 style={{ color: primaryColor, marginBottom: '20px', textAlign: 'center' }}>
                        ðŸ“Š Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
                    </h3>
                    
                    <button
                        onClick={() => setShowStudentEditor(true)}
                        className="btn-primary"
                        style={{ width: '100%', marginBottom: '15px', padding: '15px' }}
                    >
                        ðŸ‘¥ ØªØ¹Ø¯ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø·Ù„Ø§Ø¨
                    </button>
                    
                    <div className="grid grid-2 gap-2 mb-3">
                        <button
                            onClick={exportData}
                            className="btn-success"
                        >
                            ðŸ’¾ ØªØµØ¯ÙŠØ± JSON
                        </button>
                        
                        <label className="btn-primary" style={{ textAlign: 'center', cursor: 'pointer' }}>
                            ðŸ“‚ Ø§Ø³ØªÙŠØ±Ø§Ø¯ JSON
                            <input
                                type="file"
                                accept=".json"
                                onChange={importData}
                                style={{ display: 'none' }}
                            />
                        </label>
                    </div>
                    
                    <div className="grid grid-1 gap-2 mb-3">
                        <button
                            onClick={exportToExcel}
                            className="btn-excel"
                            style={{ width: '100%', padding: '15px' }}
                        >
                            ðŸ“Š ØªØµØ¯ÙŠØ± ØªÙ‚Ø±ÙŠØ± Excel Ù…ØªÙƒØ§Ù…Ù„
                        </button>
                        
                        <div style={{ textAlign: 'center', color: 'rgba(255, 255, 255, 0.6)', fontSize: '0.9rem' }}>
                            ÙŠØªØ¶Ù…Ù†:<br/>
                            - Ø§Ù„Ø·Ù„Ø§Ø¨ ÙˆØ§Ù„Ù…Ø­Ø·Ø§Øª<br/>
                            - Ø£Ø¯Ø§Ø¡ ÙƒÙ„ Ø£Ø³Ø±Ø© ÙÙŠ ÙƒÙ„ Ø¨Ø±Ù†Ø§Ù…Ø¬ Ø£Ø³Ø±ÙŠ<br/>
                            - Ø£Ø¯Ø§Ø¡ ÙƒÙ„ Ø·Ø§Ù„Ø¨ ÙÙŠ ÙƒÙ„ Ø¨Ø±Ù†Ø§Ù…Ø¬ ÙØ±Ø¯ÙŠ<br/>
                            - Ù‚ÙˆØ§Ø¦Ù… Ø§Ù„Ø¨Ø±Ø§Ù…Ø¬ ÙˆØ§Ù„Ù…Ø¹Ø§ÙŠÙŠØ±
                        </div>
                    </div>
                    
                    <button
                        onClick={resetAllData}
                        className="btn-danger"
                        style={{ width: '100%', marginBottom: '15px', padding: '15px' }}
                    >
                        ðŸ—‘ï¸ Ù…Ø³Ø­ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ÙˆØ¥Ø¹Ø§Ø¯Ø© Ø§Ù„ØªØ¹ÙŠÙŠÙ†
                    </button>
                </div>
            ); };

            const renderThemeSettings = () => {
                const activeThemeKey = data.settings.theme || 'classic';
                return (
                    <div className="card">
                        <h4 style={{ color: '#fff', marginBottom: '20px', textAlign: 'center', fontSize: '1.2rem' }}>
                            ðŸŽ¨ ØªØºÙŠÙŠØ± Ø§Ù„ØªØµÙ…ÙŠÙ…
                        </h4>
                        <div className="grid grid-2 gap-2">
                            {Object.entries(themes).map(([key, theme]) => (
                                <div
                                    key={key}
                                    onClick={() => setData(prev => ({
                                        ...prev,
                                        settings: { ...prev.settings, theme: key, primaryColor: theme.primaryColor }
                                    }))}
                                    className="card"
                                    style={{
                                        textAlign: 'center',
                                        cursor: 'pointer',
                                        border: activeThemeKey === key ? `3px solid ${theme.primaryColor}` : '1px solid rgba(255,255,255,0.1)',
                                        background: activeThemeKey === key ? `${theme.primaryColor}22` : 'rgba(255,255,255,0.03)',
                                        padding: '20px 15px',
                                        borderRadius: theme.cardRadius,
                                        transition: 'all 0.3s ease',
                                        position: 'relative',
                                        overflow: 'hidden'
                                    }}
                                >
                                    {activeThemeKey === key && (
                                        <div style={{
                                            position: 'absolute',
                                            top: '8px',
                                            left: '8px',
                                            width: '24px',
                                            height: '24px',
                                            borderRadius: '50%',
                                            background: theme.primaryColor,
                                            display: 'flex',
                                            alignItems: 'center',
                                            justifyContent: 'center',
                                            fontSize: '0.7rem',
                                            color: '#1a1a2e',
                                            fontWeight: '900'
                                        }}>âœ“</div>
                                    )}
                                    <div style={{ fontSize: '2rem', marginBottom: '8px' }}>{theme.icon}</div>
                                    <div style={{ fontSize: '1.2rem', fontWeight: '700', color: theme.primaryColor, marginBottom: '8px' }}>{theme.name}</div>
                                    <div style={{
                                        display: 'flex',
                                        justifyContent: 'center',
                                        gap: '4px',
                                        marginBottom: '10px'
                                    }}>
                                        <div style={{ width: '20px', height: '8px', borderRadius: '4px', background: theme.primaryColor }}/>
                                        <div style={{ width: '20px', height: '8px', borderRadius: '4px', background: theme.secondaryColor }}/>
                                        <div style={{ width: '20px', height: '8px', borderRadius: '4px', background: theme.accentColor }}/>
                                    </div>
                                    <div style={{ fontSize: '0.75rem', color: 'rgba(255,255,255,0.5)', lineHeight: '1.6' }}>{theme.poetry.substring(0, 30)}...</div>
                                </div>
                            ))}
                        </div>
                    </div>
                );
            };
            
            const renderContent = () => {
                switch(activeTab) {
                    case 'general': return renderGeneralSettings();
                    case 'security': return renderSecuritySettings();
                    case 'data': return renderDataManagement();
                    case 'theme': return renderThemeSettings();
                    default: return renderGeneralSettings();
                }
            };
            
            return (
                <Modal onClose={onClose} wide>
                    <h2 style={{ color: primaryColor, marginBottom: '25px', textAlign: 'center' }}>
                        âš™ï¸ Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ù†Ø¸Ø§Ù…
                    </h2>
                    
                    <div className="flex mb-3" style={{ borderBottom: '1px solid rgba(255, 255, 255, 0.1)' }}>
                        <button
                            onClick={() => setActiveTab('general')}
                            style={{
                                padding: '12px 20px',
                                background: activeTab === 'general' ? `${primaryColor}22` : 'transparent',
                                border: 'none',
                                color: activeTab === 'general' ? primaryColor : 'rgba(255, 255, 255, 0.6)',
                                fontWeight: '600',
                                borderBottom: activeTab === 'general' ? `2px solid ${primaryColor}` : 'none',
                                cursor: 'pointer'
                            }}
                        >
                            ðŸ  Ø¹Ø§Ù…
                        </button>
                        <button
                            onClick={() => setActiveTab('theme')}
                            style={{
                                padding: '12px 20px',
                                background: activeTab === 'theme' ? `${primaryColor}22` : 'transparent',
                                border: 'none',
                                color: activeTab === 'theme' ? primaryColor : 'rgba(255, 255, 255, 0.6)',
                                fontWeight: '600',
                                borderBottom: activeTab === 'theme' ? `2px solid ${primaryColor}` : 'none',
                                cursor: 'pointer'
                            }}
                        >
                            ðŸŽ¨ Ø§Ù„ØªØµÙ…ÙŠÙ…
                        </button>
                        <button
                            onClick={() => setActiveTab('security')}
                            style={{
                                padding: '12px 20px',
                                background: activeTab === 'security' ? `${primaryColor}22` : 'transparent',
                                border: 'none',
                                color: activeTab === 'security' ? primaryColor : 'rgba(255, 255, 255, 0.6)',
                                fontWeight: '600',
                                borderBottom: activeTab === 'security' ? `2px solid ${primaryColor}` : 'none',
                                cursor: 'pointer'
                            }}
                        >
                            ðŸ” Ø£Ù…Ø§Ù†
                        </button>
                        <button
                            onClick={() => setActiveTab('data')}
                            style={{
                                padding: '12px 20px',
                                background: activeTab === 'data' ? `${primaryColor}22` : 'transparent',
                                border: 'none',
                                color: activeTab === 'data' ? primaryColor : 'rgba(255, 255, 255, 0.6)',
                                fontWeight: '600',
                                borderBottom: activeTab === 'data' ? `2px solid ${primaryColor}` : 'none',
                                cursor: 'pointer'
                            }}
                        >
                            ðŸ’¾ Ø¨ÙŠØ§Ù†Ø§Øª
                        </button>
                    </div>
                    
                    <div style={{ padding: '10px' }}>
                        {renderContent()}
                    </div>
                    
                    <button
                        onClick={onClose}
                        className="btn-primary"
                        style={{ width: '100%', padding: '15px', marginTop: '20px' }}
                    >
                        Ø­ÙØ¸ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª ÙˆØ§Ù„Ø®Ø±ÙˆØ¬
                    </button>
                </Modal>
            );
        };
        
        // ==================== REPORT MODAL ====================
        const ReportModal = ({ data, onClose }) => {
            const [currentSlide, setCurrentSlide] = useState(0);
            const [slideKey, setSlideKey] = useState(0);
            const [top5Phase, setTop5Phase] = useState(0);
            const [top5Timer, setTop5Timer] = useState(null);

            const primaryColor = data.settings.primaryColor;
            const currency = data.settings.currency;
            const currentThemeKey = data.settings.theme || 'classic';
            const currentTheme = themes[currentThemeKey] || themes.classic;

            // Gather all students with station info
            const allStudents = [];
            data.stations.forEach(station => {
                station.students.forEach(student => {
                    allStudents.push({
                        ...student,
                        stationName: station.name,
                        stationColor: station.color,
                        stationId: station.id
                    });
                });
            });

            const sortedStudents = [...allStudents].sort((a, b) => b.liters - a.liters);
            const sortedStations = [...data.stations].sort((a, b) => b.totalLiters - a.totalLiters);

            // ---- Helper: get student scores per individual program category ----
            const getIndividualCategoryScores = (categoryKey) => {
                const cat = data.programs.individual[categoryKey];
                if (!cat || !cat.programs) return [];
                const programNames = cat.programs.map(p => p.name);

                const studentScores = allStudents.map(student => {
                    let total = 0;
                    (student.achievements || []).forEach(a => {
                        if (programNames.includes(a.description)) {
                            total += a.liters;
                        }
                    });
                    return { ...student, categoryScore: total };
                }).filter(s => s.categoryScore > 0);

                return studentScores.sort((a, b) => b.categoryScore - a.categoryScore);
            };

            // ---- Helper: get family scores per family program category ----
            const getFamilyCategoryScores = (categoryKey) => {
                const cat = data.programs.family[categoryKey];
                if (!cat || !cat.programs) return [];
                const programNames = cat.programs.map(p => p.name);

                const stationScores = data.stations.map(station => {
                    let total = 0;
                    (station.familyAchievements || []).forEach(a => {
                        if (programNames.includes(a.description)) {
                            total += a.liters;
                        }
                    });
                    return { ...station, categoryScore: total };
                });

                return stationScores.sort((a, b) => b.categoryScore - a.categoryScore);
            };

            // ---- Helper: get family scores per specific program ----
            const getFamilyProgramScores = (programName) => {
                const stationScores = data.stations.map(station => {
                    let total = 0;
                    (station.familyAchievements || []).forEach(a => {
                        if (a.description === programName) {
                            total += a.liters;
                        }
                    });
                    return { ...station, programScore: total };
                });
                return stationScores.sort((a, b) => b.programScore - a.programScore);
            };

            // ---- Helper: get student scores per specific program ----
            const getStudentProgramScores = (programName) => {
                const studentScores = allStudents.map(student => {
                    let total = 0;
                    (student.achievements || []).forEach(a => {
                        if (a.description === programName) {
                            total += a.liters;
                        }
                    });
                    return { ...student, programScore: total };
                }).filter(s => s.programScore > 0);
                return studentScores.sort((a, b) => b.programScore - a.programScore);
            };

            // ---- PODIUM COMPONENT ----
            const Podium = ({ items, labelKey, scoreKey, colorKey, subtitleKey }) => {
                if (!items || items.length === 0) return null;
                const top3 = items.slice(0, 3);
                const medalColors = ['#FFD700', '#C0C0C0', '#CD7F32'];
                const heights = [180, 140, 110];
                const order = top3.length >= 3 ? [1, 0, 2] : top3.length === 2 ? [1, 0] : [0];

                return (
                    <div style={{ display: 'flex', alignItems: 'flex-end', justifyContent: 'center', gap: '12px', marginTop: '20px', marginBottom: '20px' }}>
                        {order.map(idx => {
                            const item = top3[idx];
                            if (!item) return null;
                            return (
                                <div key={idx} style={{ textAlign: 'center', display: 'flex', flexDirection: 'column', alignItems: 'center' }}>
                                    <div style={{
                                        fontSize: idx === 0 ? '1.3rem' : '1rem',
                                        color: '#fff',
                                        fontWeight: '700',
                                        marginBottom: '8px',
                                        maxWidth: '120px',
                                        lineHeight: '1.3',
                                        ...currentTheme.titleStyle
                                    }}>
                                        {item[labelKey]}
                                    </div>
                                    {subtitleKey && item[subtitleKey] && (
                                        <div style={{ fontSize: '0.75rem', color: item[colorKey] || 'rgba(255,255,255,0.5)', marginBottom: '6px' }}>
                                            {item[subtitleKey]}
                                        </div>
                                    )}
                                    <div style={{
                                        width: idx === 0 ? '120px' : '100px',
                                        height: heights[idx] + 'px',
                                        background: currentTheme.podiumGradient(medalColors[idx]),
                                        borderRadius: `${currentTheme.cardRadius} ${currentTheme.cardRadius} 0 0`,
                                        display: 'flex',
                                        flexDirection: 'column',
                                        alignItems: 'center',
                                        justifyContent: 'flex-end',
                                        paddingBottom: '15px',
                                        border: `2px solid ${medalColors[idx]}`,
                                        borderBottom: 'none',
                                        position: 'relative',
                                        boxShadow: `0 0 15px ${medalColors[idx]}22`
                                    }}>
                                        <div style={{
                                            position: 'absolute',
                                            top: '-20px',
                                            width: '40px',
                                            height: '40px',
                                            borderRadius: '50%',
                                            background: medalColors[idx],
                                            display: 'flex',
                                            alignItems: 'center',
                                            justifyContent: 'center',
                                            fontWeight: '900',
                                            color: '#1a1a2e',
                                            fontSize: '1.2rem',
                                            boxShadow: `0 0 20px ${medalColors[idx]}66`
                                        }}>
                                            {idx + 1}
                                        </div>
                                        <div style={{ color: '#fff', fontWeight: '900', fontSize: idx === 0 ? '1.4rem' : '1.1rem' }}>
                                            {formatNumber(item[scoreKey])}
                                        </div>
                                        <div style={{ color: 'rgba(255,255,255,0.7)', fontSize: '0.7rem' }}>
                                            {currency}
                                        </div>
                                    </div>
                                </div>
                            );
                        })}
                    </div>
                );
            };

            // ---- TABLE COMPONENT ----
            const RankTable = ({ items, labelKey, scoreKey, colorKey, subtitleKey }) => {
                if (!items || items.length <= 3) return null;
                const rest = items.slice(3);
                return (
                    <div style={{ marginTop: '15px', maxHeight: '200px', overflowY: 'auto' }}>
                        <table style={{ width: '100%', borderCollapse: 'collapse' }}>
                            <thead>
                                <tr style={{ borderBottom: '1px solid rgba(255,255,255,0.15)' }}>
                                    <th style={{ padding: '8px', textAlign: 'right', color: primaryColor, fontSize: '0.8rem' }}>#</th>
                                    <th style={{ padding: '8px', textAlign: 'right', color: primaryColor, fontSize: '0.8rem' }}>Ø§Ù„Ø§Ø³Ù…</th>
                                    {subtitleKey && <th style={{ padding: '8px', textAlign: 'right', color: primaryColor, fontSize: '0.8rem' }}>Ø§Ù„Ø£Ø³Ø±Ø©</th>}
                                    <th style={{ padding: '8px', textAlign: 'left', color: primaryColor, fontSize: '0.8rem' }}>Ø§Ù„Ù†Ù‚Ø§Ø·</th>
                                </tr>
                            </thead>
                            <tbody>
                                {rest.map((item, i) => (
                                    <tr key={i} style={{ borderBottom: '1px solid rgba(255,255,255,0.05)', background: i % 2 === 0 ? 'rgba(255,255,255,0.02)' : 'transparent' }}>
                                        <td style={{ padding: '7px 8px', color: 'rgba(255,255,255,0.5)', fontSize: '0.85rem' }}>{i + 4}</td>
                                        <td style={{ padding: '7px 8px', color: '#fff', fontSize: '0.85rem' }}>{item[labelKey]}</td>
                                        {subtitleKey && <td style={{ padding: '7px 8px', color: item[colorKey] || 'rgba(255,255,255,0.4)', fontSize: '0.75rem' }}>{item[subtitleKey]}</td>}
                                        <td style={{ padding: '7px 8px', color: primaryColor, fontWeight: '600', fontSize: '0.85rem', textAlign: 'left' }}>{formatNumber(item[scoreKey])}</td>
                                    </tr>
                                ))}
                            </tbody>
                        </table>
                    </div>
                );
            };

            // ---- BAR CHART COMPONENT (for family programs) ----
            const BarChart = ({ items, labelKey, scoreKey, colorKey }) => {
                const maxScore = Math.max(...items.map(i => i[scoreKey]), 1);
                return (
                    <div style={{ display: 'flex', alignItems: 'flex-end', justifyContent: 'center', gap: '30px', marginTop: '25px', height: '220px' }}>
                        {items.map((item, i) => (
                            <div key={i} style={{ textAlign: 'center', display: 'flex', flexDirection: 'column', alignItems: 'center', justifyContent: 'flex-end', height: '100%' }}>
                                <div style={{ color: '#fff', fontWeight: '700', fontSize: '1rem', marginBottom: '8px' }}>
                                    {formatNumber(item[scoreKey])}
                                </div>
                                <div style={{
                                    width: '80px',
                                    height: `${Math.max((item[scoreKey] / maxScore) * 160, 10)}px`,
                                    background: `linear-gradient(to top, ${item[colorKey]}88, ${item[colorKey]})`,
                                    borderRadius: '8px 8px 0 0',
                                    transition: 'height 1s ease',
                                    border: `1px solid ${item[colorKey]}`,
                                    borderBottom: 'none'
                                }}/>
                                <div style={{
                                    marginTop: '10px',
                                    color: item[colorKey],
                                    fontWeight: '600',
                                    fontSize: '0.9rem'
                                }}>
                                    {item[labelKey]}
                                </div>
                            </div>
                        ))}
                    </div>
                );
            };

            // ============================================================
            //                    BUILD ALL SLIDES
            // ============================================================
            const slides = [];

            // ---- SLIDE 1: Al-Mutanabbi Poetry ----
            slides.push({
                content: (
                    <div style={{ textAlign: 'center', padding: '50px 30px', animation: 'slideUp 1s ease' }}>
                        <div style={{
                            color: primaryColor,
                            fontSize: '1.5rem',
                            marginBottom: '30px',
                            opacity: 0.6
                        }}>{currentTheme.ornament} {currentTheme.ornament} {currentTheme.ornament}</div>
                        <div style={{
                            width: '80px',
                            height: '2px',
                            background: `linear-gradient(to right, transparent, ${primaryColor}, transparent)`,
                            margin: '0 auto 40px'
                        }}/>
                        <h1 style={{
                            fontSize: '2rem',
                            color: primaryColor,
                            lineHeight: '2.2',
                            marginBottom: '15px',
                            fontFamily: 'Tajawal, serif',
                            ...currentTheme.titleStyle
                        }}>
                            Ø§Ø°Ø§ ØºØ§Ù…ÙŽØ±ØªÙŽ ÙÙŠ Ø´ÙŽØ±ÙŽÙÙ Ù…ÙŽØ±ÙˆÙ…Ù
                        </h1>
                        <h1 style={{
                            fontSize: '2rem',
                            color: '#fff',
                            lineHeight: '2.2',
                            marginBottom: '40px',
                            fontFamily: 'Tajawal, serif',
                            ...currentTheme.titleStyle
                        }}>
                            ÙÙŽÙ„Ø§ ØªÙŽÙ‚Ù†ÙŽØ¹ Ø¨ÙÙ…Ø§ Ø¯ÙˆÙ†ÙŽ Ø§Ù„Ù†ÙØ¬ÙˆÙ…Ù
                        </h1>
                        <div style={{
                            width: '80px',
                            height: '2px',
                            background: `linear-gradient(to right, transparent, ${primaryColor}, transparent)`,
                            margin: '0 auto 30px'
                        }}/>
                        <p style={{ color: 'rgba(255,255,255,0.4)', fontSize: '1rem', letterSpacing: '2px' }}>
                            Ø§Ù„Ù…ØªÙ†Ø¨ÙŠ
                        </p>
                    </div>
                )
            });

            // ---- SLIDE 2: Title slide ----
            slides.push({
                content: (
                    <div style={{ textAlign: 'center', padding: '50px 30px', animation: 'slideUp 0.8s ease' }}>
                        <div style={{
                            width: '100px',
                            height: '100px',
                            borderRadius: currentThemeKey === 'modern' ? '20px' : '50%',
                            background: `linear-gradient(135deg, ${primaryColor}33, ${primaryColor}11)`,
                            border: `2px solid ${primaryColor}44`,
                            display: 'flex',
                            alignItems: 'center',
                            justifyContent: 'center',
                            margin: '0 auto 30px',
                            fontSize: '2.5rem',
                            color: primaryColor,
                            boxShadow: `0 0 30px ${primaryColor}15`
                        }}>
                            <span style={{ fontWeight: '900' }}>B</span>
                        </div>
                        <h1 style={{ fontSize: '2.5rem', color: primaryColor, marginBottom: '15px', ...currentTheme.titleStyle }}>
                            {data.settings.title}
                        </h1>
                        <div style={{
                            width: '60px',
                            height: '2px',
                            background: primaryColor,
                            margin: '0 auto 15px'
                        }}/>
                        <p style={{ color: 'rgba(255,255,255,0.6)', fontSize: '1.2rem', letterSpacing: '3px' }}>
                            Ø­ÙÙ„ Ø§Ù„ØªØªÙˆÙŠØ¬
                        </p>
                    </div>
                )
            });

            // ---- INDIVIDUAL PROGRAM CATEGORY SLIDES ----
            const individualCategories = [
                { key: 'sports', label: 'Ø§Ù„Ø±ÙŠØ§Ø¶ÙŠØ©' },
                { key: 'educational', label: 'Ø§Ù„ØªØ±Ø¨ÙˆÙŠØ©' },
                { key: 'social', label: 'Ø§Ù„Ø§Ø¬ØªÙ…Ø§Ø¹ÙŠØ©' },
                { key: 'cultural', label: 'Ø§Ù„Ø«Ù‚Ø§ÙÙŠØ©' }
            ];

            individualCategories.forEach(cat => {
                const catData = data.programs.individual[cat.key];
                if (!catData || !catData.programs) return;

                // Get programs that have scores
                const scoredPrograms = catData.programs.filter(p => {
                    const scored = getStudentProgramScores(p.name);
                    return scored.length > 0;
                });

                if (scoredPrograms.length === 0) return;

                // Category title slide listing all program names
                slides.push({
                    content: (
                        <div style={{ textAlign: 'center', padding: '40px 30px', animation: 'slideUp 0.8s ease' }}>
                            <span style={{ color: 'rgba(255,255,255,0.4)', fontSize: '0.85rem', letterSpacing: '3px' }}>
                                Ø§Ù„Ø¨Ø±Ø§Ù…Ø¬ Ø§Ù„ÙØ±Ø¯ÙŠØ©
                            </span>
                            <h2 style={{ color: primaryColor, fontSize: '2rem', margin: '10px 0 15px', ...currentTheme.titleStyle }}>
                                Ø§Ù„Ù„Ø¬Ù†Ø© {cat.label}
                            </h2>
                            <div style={{
                                width: '60px',
                                height: '2px',
                                background: `linear-gradient(to right, transparent, ${primaryColor}, transparent)`,
                                margin: '0 auto 30px'
                            }}/>
                            <div style={{ display: 'flex', flexDirection: 'column', gap: '12px', alignItems: 'center' }}>
                                {scoredPrograms.map((p, i) => (
                                    <div key={i} style={{
                                        background: currentTheme.slideAccent,
                                        border: `1px solid ${currentTheme.slideBorder}`,
                                        borderRadius: currentTheme.cardRadius,
                                        padding: '12px 30px',
                                        minWidth: '200px',
                                        color: '#fff',
                                        fontSize: '1.15rem',
                                        fontWeight: '600',
                                        letterSpacing: '1px'
                                    }}>
                                        {p.name}
                                    </div>
                                ))}
                            </div>
                        </div>
                    )
                });

                catData.programs.forEach(program => {
                    const scored = getStudentProgramScores(program.name);
                    if (scored.length === 0) return;

                    // Podium slide for each program
                    slides.push({
                        content: (
                            <div style={{ padding: '20px', animation: 'slideUp 0.7s ease' }}>
                                <div style={{ textAlign: 'center', marginBottom: '5px' }}>
                                    <span style={{ color: 'rgba(255,255,255,0.4)', fontSize: '0.8rem', letterSpacing: '2px' }}>
                                        Ø§Ù„Ù„Ø¬Ù†Ø© {cat.label}
                                    </span>
                                </div>
                                <h2 style={{ color: primaryColor, textAlign: 'center', marginBottom: '5px', fontSize: '1.6rem', ...currentTheme.titleStyle }}>
                                    {program.name}
                                </h2>
                                <div style={{
                                    width: '40px',
                                    height: '2px',
                                    background: primaryColor,
                                    margin: '0 auto 10px'
                                }}/>
                                <Podium items={scored} labelKey="name" scoreKey="programScore" colorKey="stationColor" subtitleKey="stationName" />
                                <RankTable items={scored} labelKey="name" scoreKey="programScore" colorKey="stationColor" subtitleKey="stationName" />
                            </div>
                        )
                    });
                });
            });

            // ---- IDEAL STUDENT PER COMMITTEE (most total points from that committee's programs) ----
            const committeeIdeals = [];
            individualCategories.forEach(cat => {
                const scored = getIndividualCategoryScores(cat.key);
                if (scored.length > 0) {
                    committeeIdeals.push({
                        committee: cat.label,
                        color: data.programs.individual[cat.key].color,
                        students: scored.slice(0, 3)
                    });
                }
            });

            if (committeeIdeals.length > 0) {
                slides.push({
                    content: (
                        <div style={{ padding: '20px', animation: 'slideUp 0.7s ease' }}>
                            <h2 style={{ color: primaryColor, textAlign: 'center', marginBottom: '5px', fontSize: '1.6rem', ...currentTheme.titleStyle }}>
                                Ù…Ø«Ø§Ù„ÙŠ ÙƒÙ„ Ù„Ø¬Ù†Ø©
                            </h2>
                            <div style={{
                                width: '40px',
                                height: '2px',
                                background: primaryColor,
                                margin: '0 auto 25px'
                            }}/>
                            <div style={{ display: 'grid', gridTemplateColumns: 'repeat(auto-fit, minmax(220px, 1fr))', gap: '20px' }}>
                                {committeeIdeals.map((ci, idx) => (
                                    <div key={idx} style={{
                                        background: currentTheme.slideAccent,
                                        borderRadius: currentTheme.cardRadius,
                                        padding: '25px 15px',
                                        textAlign: 'center',
                                        border: `1px solid ${ci.color}33`,
                                        position: 'relative'
                                    }}>
                                        <div style={{
                                            position: 'absolute',
                                            top: '-12px',
                                            right: '50%',
                                            transform: 'translateX(50%)',
                                            background: ci.color,
                                            color: '#fff',
                                            padding: '4px 16px',
                                            borderRadius: '20px',
                                            fontSize: '0.75rem',
                                            fontWeight: '600'
                                        }}>
                                            {ci.committee}
                                        </div>
                                        <div style={{
                                            width: '60px',
                                            height: '60px',
                                            borderRadius: '50%',
                                            background: `linear-gradient(135deg, #FFD70044, #FFD700BB)`,
                                            border: '2px solid #FFD700',
                                            display: 'flex',
                                            alignItems: 'center',
                                            justifyContent: 'center',
                                            margin: '15px auto 12px',
                                            fontWeight: '900',
                                            color: '#1a1a2e',
                                            fontSize: '1.3rem'
                                        }}>
                                            1
                                        </div>
                                        <h3 style={{ color: '#fff', fontSize: '1.1rem', marginBottom: '5px' }}>
                                            {ci.students[0].name}
                                        </h3>
                                        <div style={{ color: ci.students[0].stationColor, fontSize: '0.8rem', marginBottom: '8px' }}>
                                            {ci.students[0].stationName}
                                        </div>
                                        <div style={{ color: primaryColor, fontWeight: '900', fontSize: '1.3rem' }}>
                                            {formatNumber(ci.students[0].categoryScore)} {currency}
                                        </div>
                                    </div>
                                ))}
                            </div>
                        </div>
                    )
                });
            }

            // ---- FAMILY PROGRAM CATEGORY SLIDES (Bar charts, no table, no ideal) ----
            const familyCategories = [
                { key: 'sports', label: 'Ø§Ù„Ø±ÙŠØ§Ø¶ÙŠØ©' },
                { key: 'social', label: 'Ø§Ù„Ø§Ø¬ØªÙ…Ø§Ø¹ÙŠØ©' },
                { key: 'cultural', label: 'Ø§Ù„Ø«Ù‚Ø§ÙÙŠØ©' }
            ];

            familyCategories.forEach(cat => {
                const catData = data.programs.family[cat.key];
                if (!catData || !catData.programs) return;

                // Get programs that have scores
                const scoredFamilyPrograms = catData.programs.filter(p => {
                    const scored = getFamilyProgramScores(p.name);
                    return scored.some(s => s.programScore > 0);
                });

                if (scoredFamilyPrograms.length === 0) return;

                // Category title slide listing all program names
                slides.push({
                    content: (
                        <div style={{ textAlign: 'center', padding: '40px 30px', animation: 'slideUp 0.8s ease' }}>
                            <span style={{ color: 'rgba(255,255,255,0.4)', fontSize: '0.85rem', letterSpacing: '3px' }}>
                                Ø§Ù„Ø¨Ø±Ø§Ù…Ø¬ Ø§Ù„Ø£Ø³Ø±ÙŠØ©
                            </span>
                            <h2 style={{ color: primaryColor, fontSize: '2rem', margin: '10px 0 15px', ...currentTheme.titleStyle }}>
                                Ø§Ù„Ù„Ø¬Ù†Ø© {cat.label}
                            </h2>
                            <div style={{
                                width: '60px',
                                height: '2px',
                                background: `linear-gradient(to right, transparent, ${primaryColor}, transparent)`,
                                margin: '0 auto 30px'
                            }}/>
                            <div style={{ display: 'flex', flexDirection: 'column', gap: '12px', alignItems: 'center' }}>
                                {scoredFamilyPrograms.map((p, i) => (
                                    <div key={i} style={{
                                        background: currentTheme.slideAccent,
                                        border: `1px solid ${currentTheme.slideBorder}`,
                                        borderRadius: currentTheme.cardRadius,
                                        padding: '12px 30px',
                                        minWidth: '200px',
                                        color: '#fff',
                                        fontSize: '1.15rem',
                                        fontWeight: '600',
                                        letterSpacing: '1px'
                                    }}>
                                        {p.name}
                                    </div>
                                ))}
                            </div>
                        </div>
                    )
                });

                catData.programs.forEach(program => {
                    const scored = getFamilyProgramScores(program.name);
                    const hasScores = scored.some(s => s.programScore > 0);
                    if (!hasScores) return;

                    slides.push({
                        content: (
                            <div style={{ padding: '20px', animation: 'slideUp 0.7s ease' }}>
                                <div style={{ textAlign: 'center', marginBottom: '5px' }}>
                                    <span style={{ color: 'rgba(255,255,255,0.4)', fontSize: '0.8rem', letterSpacing: '2px' }}>
                                        Ø§Ù„Ø¨Ø±Ø§Ù…Ø¬ Ø§Ù„Ø£Ø³Ø±ÙŠØ© - {cat.label}
                                    </span>
                                </div>
                                <h2 style={{ color: primaryColor, textAlign: 'center', marginBottom: '5px', fontSize: '1.6rem', ...currentTheme.titleStyle }}>
                                    {program.name}
                                </h2>
                                <div style={{
                                    width: '40px',
                                    height: '2px',
                                    background: primaryColor,
                                    margin: '0 auto 10px'
                                }}/>
                                <Podium items={scored.filter(s => s.programScore > 0)} labelKey="name" scoreKey="programScore" colorKey="color" />
                            </div>
                        )
                    });
                });
            });

            // ---- SUSPENSEFUL TOP 5 OVERALL REVEAL ----
            const top5 = sortedStudents.slice(0, 5);

            // Fake-out messages for suspense
            const fakeOuts = [
                'Ù‡Ù„ ØªØ¸Ù†ÙˆÙ† Ø£Ù†ÙƒÙ… ØªØ¹Ø±ÙÙˆÙ† Ù…Ù† Ù‡Ùˆ Ø§Ù„Ø§ÙˆÙ„ ØŸ',
                'Ø±Ø¨Ù…Ø§ ÙŠÙƒÙˆÙ† Ù‡Ù†Ø§Ùƒ Ù…ÙØ§Ø¬Ø£Ø© ...',
                'Ø§Ù„Ù†ØªØ§Ø¦Ø¬ Ù‚Ø¯ ØªÙƒÙˆÙ† ØµØ§Ø¯Ù…Ø© !',
                'Ø§Ø³ØªØ¹Ø¯ÙˆØ§ ...',
                'Ù„Ù†Ø¨Ø¯Ø£ ...'
            ];

            // Top 5 intro slide
            slides.push({
                content: (
                    <div style={{ textAlign: 'center', padding: '50px 30px', animation: 'slideUp 1s ease' }}>
                        <div style={{
                            fontSize: '3rem',
                            color: primaryColor,
                            marginBottom: '20px',
                            ...currentTheme.titleStyle
                        }}>
                            Ø§Ù„Ø®Ù…Ø³Ø© Ø§Ù„Ø§ÙˆØ§Ø¦Ù„
                        </div>
                        <div style={{
                            width: '60px',
                            height: '2px',
                            background: primaryColor,
                            margin: '0 auto 30px'
                        }}/>
                        <p style={{ color: 'rgba(255,255,255,0.5)', fontSize: '1.2rem', lineHeight: '2' }}>
                            Ù…Ù† ÙŠØ§ ØªØ±Ù‰ Ø³ÙŠØªØµØ¯Ø± Ø§Ù„Ù‚Ù…Ø© ØŸ
                        </p>
                    </div>
                )
            });

            // Reveal #5
            if (top5.length >= 5) {
                slides.push({
                    content: (
                        <div style={{ textAlign: 'center', padding: '40px 30px', animation: 'slideUp 0.8s ease' }}>
                            <div style={{ color: 'rgba(255,255,255,0.4)', fontSize: '0.9rem', letterSpacing: '3px', marginBottom: '20px' }}>
                                Ø§Ù„Ù…Ø±ÙƒØ² Ø§Ù„Ø®Ø§Ù…Ø³
                            </div>
                            <div style={{
                                width: '100px',
                                height: '100px',
                                borderRadius: currentThemeKey === 'modern' ? '20px' : '50%',
                                background: `linear-gradient(135deg, ${currentTheme.slideAccent}, rgba(255,255,255,0.05))`,
                                border: `2px solid ${currentTheme.slideBorder}`,
                                display: 'flex',
                                alignItems: 'center',
                                justifyContent: 'center',
                                margin: '0 auto 20px',
                                fontSize: '2rem',
                                fontWeight: '900',
                                color: 'rgba(255,255,255,0.6)'
                            }}>5</div>
                            <h2 style={{ color: '#fff', fontSize: '1.8rem', marginBottom: '8px', ...currentTheme.titleStyle }}>{top5[4].name}</h2>
                            <div style={{ color: top5[4].stationColor, fontSize: '0.95rem', marginBottom: '15px' }}>{top5[4].stationName}</div>
                            <div style={{ color: primaryColor, fontWeight: '900', fontSize: '2rem' }}>{formatNumber(top5[4].liters)} {currency}</div>
                        </div>
                    )
                });
            }

            // Reveal #4
            if (top5.length >= 4) {
                slides.push({
                    content: (
                        <div style={{ textAlign: 'center', padding: '40px 30px', animation: 'slideUp 0.8s ease' }}>
                            <div style={{ color: 'rgba(255,255,255,0.4)', fontSize: '0.9rem', letterSpacing: '3px', marginBottom: '20px' }}>
                                Ø§Ù„Ù…Ø±ÙƒØ² Ø§Ù„Ø±Ø§Ø¨Ø¹
                            </div>
                            <div style={{
                                width: '100px',
                                height: '100px',
                                borderRadius: currentThemeKey === 'modern' ? '20px' : '50%',
                                background: `linear-gradient(135deg, ${currentTheme.slideAccent}, rgba(255,255,255,0.05))`,
                                border: `2px solid ${currentTheme.slideBorder}`,
                                display: 'flex',
                                alignItems: 'center',
                                justifyContent: 'center',
                                margin: '0 auto 20px',
                                fontSize: '2rem',
                                fontWeight: '900',
                                color: 'rgba(255,255,255,0.6)'
                            }}>4</div>
                            <h2 style={{ color: '#fff', fontSize: '1.8rem', marginBottom: '8px', ...currentTheme.titleStyle }}>{top5[3].name}</h2>
                            <div style={{ color: top5[3].stationColor, fontSize: '0.95rem', marginBottom: '15px' }}>{top5[3].stationName}</div>
                            <div style={{ color: primaryColor, fontWeight: '900', fontSize: '2rem' }}>{formatNumber(top5[3].liters)} {currency}</div>
                        </div>
                    )
                });
            }

            // Reveal #3
            if (top5.length >= 3) {
                slides.push({
                    content: (
                        <div style={{ textAlign: 'center', padding: '40px 30px', animation: 'slideUp 0.8s ease' }}>
                            <div style={{ color: '#CD7F32', fontSize: '0.9rem', letterSpacing: '3px', marginBottom: '20px' }}>
                                Ø§Ù„Ù…Ø±ÙƒØ² Ø§Ù„Ø«Ø§Ù„Ø«
                            </div>
                            <div style={{
                                width: '110px',
                                height: '110px',
                                borderRadius: currentThemeKey === 'modern' ? '22px' : '50%',
                                background: currentTheme.podiumGradient('#CD7F32'),
                                border: '2px solid #CD7F32',
                                display: 'flex',
                                alignItems: 'center',
                                justifyContent: 'center',
                                margin: '0 auto 20px',
                                fontSize: '2.2rem',
                                fontWeight: '900',
                                color: '#1a1a2e',
                                boxShadow: '0 0 30px #CD7F3244'
                            }}>3</div>
                            <h2 style={{ color: '#fff', fontSize: '2rem', marginBottom: '8px', ...currentTheme.titleStyle }}>{top5[2].name}</h2>
                            <div style={{ color: top5[2].stationColor, fontSize: '1rem', marginBottom: '15px' }}>{top5[2].stationName}</div>
                            <div style={{ color: primaryColor, fontWeight: '900', fontSize: '2.2rem' }}>{formatNumber(top5[2].liters)} {currency}</div>
                        </div>
                    )
                });
            }

            // Reveal #2
            if (top5.length >= 2) {
                slides.push({
                    content: (
                        <div style={{ textAlign: 'center', padding: '40px 30px', animation: 'slideUp 0.8s ease' }}>
                            <div style={{ color: '#C0C0C0', fontSize: '0.9rem', letterSpacing: '3px', marginBottom: '20px' }}>
                                Ø§Ù„Ù…Ø±ÙƒØ² Ø§Ù„Ø«Ø§Ù†ÙŠ
                            </div>
                            <div style={{
                                width: '115px',
                                height: '115px',
                                borderRadius: currentThemeKey === 'modern' ? '24px' : '50%',
                                background: currentTheme.podiumGradient('#C0C0C0'),
                                border: '2px solid #C0C0C0',
                                display: 'flex',
                                alignItems: 'center',
                                justifyContent: 'center',
                                margin: '0 auto 20px',
                                fontSize: '2.3rem',
                                fontWeight: '900',
                                color: '#1a1a2e',
                                boxShadow: '0 0 30px #C0C0C044'
                            }}>2</div>
                            <h2 style={{ color: '#fff', fontSize: '2.2rem', marginBottom: '8px', ...currentTheme.titleStyle }}>{top5[1].name}</h2>
                            <div style={{ color: top5[1].stationColor, fontSize: '1rem', marginBottom: '15px' }}>{top5[1].stationName}</div>
                            <div style={{ color: primaryColor, fontWeight: '900', fontSize: '2.5rem' }}>{formatNumber(top5[1].liters)} {currency}</div>
                        </div>
                    )
                });
            }

            // Suspense/Fake-out slides before #1
            slides.push({
                content: (
                    <div style={{ textAlign: 'center', padding: '50px 30px', animation: 'fadeIn 1.5s ease' }}>
                        <div style={{ color: 'rgba(255,255,255,0.3)', fontSize: '1rem', letterSpacing: '5px', marginBottom: '30px' }}>
                            . . .
                        </div>
                        <h2 style={{ color: '#fff', fontSize: '1.8rem', marginBottom: '20px', lineHeight: '2' }}>
                            {fakeOuts[0]}
                        </h2>
                    </div>
                )
            });

            slides.push({
                content: (
                    <div style={{ textAlign: 'center', padding: '50px 30px', animation: 'fadeIn 1.5s ease' }}>
                        <h2 style={{ color: 'rgba(255,255,255,0.7)', fontSize: '1.5rem', marginBottom: '30px', lineHeight: '2' }}>
                            {fakeOuts[1]}
                        </h2>
                        <div style={{
                            color: primaryColor,
                            fontSize: '1.2rem',
                            opacity: 0.6
                        }}>
                            {fakeOuts[2]}
                        </div>
                    </div>
                )
            });

            slides.push({
                content: (
                    <div style={{ textAlign: 'center', padding: '50px 30px', animation: 'fadeIn 1.5s ease' }}>
                        <div style={{
                            fontSize: '2rem',
                            color: 'rgba(255,255,255,0.2)',
                            marginBottom: '20px',
                            letterSpacing: '10px'
                        }}>
                            ...
                        </div>
                        <h2 style={{ color: '#fff', fontSize: '1.5rem', lineHeight: '2', marginBottom: '15px' }}>
                            Ù„Ø­Ø¸Ø© ... Ù‡Ù„ Ø£Ù†ØªÙ… Ù…ØªØ£ÙƒØ¯ÙˆÙ† Ù…Ù† ØªÙˆÙ‚Ø¹Ø§ØªÙƒÙ… ØŸ
                        </h2>
                        <p style={{ color: 'rgba(255,255,255,0.4)', fontSize: '1rem' }}>
                            Ø±Ø¨Ù…Ø§ Ø§Ù„Ø§ÙˆÙ„ Ù„ÙŠØ³ Ù…Ù† ØªØªÙˆÙ‚Ø¹ÙˆÙ†Ù‡
                        </p>
                    </div>
                )
            });

            slides.push({
                content: (
                    <div style={{ textAlign: 'center', padding: '50px 30px', animation: 'fadeIn 2s ease' }}>
                        <div style={{
                            fontSize: '1rem',
                            color: 'rgba(255,255,255,0.3)',
                            letterSpacing: '8px',
                            marginBottom: '40px'
                        }}>
                            Ø§Ù„Ø§Ø¹Ù„Ø§Ù† Ø§Ù„Ø§Ø®ÙŠØ±
                        </div>
                        <div style={{
                            fontSize: '5rem',
                            color: primaryColor,
                            fontWeight: '900',
                            textShadow: `0 0 40px ${primaryColor}44`,
                            marginBottom: '20px'
                        }}>
                            ØŸ
                        </div>
                        <p style={{ color: 'rgba(255,255,255,0.5)', fontSize: '1.1rem' }}>
                            Ù…Ù† Ù‡Ùˆ ØµØ§Ø­Ø¨ Ø§Ù„Ù…Ø±ÙƒØ² Ø§Ù„Ø§ÙˆÙ„ ØŸ
                        </p>
                    </div>
                )
            });

            // Another fake-out: show a wrong student momentarily
            if (top5.length >= 1 && sortedStudents.length > 5) {
                const fakeStudent = sortedStudents[5] || sortedStudents[sortedStudents.length - 1];
                slides.push({
                    content: (
                        <div style={{ textAlign: 'center', padding: '40px 30px', animation: 'slideUp 0.5s ease' }}>
                            <div style={{ color: '#FFD700', fontSize: '0.9rem', letterSpacing: '3px', marginBottom: '20px' }}>
                                Ø§Ù„Ù…Ø±ÙƒØ² Ø§Ù„Ø§ÙˆÙ„
                            </div>
                            <div style={{
                                width: '130px',
                                height: '130px',
                                borderRadius: currentThemeKey === 'modern' ? '28px' : '50%',
                                background: currentTheme.podiumGradient('#FFD700'),
                                border: '3px solid #FFD700',
                                display: 'flex',
                                alignItems: 'center',
                                justifyContent: 'center',
                                margin: '0 auto 25px',
                                fontSize: '2.5rem',
                                fontWeight: '900',
                                color: '#1a1a2e',
                                boxShadow: '0 0 50px #FFD70044'
                            }}>1</div>
                            <h2 style={{ color: '#fff', fontSize: '2.5rem', marginBottom: '8px', ...currentTheme.titleStyle }}>{fakeStudent.name}</h2>
                            <div style={{ color: fakeStudent.stationColor, fontSize: '1rem', marginBottom: '15px' }}>{fakeStudent.stationName}</div>
                            <div style={{ color: primaryColor, fontWeight: '900', fontSize: '2.8rem' }}>{formatNumber(fakeStudent.liters)} {currency}</div>
                        </div>
                    )
                });

                // "Just kidding" slide
                slides.push({
                    content: (
                        <div style={{ textAlign: 'center', padding: '50px 30px', animation: 'fadeIn 1s ease' }}>
                            <h2 style={{ color: '#FF5252', fontSize: '2.5rem', marginBottom: '30px', ...currentTheme.titleStyle }}>
                                Ù„Ø§ .. Ù„ÙŠØ³ Ù‡Ùˆ !
                            </h2>
                            <p style={{ color: 'rgba(255,255,255,0.5)', fontSize: '1.2rem', lineHeight: '2' }}>
                                ÙƒØ§Ù†Øª Ù…Ù‚Ù„Ø¨ ÙÙ‚Ø·
                            </p>
                            <p style={{ color: primaryColor, fontSize: '1rem', marginTop: '20px' }}>
                                Ø§Ù„Ø§ÙˆÙ„ Ø§Ù„Ø­Ù‚ÙŠÙ‚ÙŠ ÙÙŠ Ø§Ù„Ø´Ø±ÙŠØ­Ø© Ø§Ù„ØªØ§Ù„ÙŠØ© ...
                            </p>
                        </div>
                    )
                });
            }

            // Another trick before #1
            slides.push({
                content: (
                    <div style={{ textAlign: 'center', padding: '50px 30px', animation: 'fadeIn 2s ease' }}>
                        <div style={{ color: 'rgba(255,255,255,0.15)', fontSize: '6rem', fontWeight: '900', marginBottom: '20px' }}>
                            1
                        </div>
                        <h2 style={{ color: 'rgba(255,255,255,0.6)', fontSize: '1.3rem', lineHeight: '2' }}>
                            Ù‡Ù„ Ø£Ù†ØªÙ… Ø¬Ø§Ù‡Ø²ÙˆÙ† ÙØ¹Ù„Ø§ ØŸ
                        </h2>
                        <div style={{
                            marginTop: '30px',
                            display: 'flex',
                            justifyContent: 'center',
                            gap: '8px'
                        }}>
                            {[0,1,2].map(i => (
                                <div key={i} style={{
                                    width: '12px',
                                    height: '12px',
                                    borderRadius: '50%',
                                    background: primaryColor,
                                    animation: `pulse 1.5s infinite ${i * 0.3}s`
                                }}/>
                            ))}
                        </div>
                    </div>
                )
            });

            // Real #1 reveal
            if (top5.length >= 1) {
                slides.push({
                    content: (
                        <div style={{ textAlign: 'center', padding: '30px', animation: 'slideUp 1s ease' }}>
                            <div style={{
                                fontSize: '0.9rem',
                                color: '#FFD700',
                                letterSpacing: '5px',
                                marginBottom: '20px'
                            }}>
                                Ø§Ù„Ù…Ø±ÙƒØ² Ø§Ù„Ø§ÙˆÙ„
                            </div>
                            <div style={{
                                width: '140px',
                                height: '140px',
                                borderRadius: currentThemeKey === 'modern' ? '30px' : '50%',
                                background: 'linear-gradient(135deg, #FFD700, #FFA000)',
                                border: '4px solid #FFD700',
                                display: 'flex',
                                alignItems: 'center',
                                justifyContent: 'center',
                                margin: '0 auto 25px',
                                fontSize: '3rem',
                                fontWeight: '900',
                                color: '#1a1a2e',
                                boxShadow: '0 0 60px #FFD70066, 0 0 120px #FFD70022',
                                animation: 'pulse 2s infinite'
                            }}>
                                1
                            </div>
                            <h1 style={{
                                color: '#FFD700',
                                fontSize: '2.8rem',
                                marginBottom: '10px',
                                ...currentTheme.titleStyle,
                                textShadow: '0 0 30px #FFD70044'
                            }}>
                                {top5[0].name}
                            </h1>
                            <div style={{ color: top5[0].stationColor, fontSize: '1.1rem', marginBottom: '20px' }}>
                                {top5[0].stationName}
                            </div>
                            <div style={{
                                fontSize: '3rem',
                                color: primaryColor,
                                fontWeight: '900',
                                textShadow: `0 0 20px ${primaryColor}44`
                            }}>
                                {formatNumber(top5[0].liters)} {currency}
                            </div>
                            <div style={{
                                marginTop: '25px',
                                width: '80px',
                                height: '2px',
                                background: `linear-gradient(to right, transparent, #FFD700, transparent)`,
                                margin: '25px auto 0'
                            }}/>
                        </div>
                    )
                });
            }

            // ---- CLOSING SLIDE ----
            slides.push({
                content: (
                    <div style={{ textAlign: 'center', padding: '50px 30px', animation: 'slideUp 1s ease' }}>
                        <div style={{
                            color: primaryColor,
                            fontSize: '1.5rem',
                            marginBottom: '30px',
                            opacity: 0.6
                        }}>{currentTheme.ornament} {currentTheme.ornament} {currentTheme.ornament}</div>
                        <div style={{
                            width: '80px',
                            height: '2px',
                            background: `linear-gradient(to right, transparent, ${primaryColor}, transparent)`,
                            margin: '0 auto 40px'
                        }}/>
                        <h2 style={{ color: primaryColor, fontSize: '2rem', marginBottom: '15px', ...currentTheme.titleStyle }}>
                            Ø´ÙƒØ±Ø§ Ù„Ù„Ø¬Ù…ÙŠØ¹
                        </h2>
                        <p style={{ color: 'rgba(255,255,255,0.6)', fontSize: '1.1rem', marginBottom: '30px', lineHeight: '2' }}>
                            Ø¹Ù„Ù‰ Ø§Ù„Ù…Ø´Ø§Ø±ÙƒØ© ÙˆØ§Ù„ØªÙ…ÙŠØ²
                        </p>
                        <div style={{
                            background: currentTheme.slideAccent,
                            borderRadius: currentTheme.cardRadius,
                            padding: '20px 30px',
                            display: 'inline-block',
                            border: `1px solid ${currentTheme.slideBorder}`
                        }}>
                            <p style={{ color: primaryColor, fontSize: '1.1rem', margin: 0, fontWeight: '600' }}>
                                {data.settings.title}
                            </p>
                        </div>
                        <div style={{
                            width: '80px',
                            height: '2px',
                            background: `linear-gradient(to right, transparent, ${primaryColor}, transparent)`,
                            margin: '40px auto 0'
                        }}/>
                    </div>
                )
            });

            const nextSlide = () => {
                if (currentSlide < slides.length - 1) {
                    setCurrentSlide(prev => prev + 1);
                    setSlideKey(prev => prev + 1);
                }
            };

            const prevSlide = () => {
                if (currentSlide > 0) {
                    setCurrentSlide(prev => prev - 1);
                    setSlideKey(prev => prev + 1);
                }
            };

            // Keyboard navigation
            useEffect(() => {
                const handleKey = (e) => {
                    if (e.key === 'ArrowLeft' || e.key === 'ArrowDown' || e.key === ' ') {
                        e.preventDefault();
                        nextSlide();
                    } else if (e.key === 'ArrowRight' || e.key === 'ArrowUp') {
                        e.preventDefault();
                        prevSlide();
                    } else if (e.key === 'Escape') {
                        onClose();
                    }
                };
                window.addEventListener('keydown', handleKey);
                return () => window.removeEventListener('keydown', handleKey);
            }, [currentSlide, slides.length]);

            return ReactDOM.createPortal(
                <div style={{
                    position: 'fixed',
                    top: 0,
                    left: 0,
                    right: 0,
                    bottom: 0,
                    background: currentTheme.presentationBg,
                    zIndex: 10000,
                    display: 'flex',
                    flexDirection: 'column',
                    fontFamily: 'Tajawal, sans-serif'
                }}>
                    {/* Header bar */}
                    <div style={{
                        padding: '12px 20px',
                        display: 'flex',
                        justifyContent: 'space-between',
                        alignItems: 'center',
                        background: currentTheme.headerBg,
                        borderBottom: `1px solid ${currentTheme.slideBorder}`
                    }}>
                        <div style={{ color: 'rgba(255,255,255,0.3)', fontSize: '0.85rem' }}>
                            {currentSlide + 1} / {slides.length}
                        </div>
                        <button
                            onClick={onClose}
                            style={{
                                background: 'rgba(255,255,255,0.08)',
                                border: `1px solid ${currentTheme.slideBorder}`,
                                color: 'rgba(255,255,255,0.6)',
                                padding: '6px 16px',
                                borderRadius: '8px',
                                cursor: 'pointer',
                                fontSize: '0.85rem'
                            }}
                        >
                            Ø§ØºÙ„Ø§Ù‚
                        </button>
                    </div>

                    {/* Slide content */}
                    <div style={{
                        flex: 1,
                        display: 'flex',
                        alignItems: 'center',
                        justifyContent: 'center',
                        padding: '20px',
                        overflow: 'auto'
                    }}>
                        <div key={slideKey} style={{
                            width: '100%',
                            maxWidth: '900px',
                            animation: 'fadeIn 0.6s ease',
                            background: currentTheme.slideBg,
                            borderRadius: currentTheme.cardRadius,
                            padding: '10px'
                        }}>
                            {slides[currentSlide] && slides[currentSlide].content}
                        </div>
                    </div>

                    {/* Progress bar */}
                    <div style={{
                        height: '3px',
                        background: 'rgba(255,255,255,0.05)'
                    }}>
                        <div style={{
                            height: '100%',
                            width: `${((currentSlide + 1) / slides.length) * 100}%`,
                            background: `linear-gradient(to right, ${primaryColor}, ${currentTheme.accentColor})`,
                            transition: 'width 0.5s ease'
                        }}/>
                    </div>

                    {/* Navigation */}
                    <div style={{
                        padding: '15px 20px',
                        display: 'flex',
                        justifyContent: 'center',
                        gap: '15px',
                        background: currentTheme.headerBg
                    }}>
                        <button
                            onClick={prevSlide}
                            disabled={currentSlide === 0}
                            style={{
                                background: currentSlide === 0 ? 'rgba(255,255,255,0.05)' : `linear-gradient(135deg, ${primaryColor}, ${currentTheme.secondaryColor})`,
                                color: currentSlide === 0 ? 'rgba(255,255,255,0.3)' : (currentThemeKey === 'modern' || currentThemeKey === 'majestic' ? '#fff' : '#0A1628'),
                                border: 'none',
                                padding: '10px 30px',
                                borderRadius: '10px',
                                cursor: currentSlide === 0 ? 'not-allowed' : 'pointer',
                                fontWeight: '600',
                                fontSize: '0.95rem',
                                fontFamily: 'Tajawal, sans-serif'
                            }}
                        >
                            Ø§Ù„Ø³Ø§Ø¨Ù‚
                        </button>

                        <button
                            onClick={nextSlide}
                            disabled={currentSlide === slides.length - 1}
                            style={{
                                background: currentSlide === slides.length - 1 ? 'rgba(255,255,255,0.05)' : `linear-gradient(135deg, ${primaryColor}, ${currentTheme.secondaryColor})`,
                                color: currentSlide === slides.length - 1 ? 'rgba(255,255,255,0.3)' : (currentThemeKey === 'modern' || currentThemeKey === 'majestic' ? '#fff' : '#0A1628'),
                                border: 'none',
                                padding: '10px 30px',
                                borderRadius: '10px',
                                cursor: currentSlide === slides.length - 1 ? 'not-allowed' : 'pointer',
                                fontWeight: '600',
                                fontSize: '0.95rem',
                                fontFamily: 'Tajawal, sans-serif'
                            }}
                        >
                            Ø§Ù„ØªØ§Ù„ÙŠ
                        </button>
                    </div>
                </div>,
                document.body
            );
        };
        
        // ==================== HOOKS ====================
        const useDebounce = (value, delay) => {
            const [debouncedValue, setDebouncedValue] = useState(value);
            useEffect(() => {
                const handler = setTimeout(() => {
                    setDebouncedValue(value);
                }, delay);
                return () => {
                    clearTimeout(handler);
                };
            }, [value, delay]);
            return debouncedValue;
        };

        // ==================== MAIN APP COMPONENT ====================
        const App = () => {
            const [data, setData] = useState(null);
            const [user, setUser] = useState(null);
            const [currentView, setCurrentView] = useState('splash');
            const [isLoading, setIsLoading] = useState(true);
            const [isSaving, setIsSaving] = useState(false);
            const lastSavedDataRef = React.useRef(null);
            
            // Helper to ensure data structure compatibility
            const normalizeData = (serverData) => {
                if (!serverData) return generateInitialData();
                
                const newData = { ...serverData };
                const initial = generateInitialData();
                
                if (!newData.assignmentsArchive) newData.assignmentsArchive = [];
                
                if (!newData.phoneBook) newData.phoneBook = initial.phoneBook;
                
                if (!newData.store) newData.store = initial.store;
                if (!newData.badges) newData.badges = initial.badges;
                if (!newData.settings) newData.settings = initial.settings;
                if (!newData.settings.nextStudentId) newData.settings.nextStudentId = 22;
                if (!newData.settings.theme) newData.settings.theme = 'classic';
                
                // Ø§Ù„ØªØ£ÙƒØ¯ Ù…Ù† ÙˆØ¬ÙˆØ¯ head ÙÙŠ ÙƒÙ„ Ù…Ø­Ø·Ø©
                if (newData.stations) {
                    newData.stations.forEach((station, idx) => {
                        if (!station.head) {
                            // ØªØ¹ÙŠÙŠÙ† Ø±Ø¦ÙŠØ³ Ø§ÙØªØ±Ø§Ø¶ÙŠ Ø­Ø³Ø¨ Ø§Ù„Ø£Ø³Ù…Ø§Ø¡ Ø§Ù„Ù…Ø¹Ø±ÙˆÙØ©
                            const defaultHeads = ['Ø£Ø³Ø§Ù…Ø© Ø§Ù„Ø³Ù‡ÙŠÙ„', 'Ø¹Ø²Ø§Ù… Ø§Ù„Ø¬Ø±ÙŠÙˆÙŠ', 'Ø³Ø¹ÙˆØ¯ Ø§Ù„ÙÙ‡ÙŠØ¯'];
                            station.head = defaultHeads[idx] || station.name;
                        }
                        if (station.students) {
                            station.students.forEach(student => {
                                if (!student.badges) student.badges = [];
                            });
                        }
                    });
                }
                return newData;
            };

            // Initial Load
            useEffect(() => {
                const loadData = async () => {
                    try {
                        const response = await fetch('/.netlify/functions/data');
                        if (!response.ok) {
                             throw new Error('Failed to fetch');
                        }
                        const serverData = await response.json();
                        const normalized = normalizeData(serverData);
                        
                        setData(normalized);
                        lastSavedDataRef.current = JSON.stringify(normalized);
                    } catch (error) {
                        console.error('Error loading data:', error);
                        const initial = generateInitialData();
                        setData(initial);
                        lastSavedDataRef.current = JSON.stringify(initial);
                    } finally {
                        setTimeout(() => setIsLoading(false), 1500);
                    }
                };
                loadData();
            }, []);
            
            const debouncedData = useDebounce(data, 2000);

            // Polling for updates
            useEffect(() => {
                const pollInterval = setInterval(async () => {
                    if (data !== debouncedData) {
                        return;
                    }

                    try {
                        const response = await fetch('/.netlify/functions/data');
                        if (response.ok) {
                            const serverData = await response.json();
                            const normalized = normalizeData(serverData);
                            const serverJson = JSON.stringify(normalized);
                            
                            if (serverJson !== lastSavedDataRef.current) {
                                console.log('New data received from server');
                                setData(normalized);
                                lastSavedDataRef.current = serverJson;
                            }
                        }
                    } catch (error) {
                        console.error('Polling error:', error);
                    }
                }, 3000);

                return () => clearInterval(pollInterval);
            }, [data, debouncedData]);

            // Save Data
            useEffect(() => {
                if (debouncedData) {
                    const dataToSave = JSON.stringify(debouncedData);
                    
                    if (lastSavedDataRef.current === dataToSave) {
                        return;
                    }

                    const saveData = async () => {
                        setIsSaving(true);
                        try {
                            await fetch('/.netlify/functions/data', {
                                method: 'POST',
                                headers: { 'Content-Type': 'application/json' },
                                body: dataToSave
                            });
                            lastSavedDataRef.current = dataToSave;
                        } catch (error) {
                            console.error('Error saving data:', error);
                        } finally {
                            setIsSaving(false);
                        }
                    };
                    saveData();
                }
            }, [debouncedData]);
            
            const handleLogin = (userType, userData) => {
                setUser({ type: userType, ...userData });
                setCurrentView(userType);
            };
            
            const handleLogout = () => {
                setUser(null);
                setCurrentView('login');
            };
            
            const renderView = () => {
                if (isLoading || !data) {
                    return <LoadingScreen />;
                }
                
                switch (currentView) {
                    case 'splash':
                        return <SplashScreen onFinish={() => setCurrentView('login')} theme={data.settings.theme} data={data} />;
                    
                    case 'login':
                        return <LoginScreen data={data} onLogin={handleLogin} />;
                    
                    case 'supervisor':
                        return <SupervisorDashboard data={data} setData={setData} onLogout={handleLogout} />;
                    
                    case 'student':
                        if (!user) return null;
                        const station = data.stations.find(s => s.id === user.stationId);
                        const student = station?.students.find(s => s.id === user.studentId);
                        if (!station || !student) return null;
                        
                        return <StudentDashboard student={student} station={station} data={data} setData={setData} onLogout={handleLogout} />;
                    
                    default:
                        return null;
                }
            };
            
            // Apply theme class to root element
            const themeClass = data?.settings?.theme ? themes[data.settings.theme]?.class || 'theme-classic' : 'theme-classic';
            
            return (
                <div className={themeClass} style={{ minHeight: '100vh' }}>
                    {renderView()}
                    {isSaving && (
                        <div style={{
                            position: 'fixed',
                            bottom: '20px',
                            left: '20px',
                            background: 'rgba(0,0,0,0.7)',
                            color: '#fff',
                            padding: '8px 16px',
                            borderRadius: '20px',
                            fontSize: '0.8rem',
                            zIndex: 10000,
                            backdropFilter: 'blur(5px)'
                        }}>
                            Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø­ÙØ¸...
                        </div>
                    )}
                </div>
            );
        };
        
        // ==================== RENDER APP ====================
        ReactDOM.createRoot(document.getElementById('root')).render(<App />);
    </script>
</body>
</html>